<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.153.3">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/openpgp/gnupg-cheat-sheet/">
<script defer src="/fa/js/all.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=BIZ+UDMincho:wght@400;700&family=Intel+One+Mono:wght@400;700&family=Noto+Color+Emoji&family=Noto+Sans:wght@400;700&family=Noto+Serif+Hentaigana:wght@400;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<link rel="me" href="https://fedibird.com/@spiegel">
<title>GnuPG チートシート（鍵作成から失効まで） [text.Baldanders.info]</title>
<meta property="og:title" content="GnuPG チートシート（鍵作成から失効まで）">
<meta name="description" content="GnuPG の使い方に関する「虎の巻」を作ってみることにした。">
<meta property="og:description" content="GnuPG の使い方に関する「虎の巻」を作ってみることにした。">
<meta property="og:image" content="https://text.baldanders.info/images/attention/openpgp.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@spiegel_2007">
<meta name="twitter:creator" content="@spiegel_2007">
<link rel="me" href="https://goark.fedicity.net/@spiegel">
<meta name="keywords" content="security, cryptography, tools, openpgp, gnupg">
<link rel='prev' href='https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/' title='GnuPG for Windows : gpg-agent について'>
<link rel='next' href='https://text.baldanders.info/openpgp/git-commit-with-openpgp-signature/' title='Git Commit で OpenPGP 署名を行う'>

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/openpgp/",
	"url": "https://text.baldanders.info/openpgp/",
	"inLanguage": "ja",
	"name": "OpenPGP の実装",
	"description": "OpenPGP とその実装である GnuPG 等に関する話題。",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/openpgp/gnupg-cheat-sheet/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/openpgp/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/openpgp/gnupg-cheat-sheet/",
	"url": "https://text.baldanders.info/openpgp/gnupg-cheat-sheet/",
	"mainEntityOfPage": "https://text.baldanders.info/openpgp/gnupg-cheat-sheet/",
	"inLanguage": "ja",
	"name": "GnuPG チートシート（鍵作成から失効まで）",
	"description": "GnuPG の使い方に関する「虎の巻」を作ってみることにした。",
	"headline": "GnuPG の使い方に関する「虎の巻」を作ってみることにした。",
	"keywords": "security, cryptography, tools, openpgp, gnupg",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"datePublished": "2017-12-01T08:51:18+00:00",
	"dateModified": "2022-03-27T03:30:25+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/openpgp/">OpenPGP の実装</a>
</nav>
<article>
<h1>GnuPG チートシート（鍵作成から失効まで）</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/cryptography/">cryptography</a> #<a href="/tags/gnupg/">gnupg</a> #<a href="/tags/openpgp/">openpgp</a> #<a href="/tags/security/">security</a> #<a href="/tags/tools/">tools</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fa-solid fa-share-from-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fgnupg-cheat-sheet%2f&amp;title=GnuPG%20%e3%83%81%e3%83%bc%e3%83%88%e3%82%b7%e3%83%bc%e3%83%88%ef%bc%88%e9%8d%b5%e4%bd%9c%e6%88%90%e3%81%8b%e3%82%89%e5%a4%b1%e5%8a%b9%e3%81%be%e3%81%a7%ef%bc%89" target="_blank"><span class="pocket-color"><abbr title="Share Pocket"><i class="fab fa-get-pocket" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fgnupg-cheat-sheet%2f" target="_blank"><span class="facebook-color"><abbr title="Share facebook"><i class="fab fa-square-facebook" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://x.com/intent/post?text=GnuPG%20%e3%83%81%e3%83%bc%e3%83%88%e3%82%b7%e3%83%bc%e3%83%88%ef%bc%88%e9%8d%b5%e4%bd%9c%e6%88%90%e3%81%8b%e3%82%89%e5%a4%b1%e5%8a%b9%e3%81%be%e3%81%a7%ef%bc%89+by+@spiegel_2007&amp;url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fgnupg-cheat-sheet%2f" target="_blank"><span class="x-twitter-color"><abbr title="Share Twitter"><i class="fa-brands fa-square-x-twitter" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="https://donshare.net/share.html?text=GnuPG%20%e3%83%81%e3%83%bc%e3%83%88%e3%82%b7%e3%83%bc%e3%83%88%ef%bc%88%e9%8d%b5%e4%bd%9c%e6%88%90%e3%81%8b%e3%82%89%e5%a4%b1%e5%8a%b9%e3%81%be%e3%81%a7%ef%bc%89+by+@spiegel%40goark.fedicity.net%20+https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fgnupg-cheat-sheet%2f" target="_blank"><span class="mastodon-color"><abbr title="Share Mastodon"><i class="fa-brands fa-mastodon" aria-hidden="true"></i></abbr></span></a>
	</div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/openpgp/gnupg-cheat-sheet/index.html">GitHub Page</a>
</nav>

<section>
<p>最近 <code>git commit</code> に電子署名する目的などで <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> を使う記事などをチラホラ見かけるようになったが，やっぱ使い慣れんもんは分からんよねぇ。
しかもバージョンによって微妙に挙動が異なるのが困りものである。</p>
<p>ちうわけで <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の使い方に関する簡単な「虎の巻（cheat sheet）」を作ってみることにした。
対象となる  <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> のバージョンは最新版の 2.2.x とする。</p>
<p>なお，この記事は大変長文なので，あらかじめお茶菓子などを用意した上で読みはじめることをお勧めする。
また <a href="https://zenn.dev/" title="Zenn｜プログラマーのための情報共有コミュニティ">Zenn</a> に簡易版を公開した。</p>
<ul>
<li><a href="https://zenn.dev/spiegel/articles/20200920-gnupg-cheat-sheet">GnuPG チートシート（簡易版）</a></li>
</ul>
<p>説明はいいから例示だけ見せろという方はこちらで。</p>
<p>では，ご笑覧あれ。</p>
<h2 id="toc">目次</h2>
<ol>
<li><a href="#intro">はじめに</a>
<ul>
<li><a href="#about-gpg">GnuPG とは</a></li>
<li><a href="#cmd-opt">コマンドとオプション</a></li>
</ul>
</li>
<li><a href="#create">鍵の作成</a>
<ul>
<li><a href="#generate-key"><code>--generate-key</code> コマンド</a></li>
<li><a href="#full-generate-key"><code>--full-generate-key</code> コマンド</a></li>
<li><a href="#quick-generate-key"><code>--quick-generate-key</code> コマンド</a></li>
<li><a href="#passphrase">パスフレーズ入力の回避</a></li>
<li><a href="#quick-add-key"><code>--quick-add-key</code> コマンドによる副鍵の追加</a></li>
</ul>
</li>
<li><a href="#manage">鍵の管理</a>
<ul>
<li><a href="#list-keys">鍵束内の公開鍵の検索</a></li>
<li><a href="#fingerprint">副鍵の鍵指紋の表示</a></li>
<li><a href="#change-passphrase">パスフレーズの変更</a></li>
<li><a href="#quick-set-expire">有効期限の変更</a></li>
<li><a href="#export">公開鍵をエクスポートする</a></li>
<li><a href="#import">公開鍵をインポートする</a></li>
<li><a href="#send-keys">公開鍵を鍵サーバに送信する</a></li>
<li><a href="#receive-keys">公開鍵を鍵サーバから受信する</a></li>
<li><a href="#sign-key">公開鍵に署名する</a></li>
<li><a href="#edit-key"><code>--edit-key</code> コマンド</a></li>
</ul>
</li>
<li><a href="#encrypt">データの暗号化</a>
<ul>
<li><a href="#hybrid">ハイブリッド暗号</a></li>
<li><a href="#symmetric">セッション鍵のみで暗号化する</a></li>
</ul>
</li>
<li><a href="#decrypt">暗号データの復号</a></li>
<li><a href="#sign">データへの電子署名と検証</a>
<ul>
<li><a href="#clear-sign">クリア署名</a></li>
<li><a href="#detach-sign">分離署名</a></li>
<li><a href="#data-in-sign">署名データに署名対象のデータを含める</a></li>
<li><a href="#encrypt-and-sign">暗号化と電子署名を同時に行う</a></li>
</ul>
</li>
<li><a href="#revocs">鍵を失効させる</a>
<ul>
<li><a href="#gen-revoke"><code>--generate-revocation</code> コマンド</a></li>
</ul>
</li>
</ol>
<h2 id="intro">はじめに</h2>
<h3 id="about-gpg"><a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> とは</h3>
<p><a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG (GNU Privacy Guard)</a> は <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 実装のひとつで，現在は以下の RFC に準拠している。</p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">RFC 4880 - OpenPGP Message Format</a></li>
<li><a href="https://tools.ietf.org/html/rfc5581" title="RFC 5581 - The Camellia Cipher in OpenPGP">RFC 5581 - The Camellia Cipher in OpenPGP</a></li>
<li><a href="https://tools.ietf.org/html/rfc6637" title="RFC 6637 - Elliptic Curve Cryptography (ECC) in OpenPGP">RFC 6637 - Elliptic Curve Cryptography (ECC) in OpenPGP</a></li>
</ul>
<p>また <a href="https://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">RFC 4880</a> の後継として現在ドラフト案が公開されている <a href="https://datatracker.ietf.org/doc/draft-ietf-openpgp-rfc4880bis/" title="draft-ietf-openpgp-rfc4880bis - OpenPGP Message Format">RFC 4880bis</a> の一部も取り込んでいる。
更にいうと，今回は言及しないが <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 以外にも X.509 や OpenSSH の鍵管理も可能である。</p>
<p><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の源流は Phil Zimmermann 氏によって1991年に発表された暗号ツール PGP にまで遡る。
当時の PGP の仕様は <a href="https://tools.ietf.org/html/rfc1991" title="RFC 1991 - PGP Message Exchange Formats">RFC 1991</a> として残されている。
ただ Phil Zimmermann 氏が暗号特許について迂闊だったため PGP は長く不遇な扱いを受けることになる。</p>
<p>当時の PGP の仕様を知財的に安全なものとして再構成したのが <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> である。
その実装である <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> も「自由なライセンス」のひとつである GPLv3 の下にライセンスされている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --version
</span></span><span class="line"><span class="cl">gpg (GnuPG) 2.2.24
</span></span><span class="line"><span class="cl">libgcrypt 1.8.7
</span></span><span class="line"><span class="cl">Copyright (C) 2020 g10 Code GmbH
</span></span><span class="line"><span class="cl">License GPLv3+: GNU GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;
</span></span><span class="line"><span class="cl">This is free software: you are free to change and redistribute it.
</span></span><span class="line"><span class="cl">There is NO WARRANTY, to the extent permitted by law.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Home: ********
</span></span><span class="line"><span class="cl">サポートしているアルゴリズム:
</span></span><span class="line"><span class="cl">公開鍵: RSA, ELG, DSA, ECDH, ECDSA, EDDSA
</span></span><span class="line"><span class="cl">暗号方式: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,
</span></span><span class="line"><span class="cl">    CAMELLIA128, CAMELLIA192, CAMELLIA256
</span></span><span class="line"><span class="cl">ハッシュ: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
</span></span><span class="line"><span class="cl">圧縮: 無圧縮, ZIP, ZLIB, BZIP2
</span></span></code></pre></div><p>ちなみに <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の実装としては他にも <a href="http://openpgpjs.org/" title="OpenPGP.js | OpenPGP JavaScript Implementation">OpenPGP.js</a> や <a href="https://sequoia-pgp.org/">Sequoia-PGP</a> など様々なものがある。
現在の PGP も <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 実装のひとつとして Symantec 社が<a href="https://www.symantec.com/products/encryption">販売</a>している。</p>
<h3 id="cmd-opt">コマンドとオプション</h3>
<p><a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> は基本的にコマンドラインツールだが，作りが古くて（なんせ初期の PGP の UI を引きずってるので<code>w</code>）今時あたり前な「サブコマンド」みたいな構成になっていない。
その代わりオプションの種別が「コマンド」と「オプション」に分かれている。
具体的には <code>gpg -h</code> でヘルプを見ると分かる（もちろん <code>-h</code> オプションもコマンドである）。</p>
<p>以上を踏まえて，そろそろ本題に入ろう。</p>
<h2 id="create">鍵の作成</h2>
<p>鍵の作成コマンドにはいくつか種類がある。</p>
<h3 id="generate-key">&ndash;generate-key コマンド</h3>
<p><code>--generate-key</code> コマンドは対話モードで鍵の作成を行う。
短縮名は <code>--gen-key</code>。
あんまり短縮されていないな（笑）</p>
<p>コマンド自体は初期バージョンから存在するが，バージョンによって挙動がかなり違うので要注意だ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --gen-key
</span></span><span class="line"><span class="cl">gpg (GnuPG) 2.2.19; Copyright (C) 2019 Free Software Foundation, Inc.
</span></span><span class="line"><span class="cl">This is free software: you are free to change and redistribute it.
</span></span><span class="line"><span class="cl">There is NO WARRANTY, to the extent permitted by law.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">注意: 全機能の鍵生成には &#34;gpg --full-generate-key&#34; を使います。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GnuPGはあなたの鍵を識別するためにユーザIDを構成する必要があります。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">本名: 
</span></span></code></pre></div><p>最新版 2.2.x では暗号アルゴリズムは RSA 3072bit，有効期限は作成日当日で固定されている。
したがって，ユーザが入力するのはユーザID（本名，電子メール・アドレス）とパスフレーズのみとなる（パスフレーズ入力時には Pinentry が起動する）。</p>
<p><code>--generate-key</code> コマンドについては，以下のような設定ファイルを作って <code>--batch</code> オプションを付けて起動することで対話モードを回避し，かつアルゴリズム等の詳細な指定をすることもできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ cat alice-key.conf
</span></span><span class="line"><span class="cl">Key-Type: RSA
</span></span><span class="line"><span class="cl">Key-Length: 3072
</span></span><span class="line"><span class="cl">Key-Usage: sign,cert
</span></span><span class="line"><span class="cl">Subkey-Type: RSA
</span></span><span class="line"><span class="cl">Subkey-Length: 3072
</span></span><span class="line"><span class="cl">Subkey-Usage: encrypt
</span></span><span class="line"><span class="cl">Name-Real: Alice
</span></span><span class="line"><span class="cl">Name-Email: alice@example.com
</span></span><span class="line"><span class="cl">Expire-Date: 0
</span></span><span class="line"><span class="cl">Passphrase: passwd
</span></span><span class="line"><span class="cl">%commit
</span></span><span class="line"><span class="cl">%echo done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --gen-key --batch alice-key.conf
</span></span><span class="line"><span class="cl">gpg: 鍵AEE3D12F6D2F7F92を究極的に信用するよう記録しました
</span></span><span class="line"><span class="cl">gpg: 失効証明書を &#39;/home/username/.gnupg/openpgp-revocs.d/0F99F15C200B30194855B93AAEE3D12F6D2F7F92.rev&#39; に保管しました。
</span></span><span class="line"><span class="cl">gpg: done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   rsa3072 2020-06-27 [SC]
</span></span><span class="line"><span class="cl">      0F99F15C200B30194855B93AAEE3D12F6D2F7F92
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa3072 2020-06-27 [E]
</span></span></code></pre></div><p>設定ファイルの書き方は &ldquo;<a href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html" title="Using the GNU Privacy Guard: Unattended GPG key generation">Unattended GPG key generation</a>” を参照のこと。
いったん設定ファイルを作ってしまえばこの方法が一番簡単かな。</p>
<p>なお <code>Passphrase</code> の項目を削除すれば <code>--batch</code> モードでも Pinentry で設定するパスフレーズを訊いてくるので「設定ファイルにパスフレーズを書くのは&hellip;」という方も安心である。</p>
<h3 id="full-generate-key">&ndash;full-generate-key コマンド</h3>
<p>対話モードで暗号アルゴリズムや鍵長を指定したい場合は <code>--full-generate-key</code> コマンドを使う。
短縮名は <code>--full-gen-key</code>。</p>
<p>具体的にはこんな感じで進行する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --full-gen-key
</span></span><span class="line"><span class="cl">gpg (GnuPG) 2.2.19; Copyright (C) 2019 Free Software Foundation, Inc.
</span></span><span class="line"><span class="cl">This is free software: you are free to change and redistribute it.
</span></span><span class="line"><span class="cl">There is NO WARRANTY, to the extent permitted by law.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ご希望の鍵の種類を選択してください:
</span></span><span class="line"><span class="cl">   (1) RSA と RSA (デフォルト)
</span></span><span class="line"><span class="cl">   (2) DSA と Elgamal
</span></span><span class="line"><span class="cl">   (3) DSA (署名のみ)
</span></span><span class="line"><span class="cl">   (4) RSA (署名のみ)
</span></span><span class="line"><span class="cl">  (14) カードに存在する鍵
</span></span><span class="line"><span class="cl">あなたの選択は? 2
</span></span><span class="line"><span class="cl">DSA 鍵は 1024 から 3072 ビットの長さで可能です。
</span></span><span class="line"><span class="cl">鍵長は? (2048) 3072
</span></span><span class="line"><span class="cl">要求された鍵長は3072ビット
</span></span><span class="line"><span class="cl">鍵の有効期限を指定してください。
</span></span><span class="line"><span class="cl">         0 = 鍵は無期限
</span></span><span class="line"><span class="cl">      &lt;n&gt;  = 鍵は n 日間で期限切れ
</span></span><span class="line"><span class="cl">      &lt;n&gt;w = 鍵は n 週間で期限切れ
</span></span><span class="line"><span class="cl">      &lt;n&gt;m = 鍵は n か月間で期限切れ
</span></span><span class="line"><span class="cl">      &lt;n&gt;y = 鍵は n 年間で期限切れ
</span></span><span class="line"><span class="cl">鍵の有効期間は? (0) 1y
</span></span><span class="line"><span class="cl">鍵は2021年06月27日 09時18分48秒 JSTで期限切れとなります
</span></span><span class="line"><span class="cl">これで正しいですか? (y/N) 
</span></span></code></pre></div><p><code>--expert</code> オプションを付けると選択可能なアルゴリズムの組み合わせが増える。
こんな感じ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --full-gen-key --expert
</span></span><span class="line"><span class="cl">gpg (GnuPG) 2.2.19; Copyright (C) 2019 Free Software Foundation, Inc.
</span></span><span class="line"><span class="cl">This is free software: you are free to change and redistribute it.
</span></span><span class="line"><span class="cl">There is NO WARRANTY, to the extent permitted by law.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ご希望の鍵の種類を選択してください:
</span></span><span class="line"><span class="cl">   (1) RSA と RSA (デフォルト)
</span></span><span class="line"><span class="cl">   (2) DSA と Elgamal
</span></span><span class="line"><span class="cl">   (3) DSA (署名のみ)
</span></span><span class="line"><span class="cl">   (4) RSA (署名のみ)
</span></span><span class="line"><span class="cl">   (7) DSA (機能をあなた自身で設定)
</span></span><span class="line"><span class="cl">   (8) RSA (機能をあなた自身で設定)
</span></span><span class="line"><span class="cl">   (9) ECC と ECC
</span></span><span class="line"><span class="cl">  (10) ECC (署名のみ)
</span></span><span class="line"><span class="cl">  (11) ECC (機能をあなた自身で設定)
</span></span><span class="line"><span class="cl">  (13) 既存の鍵
</span></span><span class="line"><span class="cl">  (14) カードに存在する鍵
</span></span><span class="line"><span class="cl">あなたの選択は? 
</span></span></code></pre></div><p>ECC (Elliptic Curve Cryptography; 楕円曲線暗号) 鍵の取り扱いについては以下の記事を参照のこと。</p>
<ul>
<li><a href="https://text.baldanders.info/openpgp/using-ecc-with-gnupg/">そろそろ GnuPG でも ECC を標準で使うのがいいんじゃないかな</a></li>
</ul>
<h3 id="quick-generate-key">&ndash;quick-generate-key コマンド</h3>
<p>コマンドライン一発で鍵を作成したい場合は <code>--quick-generate-key</code> コマンドでユーザID，アルゴリズム，有効期限を指定できる。
短縮名は <code>--quick-gen-key</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Usage: gpg [options] --quick-generate-key user-id [algo [usage [expire]]]
</span></span></code></pre></div><p><code>algo</code> にはアルゴリズムと鍵長を文字列で指定する。
指定可能な文字列は以下の通り。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">公開鍵暗号アルゴリズム</th>
          <th style="text-align: left">名前</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">RSA</td>
          <td style="text-align: left"><code>default</code> (= <code>rsa3071</code>)</td>
      </tr>
      <tr>
          <td style="text-align: left">RSA (署名鍵のみ)</td>
          <td style="text-align: left"><code>rsa</code> (= <code>rsa3071</code>), <code>rsa1024</code>, <code>rsa2048</code>, <code>rsa3071</code>, <code>rsa4096</code></td>
      </tr>
      <tr>
          <td style="text-align: left">DSA (署名鍵のみ)</td>
          <td style="text-align: left"><code>dsa</code> (= <code>dsa3072</code>), <code>dsa1024</code>, <code>dsa2048</code>, <code>dsa3072</code></td>
      </tr>
      <tr>
          <td style="text-align: left">ECDH/EdDSA</td>
          <td style="text-align: left"><code>future-default</code> (= <code>cv25519</code>/<code>ed25519</code>)</td>
      </tr>
      <tr>
          <td style="text-align: left">EdDSA (署名鍵のみ)</td>
          <td style="text-align: left"><code>ed25519</code></td>
      </tr>
      <tr>
          <td style="text-align: left">ECDSA (署名鍵のみ)</td>
          <td style="text-align: left"><code>nistp256</code>, <code>nistp384</code>, <code>nistp521</code>, <code>brainpoolP256r1</code>, <code>brainpoolP384r1</code>, <code>brainpoolP512r1</code>, <code>secp256k1</code></td>
      </tr>
  </tbody>
</table>
<p><code>usage</code> には主鍵の機能を文字列で指定する。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">機能</th>
          <th style="text-align: left">名前</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">署名</td>
          <td style="text-align: left"><code>sign</code></td>
      </tr>
      <tr>
          <td style="text-align: left">証明</td>
          <td style="text-align: left"><code>cert</code></td>
      </tr>
      <tr>
          <td style="text-align: left">認証</td>
          <td style="text-align: left"><code>auth</code></td>
      </tr>
      <tr>
          <td style="text-align: left">暗号化</td>
          <td style="text-align: left"><code>encr</code></td>
      </tr>
  </tbody>
</table>
<p>主鍵には自動的に <code>cert</code> が付与されるため暗号化機能しかないアルゴリズム（ElGamal や ECDH）を主鍵に使うことはできない。
また暗号アルゴリズムと機能がマッチしない場合はエラーになる（電子署名用のアルゴリズムなのに <code>encr</code> を指定するなど）。</p>
<p>目的が複数ある場合はカンマで区切って列挙する。
なお <code>default</code> または <code>-</code> を指定すれば <code>sign</code>+<code>cert</code> となるので，通常は <code>default</code> のままでよい。</p>
<p><code>expire</code> には有効期限を指定する。
1週間なら <code>7d</code> または <code>1w</code>，1年なら <code>12m</code> または <code>1y</code> といった感じ。
<code>0</code> を指定すると無期限になる。
省略すると作成日当日が有効期限となる。</p>
<p><code> --quick-generate-key</code> コマンドの実行例はこんな感じ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">gpg --quick-gen-key &#34;Alice &lt;alice@example.com&gt;&#34; default default 0
</span></span><span class="line"><span class="cl">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
</span></span><span class="line"><span class="cl">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
</span></span><span class="line"><span class="cl">成器に十分なエントロピーを供給する機会を与えることができます。
</span></span><span class="line"><span class="cl">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
</span></span><span class="line"><span class="cl">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
</span></span><span class="line"><span class="cl">成器に十分なエントロピーを供給する機会を与えることができます。
</span></span><span class="line"><span class="cl">gpg: 鍵732A737992A2A7A5を究極的に信用するよう記録しました
</span></span><span class="line"><span class="cl">gpg: 失効証明書を &#39;/home/username/.gnupg/openpgp-revocs.d/F3546931BCBECA3D73E5E60E732A737992A2A7A5.rev&#39; に保管しました。
</span></span><span class="line"><span class="cl">公開鍵と秘密鍵を作成し、署名しました。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa3072 2020-06-27 [SC]
</span></span><span class="line"><span class="cl">     F3546931BCBECA3D73E5E60E732A737992A2A7A5
</span></span><span class="line"><span class="cl">uid                      Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa3072 2020-06-27 [E]
</span></span></code></pre></div><h3 id="passphrase">パスフレーズ入力の回避</h3>
<p><code>--quick-generate-key</code> コマンドでもパスフレーズの入力は Pinentry から行うことになるが <code>--pinentry-mode</code> オプションおよび <code>--passphrase</code> オプションを付加することで回避できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --pinentry-mode loopback --passphrase passwd --quick-gen-key &#34;Alice &lt;alice@example.com&gt;&#34; default default 0
</span></span></code></pre></div><p>ただしコマンドラインの履歴に入力したパスフレーズが残ってしまうのであまりお勧めできないが&hellip;</p>
<h3 id="quick-add-key">&ndash;quick-add-key コマンドによる副鍵の追加</h3>
<p>作成した鍵に <code>--quick-add-key</code> コマンドで後から暗号鍵を追加できる。
これは <code> --quick-generate-key</code> コマンドで主鍵のみ作って後から副鍵を加えたい場合などに有効である。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Usage: gpg [options] --quick-add-key key-fingerprint [algo [usage [expire]]]
</span></span></code></pre></div><p>たとえば，以下の鍵に対して</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span></code></pre></div><p>以下のように暗号鍵を副鍵として追加できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --quick-add-key B8AF88FC3448859FCF65810C20EDB41D5093CA8A elg3072 encr
</span></span><span class="line"><span class="cl">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
</span></span><span class="line"><span class="cl">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
</span></span><span class="line"><span class="cl">成器に十分なエントロピーを供給する機会を与えることができます。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E]
</span></span></code></pre></div><p>ちなみに <code>B8AF88FC3448859FCF65810C20EDB41D5093CA8A</code> という長ったらしい数字列は鍵指紋（key fingerprint）である。
<a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> では鍵指紋をそのまま（または下位バイトを）鍵IDとして使っている。</p>
<p>副鍵では機能として <code>cert</code> は指定できない。
また暗号アルゴリズムと機能がマッチしない場合はエラーになる。
ただし <code>default</code> または <code>-</code> を指定すればアルゴリズムに合わせた適切な機能をセットしてくれるみたいなので，大抵の場合は <code>default</code> でいいだろう。</p>
<p>暗号化用に使用できるアルゴリズムは以下の通り。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">公開鍵暗号アルゴリズム</th>
          <th style="text-align: left">名前</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">RSA</td>
          <td style="text-align: left"><code>default</code> (= <code>rsa2048</code>), <code>rsa</code> (= <code>rsa2048</code>), <code>rsa1024</code>, <code>rsa2048</code>, <code>rsa3071</code>, <code>rsa4096</code></td>
      </tr>
      <tr>
          <td style="text-align: left">ElGamal</td>
          <td style="text-align: left"><code>elg</code> (= <code>elg2048</code>), <code>elg1024</code>, <code>elg2048</code>, <code>elg3072</code></td>
      </tr>
      <tr>
          <td style="text-align: left">ECDH</td>
          <td style="text-align: left"><code>cv25519</code>, <code>nistp256</code>, <code>nistp384</code>, <code>nistp521</code>, <code>brainpoolP256r1</code>, <code>brainpoolP384r1</code>, <code>brainpoolP512r1</code>, <code>secp256k1</code></td>
      </tr>
  </tbody>
</table>
<p>電子署名用のアルゴリズムも（署名用の副鍵として指定すれば）もちろん使える。</p>
<h2 id="manage">鍵の管理</h2>
<p>作成した鍵や配布・受領した公開鍵を管理するためのコマンドを紹介する。</p>
<h3 id="list-keys">鍵束内の公開鍵の検索</h3>
<p>鍵束内の公開鍵を検索する場合， <code>--list-keys</code> コマンドの引数にユーザID（の一部）または鍵IDを指定することで，条件にマッチする鍵を検索できる。
短縮名は <code>-k</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -k alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E]
</span></span></code></pre></div><p>ちなみに <code>[SC]</code> や <code>[E]</code> は鍵の機能を示していて， <code>C</code> は証明， <code>S</code> は署名， <code>E</code> は暗号化を指す。</p>
<p>引数なしで <code>--list-keys</code> コマンドを起動した場合は公開鍵の鍵束（<code>pubring.kbx</code>）にある鍵が全て列挙される。</p>
<p>秘密鍵を検索する場合には <code>--list-secret-keys</code> コマンドを使う。
短縮名は大文字の <code>-K</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -K alice
</span></span><span class="line"><span class="cl">sec   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">ssb   elg3072 2020-06-27 [E]
</span></span></code></pre></div><h3 id="fingerprint">副鍵の鍵指紋の表示</h3>
<p><code>--list-keys</code> コマンドでも主鍵の鍵指紋が表示されるが，副鍵の鍵指紋も表示したい場合は <code>--fingerprint</code> コマンドを2つ重ねる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --fingerprint --fingerprint alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF 88FC 3448 859F CF65  810C 20ED B41D 5093 CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E]
</span></span><span class="line"><span class="cl">      7BB9 F625 7053 4A0F B297  ECA6 7792 0F61 EFE7 15CC
</span></span></code></pre></div><h3 id="change-passphrase">パスフレーズの変更</h3>
<p>秘密鍵のパスフレーズを変更する場合には <code>--change-passphrase</code> コマンドを使う。
短縮名は <code>--passwd</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --passwd alice
</span></span></code></pre></div><p>引数にはユーザID（の一部）を指定できる。
パスワードの入力は Pinentry で行う。</p>
<h3 id="quick-set-expire">有効期限の変更</h3>
<p>自身の鍵の有効期限を変更する場合には <code>--quick-set-expire</code> コマンドを使う。</p>
<p>鍵の鍵指紋がが以下の場合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --fingerprint --fingerprint alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF 88FC 3448 859F CF65  810C 20ED B41D 5093 CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E]
</span></span><span class="line"><span class="cl">      7BB9 F625 7053 4A0F B297  ECA6 7792 0F61 EFE7 15CC
</span></span></code></pre></div><p>有効期限を2年（<code>2y</code>）に指定するなら，操作は以下の通り。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --quick-set-expire B8AF88FC3448859FCF65810C20EDB41D5093CA8A 2y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2022-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --quick-set-expire B8AF88FC3448859FCF65810C20EDB41D5093CA8A 2y 7BB9F62570534A0FB297ECA677920F61EFE715CC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [有効期限: 2022-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   elg3072 2020-06-27 [E] [有効期限: 2022-06-27]
</span></span></code></pre></div><p>前半は主鍵，後半は（主鍵に紐づく）副鍵の有効期限を変更している。
このことから分かるとおり，主鍵と副鍵は個別に有効期限を設定することが可能である。</p>
<h3 id="export">公開鍵をエクスポートする</h3>
<p>公開鍵のエクスポートには <code>--export</code> コマンドを使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --armor --export alice
</span></span><span class="line"><span class="cl">-----BEGIN PGP PUBLIC KEY BLOCK-----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mQSuBF72kuQRDACZP74/nEeuqefETXiHvKSEy6gQoQex+P8Cn+b020hC0ud3NWzU
</span></span><span class="line"><span class="cl">U06N9YccHqCQXqnKRCXYXauDnizYq2W1ZbpY+QpS2DSKqLkAMleEIA9UN3PwCgoJ
</span></span><span class="line"><span class="cl">K6nTDaf5xIWP44GbyZTZqSHrz4ab8ycFqJBsUFUrrVSSJ/nYAHKsWlJ7ZQgX3mye
</span></span><span class="line"><span class="cl">qCu3kveRB88XDI1UK2QzdDuqSw1UDDeXv0/ZFCu42WmW7T3hJ5l/6F2oJ3VVVGEz
</span></span><span class="line"><span class="cl">HoFSKhKvddV1ZuhJmFRa8pYj2jLnxDfkyyqzqkwSfC1vMTa2yv3HGcGXWcpLVoJ9
</span></span><span class="line"><span class="cl">REu0K/FNIEJUJdlfmtnmqo4od7cS9dlhHUYnDbzSqpQlPx8GtrFCweBr5ZYlFKU2
</span></span><span class="line"><span class="cl">KWEshnJrd8dw2AL1evQirvsmnBMNIWZZ4vD92OcY+zFDvSD1zoQ6O7u+vB30pupd
</span></span><span class="line"><span class="cl">twF5tBScFfRRhUmdxYOzNF9RBD0PcKHNh4YYuKhibYperuTw6kJog3hxc89OUTdy
</span></span><span class="line"><span class="cl">uRbj/czJzKXDL6sBAPSG/9VWdj0vm36/6NDl/kBPiHbmOCYeSy2UEyCCzXRtDACE
</span></span><span class="line"><span class="cl">IbLo8qtIlxzoQW1LRbqZyiy5n7tFSqnPhAQLx3IfH79e3lhiIerZdvoVKapYn0Wf
</span></span><span class="line"><span class="cl">ZzzJt1xzalZ7VBGXbVRFbg2Ht8/81di8ifsSMBwWRDqy9lb7SShIMUv6Uraahwd7
</span></span><span class="line"><span class="cl">xcUcljkTMLj3FNgmzariZK5SNkPEYqffU+dNvPB2V2s5A7+H+JwpzJdO7Ot3W8Ck
</span></span><span class="line"><span class="cl">fJo2jkNjnpJGW1NQsSf6Hh3xWIQUHUui/mojkLujo5Ajlcv/0qa7wfu3GbZ1ueAU
</span></span><span class="line"><span class="cl">9ko8xH1CL8cQLEbXyb/jnWwYkgs6R05wAXCmxBVZz/OgG+r0fyYClSXnFtjQMiSh
</span></span><span class="line"><span class="cl">9774gdaZOAaZ/av8ZdPL274xF6Iz8ek0qh1nVJSi16BXL6WnsfMpUB28waCG0nc7
</span></span><span class="line"><span class="cl">JaVS6o17cas1/DuY1KOLZsV7HF4W5sBAQ/GWTsmNbv68jWSlIHGiTSu/uu+br5pm
</span></span><span class="line"><span class="cl">apszZIAtRtnZjEeaoJqGPMDxrOLxCH2BWGZ0OTdCEnYcRDO3tIpMIFqp6q2H7jsL
</span></span><span class="line"><span class="cl">/j1pQ5JEJu1jHvOFvAtRtNtoIAU+kPXIvJ+PYwaU+4TFf7oYVOH0lrSOnrTaj4nK
</span></span><span class="line"><span class="cl">KnGKgfDt3bRVBqBjKA83g3d467GnI2nqtW0Xa3W6UH5QP0JYFGAheaUpuA6RS/Oc
</span></span><span class="line"><span class="cl">GQfFqjyVEwllcNwFA0b7Wo6nOV8qlpwj+e1sknzeEqFfKaYIoueXMCLHARtBVW3h
</span></span><span class="line"><span class="cl">pJlmqveefe7diwUZNOP4U/atOAhgrY7T9onxKC9E1JuLjF5V3oAo2OQMO93dCfCH
</span></span><span class="line"><span class="cl">6Q4HQXjdOW1Iq9LPB4R0zK+QZqkGZ4HK+ok/85YlnyeGsWgBHCD+N5QafL4gfOnK
</span></span><span class="line"><span class="cl">b5Nt7P8DPahkq8ZnBLfBjj5xMFWQyNdohZN/h3ommDVQDJQUuXdYc3UwKus9RShv
</span></span><span class="line"><span class="cl">ucVZNP+c0oFP5lcym9Z5aO+jZbAMtPlr3gMogptA08qHus0rEEwfJhab7ndO99We
</span></span><span class="line"><span class="cl">QXbq9MHW3Vsl2rdwvV/jskGSdisuevfYe8PAvfzr+P3yN3uihRPmrLU6cU6CpMsj
</span></span><span class="line"><span class="cl">mbQZQWxpY2UgPGFsaWNlQGV4YW1wbGUuY29tPoiWBBMRCAA+AhsDBQsJCAcCBhUK
</span></span><span class="line"><span class="cl">CQgLAgQWAgMBAh4BAheAFiEEuK+I/DRIhZ/PZYEMIO20HVCTyooFAl72lHgFCQPC
</span></span><span class="line"><span class="cl">aJQACgkQIO20HVCTyopjMAD/eIvKjo28WzvRN399b13i84IrU+6p/APtvahI4W4C
</span></span><span class="line"><span class="cl">qpEBAMC7lWTNcJZ7Q+WQP9aHtkbY7vj6MVrdHw3ntxRMf/OEuQMNBF72kx8QDACo
</span></span><span class="line"><span class="cl">hgxn/tfJ20ge4i4kBo9OD8wciOKfze6nvuEofMSpje/rq5kWd4CMadYl0Hj0Bv9K
</span></span><span class="line"><span class="cl">a7lihuu4nMH3GbFbIFj+D3wjoKGqf0ZFEssnbRGdYJNTWuY4qujtOwFLIvJsqn33
</span></span><span class="line"><span class="cl">zcJxFQDJJ6RmaBTw+avaNsYOMm57k8KOwFwIzkjLcSj2+ieSHW66ELZ643wr229f
</span></span><span class="line"><span class="cl">HJ2qN7RqqIx/LIN9PHaxap+e4InC/rF72NrB58ijToRMA31087ppJGV1Q7yfSoM8
</span></span><span class="line"><span class="cl">c8Mt3D5NZ0y3VQLN0H8cqWV5gQzlwXxVU3vhE6z6/toTWIwyEpSNcy4JcItgS7Ql
</span></span><span class="line"><span class="cl">gtwusCobcigNxseYC2hU0Y0Pqt7bggKLfHgVJO4oZW3v4tfQ9Y8iquP95SxJQi3C
</span></span><span class="line"><span class="cl">wyIFf3BdMMlY4x61k8++71STvnrtcbz8IMhA0fyQRyAmcs7CUpQ6l5mfEzEC2f+9
</span></span><span class="line"><span class="cl">7bWwjedW2pL2EIoTIlOBALFF0RatEneTriTc1UEu/7MYhzPjyKoNOEpl+iPwsPcA
</span></span><span class="line"><span class="cl">AwcL/jYaJX3gwpfS1gqiZdkZVyKbQw1Do5d28yJiZjoYRFDq4QCm2FD5DfwdRQTc
</span></span><span class="line"><span class="cl">YTeYvaYnp9hyG6YkcDLlVWio/3e3+F3ztfdw6nkiDJ3pp4gsPx5BtiswBEf94hFx
</span></span><span class="line"><span class="cl">ayITnDFC9m+qHtq4O58Ae6bONLULNgfWQlyL3hnx2dgXMAWXx5PMBPTVFc5s1uUU
</span></span><span class="line"><span class="cl">ajO95nqpKGYlRoNyaREL/XgHV2adttpAjwFhtyxoRq3t+vX75MrwUKFBRalgkI6s
</span></span><span class="line"><span class="cl">AI3ZF5RUto6wRJQbdqnVgtpHwvenvQu09JB98uK2KSRHeHeYkK1TRbic6RiA5QZj
</span></span><span class="line"><span class="cl">szXCdbBQ/uDcOtXQvH1go+XfAum/u7eReTmFRxTfnbSm5Y8cxkpwHcxKGNKoIalT
</span></span><span class="line"><span class="cl">aGn21l7MSSkMPMujohmE1+rbeXXXrJhYah/cRyVmqcUPYMk5L01GUMWKAImCezfF
</span></span><span class="line"><span class="cl">Lbn8GrUdEJ09c4v75LJdTCTHzgs3YvQe55onMK1odNDexQ5uBjAndtAaN50vDbMM
</span></span><span class="line"><span class="cl">DIesw4h+BBgRCAAmAhsMFiEEuK+I/DRIhZ/PZYEMIO20HVCTyooFAl72lMEFCQPC
</span></span><span class="line"><span class="cl">aKIACgkQIO20HVCTyop2igD+MCsYVKUGqhrt/ZSsUaYASM8U82pa8R8xcBFwIHd/
</span></span><span class="line"><span class="cl">hRUBAN2DX9SwQ7Dwr3pJbaUmuaeOwfotRWRf1CxSvGnojEI5
</span></span><span class="line"><span class="cl">=nDyQ
</span></span><span class="line"><span class="cl">-----END PGP PUBLIC KEY BLOCK-----
</span></span></code></pre></div><p><code>--armor</code> オプションを指定すると，上記のように， ASCII Armor 形式のテキストを出力する。
短縮名は <code>-a</code>。
<code>--armor</code> オプションを付けないとバイナリを吐く。</p>
<p>秘密鍵をエクスポートする場合は <code>--export-secret-key</code> コマンドを使う（パスフレーズ入力あり）。</p>
<p>公開鍵をファイル等で配布する場合は <code>--export</code> コマンドの出力をファイルにリダイレクトすればよい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -a --export alice &gt; alice-key.asc
</span></span></code></pre></div><p>ASCII Armor 形式のテキスト・ファイルの拡張子は慣習的に <code>.asc</code> とすることが多い。</p>
<h3 id="import">公開鍵をインポートする</h3>
<p>公開鍵のインポートには <code>--import</code> コマンドを使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --import alice-key.asc
</span></span></code></pre></div><p>インポートではパイプが使えるので</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">cat alice-key.asc | gpg --import
</span></span></code></pre></div><p>などとできる。
また Web ページ上に公開鍵のファイルを置いている場合は <code>--fetch-keys</code> コマンドで直接インポートすることもできる。
以下は <a href="https://www.jpcert.or.jp/jpcert-pgp.html" title="JPCERT コーディネーションセンター PGP公開鍵">JPCERT/CC の公開鍵</a>をサイトからインポートしたところ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --fetch-keys https://www.jpcert.or.jp/keys/info-0x69ECE048.asc
</span></span></code></pre></div><p>インポートする鍵が既に鍵束にある場合でも，単純な上書きではなく， <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> がいい感じにマージしてくれるのでご安心を。</p>
<h3 id="send-keys">公開鍵を鍵サーバに送信する</h3>
<p>鍵束にある公開鍵を鍵サーバに送信するには <code>--send-keys</code> コマンドを使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --keyserver keys.gnupg.net --send-keys 69ECE048
</span></span></code></pre></div><p>鍵の指定には鍵Dを使う。</p>
<p>上記のように <code>--keyserver</code> オプションで鍵サーバを指定する。
または鍵束フォルダにある <code>gpg.conf</code> ファイルに既定の鍵サーバを指定できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">keyserver  keys.gnupg.net
</span></span></code></pre></div><p>鍵サーバは，基本的には互いに同期しているので，どのサーバを指定してもいいのだが，有名なところでは</p>
<ul>
<li><a href="http://keys.gnupg.net/" title="Nebraska Wesleyan University - OpenPGP Keyserver">keys.gnupg.net</a></li>
<li><a href="https://pgp.mit.edu/" title="MIT PGP Key Server">pgp.mit.edu</a></li>
<li><a href="http://pgp.nic.ad.jp/" title="PGP KEYSERVER">pgp.nic.ad.jp</a></li>
</ul>
<p>あたりだろうか。</p>
<h3 id="receive-keys">公開鍵を鍵サーバから受信する</h3>
<p>鍵サーバから公開鍵を受信する場合は <code>--receive-keys</code> コマンドを使う。
短縮名は <code>--recv-keys</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --keyserver keys.gnupg.net --recv-keys 69ECE048
</span></span></code></pre></div><p>送信のときと同じく，こちらも鍵の指定には鍵Dを使う。
あらかじめ鍵IDがわからない場合は <code>--search-keys</code> コマンドで検索できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --keyserver keys.gnupg.net --search-keys alice@example.com
</span></span><span class="line"><span class="cl">(1)     by Teemob &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">        by Teemob &lt;lockstar2017@gmail.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 966893ECDA2FD3EC, 作成: 2017-11-15
</span></span><span class="line"><span class="cl">(2)     Alice (Alice&#39;s key) &lt;Alice@example.com&gt;
</span></span><span class="line"><span class="cl">          1024 bit DSA key A251C75C6213F841, 作成: 2017-11-12, 有効期限: 2018-11-12
</span></span><span class="line"><span class="cl">(3)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 8EDAABFF277776F3, 作成: 2017-11-03
</span></span><span class="line"><span class="cl">(4)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 37FC4F26B92A3964, 作成: 2017-10-18
</span></span><span class="line"><span class="cl">(5)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 09AB44CAA589D7A2, 作成: 2017-10-04
</span></span><span class="line"><span class="cl">(6)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key D3205D5A68E02E2B, 作成: 2017-10-04
</span></span><span class="line"><span class="cl">(7)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          2048 bit RSA key 29FD3D6668D47FA1, 作成: 2017-09-14
</span></span><span class="line"><span class="cl">(8)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 25B9727BCE238CDE, 作成: 2017-08-10
</span></span><span class="line"><span class="cl">(9)     Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key 2604F9169E9C4E37, 作成: 2017-08-05 (失効)
</span></span><span class="line"><span class="cl">(10)    Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">          3072 bit RSA key B2251B1A2B632A2E, 作成: 2017-07-17
</span></span><span class="line"><span class="cl">(11)    Alice &lt;alice-example-187723@mailismagic.com&gt;
</span></span><span class="line"><span class="cl">          2048 bit RSA key FF99048E395DC7E7, 作成: 2017-04-20, 有効期限: 2019-04-20
</span></span><span class="line"><span class="cl">Keys 1-11 of 103 for &#34;alice@example.com&#34;.  番号(s)、N)次、またはQ)中止を入力してください &gt;
</span></span></code></pre></div><p>検索結果に対して番号を指定すればそのままインポートしてくれる。</p>
<h3 id="sign-key">公開鍵に署名する</h3>
<p>インポートした公開鍵が有効であることを確認したら，公開鍵に電子署名して有効化しよう。</p>
<p>ただし，近年では第三者による野良署名は推奨されない傾向にある<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。
また鍵サーバによっては自己署名以外の電子署名をドロップする場合もあるようだ。</p>
<p>そこで公開鍵への電子署名には <code>--lsign-key</code> または <code>--quick-lsign-key</code> コマンドを使ったローカル署名を推奨する。
ローカル署名はエクスポート（または鍵サーバへの送信）時にドロップされる。</p>
<p>公開鍵への電子署名には <code>--sign-key</code> コマンドまたは <code>--quick-sign-key</code> コマンドを使う。</p>
<p><code>--lsign-key</code> コマンドは対話モードで複数の鍵にひとつずつ署名することができる。
<code>--quick-lsign-key</code> コマンドは鍵指紋を指定して一気に処理を行う。
署名時にパスフレーズ入力を求められる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">gpg --quick-lsign-key 1B5202DB4A3EC776F1E0AD18B4DA3BAE7E20B81C
</span></span></code></pre></div><p>電子署名が可能な秘密鍵を複数所持している場合は <code>--local-user</code> オプションで電子署名に使う鍵を指定する。
短縮名は <code>-u</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">gpg -u alice --quick-lsign-key 1B5202DB4A3EC776F1E0AD18B4DA3BAE7E20B81C
</span></span></code></pre></div><p>または電子署名に使う鍵を鍵束フォルダにある <code>gpg.conf</code> ファイルで指定することもできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">default-key alice
</span></span></code></pre></div><p>なお，電子署名を含めて配布したい場合は <code>--sign-key</code> または <code>--quick-sign-key</code> コマンドを使う（チーム運営などで相互署名したい<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> ときなど）。</p>
<h3 id="edit-key">&ndash;edit-key コマンド</h3>
<p><code>--edit-key</code> コマンドは対話モードで鍵の編集を行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --edit-key alice
</span></span></code></pre></div><p>対話モードに入るとプロンプトが <code>gpg&gt;</code> に変わる。
対話モードで使えるコマンドは以下の通り。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">gpg&gt; help
</span></span><span class="line"><span class="cl">quit        このメニューを終了
</span></span><span class="line"><span class="cl">save        保存して終了
</span></span><span class="line"><span class="cl">help        このヘルプを表示
</span></span><span class="line"><span class="cl">fpr         鍵のフィンガープリントを表示
</span></span><span class="line"><span class="cl">grip        keygripを表示
</span></span><span class="line"><span class="cl">list        鍵とユーザIDの一覧
</span></span><span class="line"><span class="cl">uid         ユーザID Nの選択
</span></span><span class="line"><span class="cl">key         副鍵Nの選択
</span></span><span class="line"><span class="cl">check       署名の確認
</span></span><span class="line"><span class="cl">sign        選択したユーザIDに署名する [* 以下の関連コマンドを参照 ]
</span></span><span class="line"><span class="cl">lsign       選択したユーザIDにローカルに署名
</span></span><span class="line"><span class="cl">tsign       選択したユーザIDに信用署名を署名する
</span></span><span class="line"><span class="cl">nrsign      選択したユーザIDに失効不可の署名をする
</span></span><span class="line"><span class="cl">adduid      ユーザIDの追加
</span></span><span class="line"><span class="cl">addphoto    フォトIDの追加
</span></span><span class="line"><span class="cl">deluid      選択したユーザIDの削除
</span></span><span class="line"><span class="cl">addkey      副鍵を追加
</span></span><span class="line"><span class="cl">addcardkey  スマートカードへ鍵の追加
</span></span><span class="line"><span class="cl">keytocard   鍵をスマートカードへ移動
</span></span><span class="line"><span class="cl">bkuptocard  バックアップ鍵をスマートカードへ移動
</span></span><span class="line"><span class="cl">delkey      選択した副鍵の削除
</span></span><span class="line"><span class="cl">addrevoker  失効鍵の追加
</span></span><span class="line"><span class="cl">delsig      選択したユーザIDから署名を削除する
</span></span><span class="line"><span class="cl">expire      鍵または選択した副鍵の有効期限を変更する
</span></span><span class="line"><span class="cl">primary     選択したユーザIDを主にする
</span></span><span class="line"><span class="cl">pref        優先指定の一覧 (エキスパート)
</span></span><span class="line"><span class="cl">showpref    優先指定の一覧 (冗長)
</span></span><span class="line"><span class="cl">setpref     選択したユーザIDに優先指定リストを設定
</span></span><span class="line"><span class="cl">keyserver   選択したユーザIDに優先鍵サーバのURLを設定
</span></span><span class="line"><span class="cl">notation    選択したユーザIDに注釈を設定する
</span></span><span class="line"><span class="cl">passwd      パスフレーズの変更
</span></span><span class="line"><span class="cl">trust       所有者信用の変更
</span></span><span class="line"><span class="cl">revsig      選択したユーザIDの署名を失効
</span></span><span class="line"><span class="cl">revuid      選択したユーザIDの失効
</span></span><span class="line"><span class="cl">revkey      鍵の失効または選択した副鍵の失効
</span></span><span class="line"><span class="cl">enable      鍵を有効にする
</span></span><span class="line"><span class="cl">disable     鍵を無効にする
</span></span><span class="line"><span class="cl">showphoto   選択したフォトIDを表示
</span></span><span class="line"><span class="cl">clean       使えないユーザIDをコンパクトにし、使えない署名を鍵から除去
</span></span><span class="line"><span class="cl">minimize    使えないユーザIDをコンパクトにし、すべての署名を鍵から除去
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* &#39;sign&#39; コマンドは &#39;l&#39; で始まると、ローカルの署名で (lsign)、
</span></span><span class="line"><span class="cl">  &#39;t&#39; で始まると信用署名 (tsign)、&#39;nr&#39; で始まると失効不可署名
</span></span><span class="line"><span class="cl">  (nrsign)、もしくはこれらの組み合わせ (ltsign, tnrsign, など)となります。
</span></span></code></pre></div><p>本記事では，対話モードの詳細については割愛する。
基本的には <code>list</code>, <code>uid</code>, <code>key</code> を使ってでユーザIDや副鍵を指定し，それぞれに対して操作を行う感じ。
編集結果を保存して終了するには <code>save</code> を，単に対話モードから抜けるには <code>quit</code> を入力する。</p>
<h2 id="encrypt">データの暗号化</h2>
<p><a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の暗号化は概ね2種類ある。</p>
<h3 id="hybrid">ハイブリッド暗号</h3>
<p>ハイブリッド暗号は <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の基本機能で，平文を暗号化する「セッション鍵」とセッション鍵を暗号化する公開鍵で構成される。</p>
<figure style='margin:0 auto;text-align:center;'><div class="lightmode"><a href="https://baldanders.info/spiegel/openpgp/"><img src="https://baldanders.info/spiegel/openpgp/hybrid-enc.svg" srcset="https://baldanders.info/spiegel/openpgp/hybrid-enc.svg 715w" sizes="(min-width:600px) 500px, 80vw" alt="「わかる！ OpenPGP 暗号」より" loading="lazy"></a></div><figcaption><div><a href="https://baldanders.info/spiegel/openpgp/">「わかる！ OpenPGP 暗号」より</a></div></figcaption>
</figure>
<p>セッション鍵は <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> が自動的にし生成するのでコマンドラインではセッション鍵を暗号化する公開鍵を指定する。</p>
<p>暗号化を行うには <code>--encrypt</code> コマンドを使う。
短縮名は <code>-e</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -a --recipient alice -e plain-data
</span></span><span class="line"><span class="cl">-----BEGIN PGP MESSAGE-----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hQMOA3eSD2Hv5xXMEAwAkpcgXFe/zIlUyibCRLxQAK5KNYvzBxcoaxyk0lEsoUGt
</span></span><span class="line"><span class="cl">D7F1bLF64ha9J/FuzN3B63LsmqTw1I6tBIjq2OrSMvLAN10B6bfUtclZGRnK/H8J
</span></span><span class="line"><span class="cl">oRMYQUuteUUOcVR2v3MjBkRDrxMQDBfJwIx5N13R4bJrD/k+unfwo82JqiT/LuET
</span></span><span class="line"><span class="cl">cO7KLgiyf+mBpu1ln90QfYsNtQIZMOPdxutqsIAnZxM0gFjKLBmHBhBG85v4QonS
</span></span><span class="line"><span class="cl">KUqGZfPzxQfDW3t6gMfbkeDNqnldDMJyY0nXqdkaSznAXIJAT9TU7D2NlUaF7C8p
</span></span><span class="line"><span class="cl">51O5NnK/+8NYSWsrzkcL+taw3i83jcZFYzcI2oqjuC6wxrNW9SQ1Jr6QqNSanWot
</span></span><span class="line"><span class="cl">ieLtMGnfxXizEhYaZfiU+y2ebZFxOlS1SigPc+CfEiKKYlQ0DrnAyjxkVKFtp5oG
</span></span><span class="line"><span class="cl">UwA3n1rnsJZO7m7vwnpYlu25nlkM5y+AqjT6zqtPACsjBzzWG8nsMq6kMWvKYva/
</span></span><span class="line"><span class="cl">Fj0oDxtMJw2jAoIGITKzC/94tFTxs1WoLrMl1Lgjrr07xLqfp0mzFL1cBLK2YaRn
</span></span><span class="line"><span class="cl">rB2w0MOYFFjyMxPXPx4sUv22U8bfz3Vu/bD7I+0Jea6CUKzDjemdZlxYENPDvrX3
</span></span><span class="line"><span class="cl">XoKUEwdslrq98DdhH7xcBFC64gv2DyyP6TSpnkFb8sV3DUnQ+RiFkYZN0HKaqHx6
</span></span><span class="line"><span class="cl">EUlzMekSl+wUoxD/sGA7tgkjzYg+VHjdXWiCRpDTDIC9wpInP2il40BBWf9KCLCq
</span></span><span class="line"><span class="cl">K5hzERr5qepCg0RUs0kgjOjeAngEuAjMrHJJo3iQpiyFJq2Q0b/NAMJiBP0j88MY
</span></span><span class="line"><span class="cl">uM4sr8DJz1rfvQyLEfI2Satx8CjdXEkSwekxwBUzGSyij5NPJVLYFswTxhLrVUfq
</span></span><span class="line"><span class="cl">GSZAO1tbD++EU9ViSc0pcsuDNTcWPsba1fcotAVtCIZXqUGCNULuOZdOX4n/1oSt
</span></span><span class="line"><span class="cl">eu2sWmgrF8z1qTCobcYSiC8F1t9DkbOtot49izVqbE8uRkZ8U1kn5VbDgPCGVrtU
</span></span><span class="line"><span class="cl">DmOsVsgqcj8+MioyTDVMYqXSRwFLJEbBJJegDyjuVdVwSN9lqROPsuqHP/l8mLPs
</span></span><span class="line"><span class="cl">7KTQ/+Vi94pFitZmp7jrMc9BgDQwZgox81uNI2c2H9UsEl60sKqWYyIk
</span></span><span class="line"><span class="cl">=wqIs
</span></span><span class="line"><span class="cl">-----END PGP MESSAGE-----
</span></span></code></pre></div><p>あるいはパイプを使って</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -a --recipient alice -e
</span></span><span class="line"><span class="cl">-----BEGIN PGP MESSAGE-----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hQMOA3eSD2Hv5xXMEAwAkpcgXFe/zIlUyibCRLxQAK5KNYvzBxcoaxyk0lEsoUGt
</span></span><span class="line"><span class="cl">D7F1bLF64ha9J/FuzN3B63LsmqTw1I6tBIjq2OrSMvLAN10B6bfUtclZGRnK/H8J
</span></span><span class="line"><span class="cl">oRMYQUuteUUOcVR2v3MjBkRDrxMQDBfJwIx5N13R4bJrD/k+unfwo82JqiT/LuET
</span></span><span class="line"><span class="cl">cO7KLgiyf+mBpu1ln90QfYsNtQIZMOPdxutqsIAnZxM0gFjKLBmHBhBG85v4QonS
</span></span><span class="line"><span class="cl">KUqGZfPzxQfDW3t6gMfbkeDNqnldDMJyY0nXqdkaSznAXIJAT9TU7D2NlUaF7C8p
</span></span><span class="line"><span class="cl">51O5NnK/+8NYSWsrzkcL+taw3i83jcZFYzcI2oqjuC6wxrNW9SQ1Jr6QqNSanWot
</span></span><span class="line"><span class="cl">ieLtMGnfxXizEhYaZfiU+y2ebZFxOlS1SigPc+CfEiKKYlQ0DrnAyjxkVKFtp5oG
</span></span><span class="line"><span class="cl">UwA3n1rnsJZO7m7vwnpYlu25nlkM5y+AqjT6zqtPACsjBzzWG8nsMq6kMWvKYva/
</span></span><span class="line"><span class="cl">Fj0oDxtMJw2jAoIGITKzC/94tFTxs1WoLrMl1Lgjrr07xLqfp0mzFL1cBLK2YaRn
</span></span><span class="line"><span class="cl">rB2w0MOYFFjyMxPXPx4sUv22U8bfz3Vu/bD7I+0Jea6CUKzDjemdZlxYENPDvrX3
</span></span><span class="line"><span class="cl">XoKUEwdslrq98DdhH7xcBFC64gv2DyyP6TSpnkFb8sV3DUnQ+RiFkYZN0HKaqHx6
</span></span><span class="line"><span class="cl">EUlzMekSl+wUoxD/sGA7tgkjzYg+VHjdXWiCRpDTDIC9wpInP2il40BBWf9KCLCq
</span></span><span class="line"><span class="cl">K5hzERr5qepCg0RUs0kgjOjeAngEuAjMrHJJo3iQpiyFJq2Q0b/NAMJiBP0j88MY
</span></span><span class="line"><span class="cl">uM4sr8DJz1rfvQyLEfI2Satx8CjdXEkSwekxwBUzGSyij5NPJVLYFswTxhLrVUfq
</span></span><span class="line"><span class="cl">GSZAO1tbD++EU9ViSc0pcsuDNTcWPsba1fcotAVtCIZXqUGCNULuOZdOX4n/1oSt
</span></span><span class="line"><span class="cl">eu2sWmgrF8z1qTCobcYSiC8F1t9DkbOtot49izVqbE8uRkZ8U1kn5VbDgPCGVrtU
</span></span><span class="line"><span class="cl">DmOsVsgqcj8+MioyTDVMYqXSRwFLJEbBJJegDyjuVdVwSN9lqROPsuqHP/l8mLPs
</span></span><span class="line"><span class="cl">7KTQ/+Vi94pFitZmp7jrMc9BgDQwZgox81uNI2c2H9UsEl60sKqWYyIk
</span></span><span class="line"><span class="cl">=wqIs
</span></span><span class="line"><span class="cl">-----END PGP MESSAGE-----
</span></span></code></pre></div><p>とすることもできる。</p>
<p>ちなみに，この暗号データの中身を拙作 <a href="https://github.com/goark/gpgpdump" title="goark/gpgpdump: OpenPGP packet visualizer">gpgpdump</a> で覗くとこんな感じになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -a --recipient alice -e | gpgpdump --indent 2
</span></span><span class="line"><span class="cl">Public-Key Encrypted Session Key Packet (tag 1) (782 bytes)
</span></span><span class="line"><span class="cl">  Version: 3 (current)
</span></span><span class="line"><span class="cl">  Key ID: 0x77920f61efe715cc
</span></span><span class="line"><span class="cl">  Public-key Algorithm: Elgamal (Encrypt-Only) (pub 16)
</span></span><span class="line"><span class="cl">  ElGamal g^k mod p (3072 bits)
</span></span><span class="line"><span class="cl">  ElGamal m * y^k mod p (3071 bits)
</span></span><span class="line"><span class="cl">Sym. Encrypted Integrity Protected Data Packet (tag 18) (71 bytes)
</span></span><span class="line"><span class="cl">  Encrypted data: sym alg is specified in pub-key encrypted session key (71 bytes)
</span></span></code></pre></div><p><code>--recipient</code> がセッション鍵の暗号化を行う公開鍵を指定するオプションである。
短縮名は <code>-r</code>。
<code>--recipient</code> オプションは複数指定できる。
また鍵束フォルダにある <code>gpg.conf</code> ファイルで常に使用する公開鍵を指定することもできる<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">default-key alice
</span></span><span class="line"><span class="cl">default-recipient-self
</span></span></code></pre></div><p>さらに <code>--group</code> オプションで複数のユーザをグルーピングできる。
たとえば <code>gpg.conf</code> ファイルに</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">group allcast = Alice Bob Chris
</span></span></code></pre></div><p>などと設定しておけば</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo hello world | gpg -a -r allcast -e
</span></span></code></pre></div><p>で Alice, Bob, CHris 3人の公開鍵でセッション鍵を暗号化してくれる。</p>
<h3 id="symmetric">セッション鍵のみで暗号化する</h3>
<p>公開鍵は使わずパスフレーズから生成したセッション鍵のみで暗号化を行う場合は <code>--symmetric</code> コマンドを使う。
短縮名は <code>-c</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -a -c
</span></span><span class="line"><span class="cl">-----BEGIN PGP MESSAGE-----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">jA0EBwMCgMkCBCmvi5D/0kEBHskD5D+oRASdhy04sJQ6EX6hObuqT170+wr7wB4f
</span></span><span class="line"><span class="cl">XTDWFf7c6XXN0LABKN6z3kYxz2MTRC3cqo2ExRF30RHpeA==
</span></span><span class="line"><span class="cl">=xvgI
</span></span><span class="line"><span class="cl">-----END PGP MESSAGE-----
</span></span></code></pre></div><p>コマンド起動時にパスフレーズの入力を要求され，パスフレーズからセッション鍵を生成して暗号化を行う。
したがって，何らかの方法で暗号データの受け手とパスフレーズを共有する必要がある。</p>
<p>この暗号データの中身を拙作 <a href="https://github.com/goark/gpgpdump" title="goark/gpgpdump: OpenPGP packet visualizer">gpgpdump</a> で覗くとこんな感じになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -a -c | gpgpdump --indent 2
</span></span><span class="line"><span class="cl">Symmetric-Key Encrypted Session Key Packet (tag 3) (13 bytes)
</span></span><span class="line"><span class="cl">  Version: 4 (current)
</span></span><span class="line"><span class="cl">  Symmetric Algorithm: AES with 128-bit key (sym 7)
</span></span><span class="line"><span class="cl">  String-to-Key (S2K) Algorithm: Iterated and Salted S2K (s2k 3)
</span></span><span class="line"><span class="cl">    Hash Algorithm: SHA-1 (hash 2)
</span></span><span class="line"><span class="cl">    Salt
</span></span><span class="line"><span class="cl">      80 c9 02 04 29 af 8b 90
</span></span><span class="line"><span class="cl">    Count: 65011712
</span></span><span class="line"><span class="cl">      ff
</span></span><span class="line"><span class="cl">Sym. Encrypted Integrity Protected Data Packet (tag 18) (65 bytes)
</span></span><span class="line"><span class="cl">  Encrypted data: sym alg is specified in sym-key encrypted session key; plain text + MDC SHA1(20 bytes) (65 bytes)
</span></span></code></pre></div><h2 id="decrypt">暗号データの復号</h2>
<p>暗号データのf区号には <code>--decrypt</code> コマンドを使う（パスフレーズ入力あり）。
短縮名は <code>-d</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -r alice -e -a &gt; alice-enc.asc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg -d alice-enc.asc
</span></span><span class="line"><span class="cl">gpg: 3072-ビットELG鍵, ID 77920F61EFE715CC, 日付2020-06-27に暗号化されました
</span></span><span class="line"><span class="cl">      &#34;Alice &lt;alice@example.com&gt;&#34;
</span></span><span class="line"><span class="cl">Hello world
</span></span></code></pre></div><p>復号したデータはファイルにリダイレクトすればいいのだが， Windows の場合は安全のため <code>--output</code> オプションを使うことをお勧めする。
短縮名は <code>-o</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -o out.txt -d alice-enc.asc
</span></span><span class="line"><span class="cl">gpg: 3072-ビットELG鍵, ID 77920F61EFE715CC, 日付2020-06-27に暗号化されました
</span></span><span class="line"><span class="cl">      &#34;Alice &lt;alice@example.com&gt;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat out.txt
</span></span><span class="line"><span class="cl">Hello world
</span></span></code></pre></div><p>セッション鍵のみで暗号化した場合も同じコマンドで復号できる（パスフレーズ入力あり）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -a -c &gt; alice-sym-enc.asc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg -d alice-sym-enc.asc
</span></span><span class="line"><span class="cl">gpg: AES暗号化済みデータ
</span></span><span class="line"><span class="cl">gpg: 1 個のパスフレーズで暗号化
</span></span><span class="line"><span class="cl">Hello world
</span></span></code></pre></div><h2 id="sign">データへの電子署名と検証</h2>
<p>データへの電子署名にも幾つかの方法がある。</p>
<h3 id="clear-sign">クリア署名</h3>
<p>まずデータがテキストの場合は「クリア署名」という方法が使える。
クリア署名には <code>--clear-sign</code> コマンドを使う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -u alice --clear-sign
</span></span><span class="line"><span class="cl">-----BEGIN PGP SIGNED MESSAGE-----
</span></span><span class="line"><span class="cl">Hash: SHA256
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hello world
</span></span><span class="line"><span class="cl">-----BEGIN PGP SIGNATURE-----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iIgEAREIADAWIQS4r4j8NEiFn89lgQwg7bQdUJPKigUCXvaY4hIcYWxpY2VAZXhh
</span></span><span class="line"><span class="cl">bXBsZS5jb20ACgkQIO20HVCTyorOTQEAyrm2FVfF3SMA34mh0+B8iRDj+hRr9fL5
</span></span><span class="line"><span class="cl">WXI/DhtRkFsBAOLTv1riIFb3yeodDX6zUgNkISGWQM1dSLDILeEpVOTt
</span></span><span class="line"><span class="cl">=XyJW
</span></span><span class="line"><span class="cl">-----END PGP SIGNATURE-----
</span></span></code></pre></div><p>このようにクリア署名は元になるテキストと電子署名がくっついた状態で出力される。
なお，クリア署名の場合は必ず ASCII Armor 形式の出力になるため <code>--armor</code> オプションは不要である。</p>
<p>署名の検証には <code>--verify</code> コマンドを使う。
少し横着して署名と検証をパイプで繋いでしまおう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -u alice --clear-sign | gpg --verify
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 09時55分43秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>まぁ自分で署名して，出力をそのまま自分で検証してるんだから正しくてあたり前なのだが，流れは分かると思う。</p>
<p>実は <code>--verify</code> コマンドは <code>--decrypt</code> コマンドで代替えできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world | gpg -u alice --clear-sign | gpg -d
</span></span><span class="line"><span class="cl">Hello world
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 09時56分17秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>このように <code>--decrypt</code> コマンドを使うと署名対象のテキストを抽出して出力してくれるのが利点である。</p>
<h3 id="detach-sign">分離署名</h3>
<p>次はファイルへの電子署名をやってみる。
まず署名対象のファイルを用意する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ echo Hello world&gt; hello.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat hello.txt
</span></span><span class="line"><span class="cl">Hello world
</span></span></code></pre></div><p>このファイルを配布する際に途中で改竄がないか知りたい。
こういう場合は「分離署名」にする。
分離署名には <code>--detach-sign</code> コマンドを使う。
短縮名は <code>-b</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u alice -b hello.txt
</span></span></code></pre></div><p>この結果 <code>hello.txt</code> ファイルと同じ場所に <code>hello.txt.sig</code> ファイルが作成される。
中身はバイナリデータである。</p>
<p>この<code>hello.txt</code> ファイルと <code>hello.txt.sig</code> ファイルをセットで配布するのである。
どちらかのファイルが改竄されていれば署名の検証が NG になるはずである。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --verify hello.txt.sig
</span></span><span class="line"><span class="cl">gpg: 署名されたデータが&#39;hello.txt&#39;にあると想定します
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 09時58分05秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>ここでは署名対象のファイルを <code>hello.txt</code> と推測して署名の検証を行っている。
署名対象のファイルを明示して指定するには</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --verify hello.txt.sig hello.txt
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 09時58分05秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>とする。
分離署名の検証でも <code>--decrypt</code> コマンドが使える。
ただし出力は全く同じ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$  gpg -d hello.txt.sig
</span></span><span class="line"><span class="cl">gpg: 署名されたデータが&#39;hello.txt&#39;にあると想定します
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 09時58分05秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>なお，署名対象のファイルがテキスト・ファイルの場合は <code>--textmode</code> オプションを付けて電子署名を行ったほうが安全である。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u alice --textmode -b hello.txt
</span></span></code></pre></div><p>テキスト・ファイルの場合，配布経路によっては改行コードが変えられたりするため（電子メールや FTP 転送など），電子署名を行ったり署名検証を行ったりする前にテキストを正規化しているのである。</p>
<h3 id="data-in-sign">署名データに署名対象のデータを含める</h3>
<p><a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> ではもうひとつ電子署名の形式がある。
電子署名データの中に署名対象のデータを埋め込んでしまうのである。
これを行うには <code>--sign</code> コマンドを使う。
短縮名は <code>-s</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u alice -s hello.txt
</span></span></code></pre></div><p>この結果 <code>hello.txt</code> ファイルと同じ場所に <code>hello.txt.gpg</code> ファイルが作成される。
中身はバイナリデータである。</p>
<p>さて，できたファイルを検証しよう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --verify hello.txt.gpg
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 10時00分45秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>検証は OK だが署名対象のデータが取り出せない。
そこでまた <code>--decrypt</code> コマンドを使う。。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -d hello.txt.gpg
</span></span><span class="line"><span class="cl">Hello world
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 10時00分45秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>これでデータの抽出ができた。
署名対象のデータを埋め込む方式の何が嬉しいかというと，暗号化と組み合わせる事ができるのである。</p>
<h3 id="encrypt-and-sign">暗号化と電子署名を同時に行う</h3>
<p>暗号化と電子署名を同時に行うには <code>--encrypt</code> コマンドと<code>--sign</code> コマンドを同時に指定する。
短縮名は <code>-se</code> または <code>-es</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u alice -r bob -se hello.txt
</span></span></code></pre></div><p>ここでは Bob の公開鍵で暗号化して Alice の鍵で電子署名するようにしてみた。
この結果 <code>hello.txt</code> ファイルと同じ場所に <code>hello.txt.gpg</code> ファイルが作成される。
中身はバイナリデータである。</p>
<p>ではこれを復号してみよう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -d hello.txt.gpg
</span></span><span class="line"><span class="cl">gpg: 3072-ビットRSA鍵, ID 02F4454D89E9C0D6, 日付2020-06-27に暗号化されました
</span></span><span class="line"><span class="cl">      &#34;Bob &lt;bob@bob@example.com&gt;&#34;
</span></span><span class="line"><span class="cl">Hello world
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 10時14分56秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>このように復号と署名検証が同時に行われる。</p>
<p>ちなみにセッション鍵のみの暗号化と電子署名を組み合わせることもできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u alice -sc hello.txt
</span></span><span class="line"><span class="cl">gpg: AES暗号化を使用します
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg -d hello.txt.gpg
</span></span><span class="line"><span class="cl">gpg: AES暗号化済みデータ
</span></span><span class="line"><span class="cl">gpg: 1 個のパスフレーズで暗号化
</span></span><span class="line"><span class="cl">Hello world
</span></span><span class="line"><span class="cl">gpg: 2020年06月27日 10時16分16秒 JSTに施された署名
</span></span><span class="line"><span class="cl">gpg:                DSA鍵B8AF88FC3448859FCF65810C20EDB41D5093CA8Aを使用
</span></span><span class="line"><span class="cl">gpg:                発行者&#34;alice@example.com&#34;
</span></span><span class="line"><span class="cl">gpg: &#34;Alice &lt;alice@example.com&gt;&#34;からの正しい署名 [究極]
</span></span></code></pre></div><p>署名・暗号化ではパスフレーズ入力が最大3回（暗号化で確認を入れて2回，電子署名で1回）発生するので注意すること。</p>
<h2 id="revocs">鍵を失効させる</h2>
<p>パスフレーズの漏洩や暗号アルゴリズムの危殆化などによって鍵を失効しなければならない場合がある。</p>
<p>鍵を作成する際に鍵束フォルダの <code>openpgp-revocs.d</code> フォルダに失効証明書が作成される。
中身はこんな感じ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">これは失効証明書でこちらのOpenPGP鍵に対するものです:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [S] [有効期限: 2021-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid          Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">失効証明書は &#34;殺すスイッチ&#34; のようなもので、鍵がそれ以上使えない
</span></span><span class="line"><span class="cl">ように公に宣言するものです。一度発行されると、そのような失効証明書は
</span></span><span class="line"><span class="cl">撤回することはできません。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">秘密鍵のコンプロマイズや紛失の場合、これを使ってこの鍵を失効させます。
</span></span><span class="line"><span class="cl">しかし、秘密鍵がまだアクセス可能である場合、新しい失効証明書を生成し、
</span></span><span class="line"><span class="cl">失効の理由をつける方がよいでしょう。詳細は、GnuPGマニュアルのgpgコマン
</span></span><span class="line"><span class="cl">ド &#34;--generate-revocation&#34;の記述をご覧ください。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">このファイルを誤って使うのを避けるため、以下ではコロンが5つのダッシュ
</span></span><span class="line"><span class="cl">の前に挿入されます。この失効証明書をインポートして公開する前に、テク
</span></span><span class="line"><span class="cl">スト・エディタでこのコロンを削除してください。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">:-----BEGIN PGP PUBLIC KEY BLOCK-----
</span></span><span class="line"><span class="cl">Comment: This is a revocation certificate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iHgEIBEIACAWIQS4r4j8NEiFn89lgQwg7bQdUJPKigUCXvaS7wIdAAAKCRAg7bQd
</span></span><span class="line"><span class="cl">UJPKihg/AP9enGjHPngyJLQXJmQhygq7FQ6GmqAmDrvPRwYf5eLLQQD+IAgyE+ho
</span></span><span class="line"><span class="cl">0nWE84Q2/HosO6a8as+0CFyJWzS1RkXUa5g=
</span></span><span class="line"><span class="cl">=Zck3
</span></span><span class="line"><span class="cl">-----END PGP PUBLIC KEY BLOCK-----
</span></span></code></pre></div><p>このファイルをインポートすることで鍵が失効される。
なお失効証明書を使用の際には</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">:-----BEGIN PGP PUBLIC KEY BLOCK-----
</span></span></code></pre></div><p>の先頭のコロン（<code>:</code>）を削除して使うこと。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --import openpgp-revocs.d/B8AF88FC3448859FCF65810C20EDB41D5093CA8A.rev
</span></span><span class="line"><span class="cl">gpg: 鍵20EDB41D5093CA8A:&#34;Alice &lt;alice@example.com&gt;&#34;失効証明書をインポートしました
</span></span><span class="line"><span class="cl">gpg: 処理数の合計: 1
</span></span><span class="line"><span class="cl">gpg:    新しい鍵の失効: 1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg -k alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2020-06-27 [SC] [失効: 2020-06-27]
</span></span><span class="line"><span class="cl">      B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span><span class="line"><span class="cl">uid           [  失効  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --send-keys B8AF88FC3448859FCF65810C20EDB41D5093CA8A
</span></span></code></pre></div><div class="center caution">失効した公開鍵を配布するのを忘れずに！</div>
<h3 id="gen-revoke">&ndash;generate-revocation コマンド</h3>
<p>失効証明書は <code>--generate-revocation</code> コマンドで作成することもできる。
短縮名は <code>--gen-revoke</code>。</p>
<pre tabindex="0"><code class="language-test" data-lang="test">$ gpg --gen-revoke alice

sec  dsa3072/20EDB41D5093CA8A 2020-06-27 Alice &lt;alice@example.com&gt;

この鍵に対する失効証明書を作成しますか? (y/N) y
失効の理由を選択してください:
  0 = 理由は指定されていません
  1 = 鍵(の信頼性)が損なわれています
  2 = 鍵がとりかわっています
  3 = 鍵はもはや使われていません
  Q = キャンセル
(ここではたぶん1を選びたいでしょう)
あなたの決定は? 1
予備の説明を入力。空行で終了:
&gt; for example
&gt; 
失効理由: 鍵(の信頼性)が損なわれています
for example
よろしいですか? (y/N) y
ASCII外装出力を強制します。
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: This is a revocation certificate

iIMEIBEIACsWIQS4r4j8NEiFn89lgQwg7bQdUJPKigUCXvafEQ0dAmZvciBleGFt
cGxlAAoJECDttB1Qk8qKbacA+wd+SaX+khrq6mz4G9NlZio8jcmtHvF5RFncq4wl
UZ/MAP42/Kkuy249M9ZDHQAnTd7Yb3NbuBcphEqJ1iPIZ6niYg==
=AIvD
-----END PGP PUBLIC KEY BLOCK-----
失効証明書を作成しました。

みつからないように隠せるような媒体に移してください。もし_悪者_がこの証明書への
アクセスを得ると、あなたの鍵を使えなくすることができます。
媒体が読出し不能になった場合に備えて、この証明書を印刷して保管するのが賢明です。
しかし、ご注意ください。あなたのマシンの印字システムは、他の人がアクセスできる
場所にデータをおくことがあります!
</code></pre><p>このうち ASCII Armor 形式の部分をコピペして使えばよい。
ちなみに，この失効証明書の中身を拙作 <a href="https://github.com/goark/gpgpdump" title="goark/gpgpdump: OpenPGP packet visualizer">gpgpdump</a> で覗くとこんな感じになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpgpdump -f rev.txt --indent 2
</span></span><span class="line"><span class="cl">Signature Packet (tag 2) (131 bytes)
</span></span><span class="line"><span class="cl">  Version: 4 (current)
</span></span><span class="line"><span class="cl">  Signiture Type: Key revocation signature (0x20)
</span></span><span class="line"><span class="cl">  Public-key Algorithm: DSA (Digital Signature Algorithm) (pub 17)
</span></span><span class="line"><span class="cl">  Hash Algorithm: SHA2-256 (hash 8)
</span></span><span class="line"><span class="cl">  Hashed Subpacket (43 bytes)
</span></span><span class="line"><span class="cl">    Issuer Fingerprint (sub 33) (21 bytes)
</span></span><span class="line"><span class="cl">      Version: 4 (need 20 octets length)
</span></span><span class="line"><span class="cl">      Fingerprint (20 bytes)
</span></span><span class="line"><span class="cl">        b8 af 88 fc 34 48 85 9f cf 65 81 0c 20 ed b4 1d 50 93 ca 8a
</span></span><span class="line"><span class="cl">    Signature Creation Time (sub 2): 2020-06-27T10:21:21+09:00
</span></span><span class="line"><span class="cl">    Reason for Revocation (sub 29): Key material has been compromised (key revocations) (2) (12 bytes)
</span></span><span class="line"><span class="cl">      Additional information: for example
</span></span><span class="line"><span class="cl">  Unhashed Subpacket (10 bytes)
</span></span><span class="line"><span class="cl">    Issuer (sub 16): 0x20edb41d5093ca8a
</span></span><span class="line"><span class="cl">  Hash left 2 bytes
</span></span><span class="line"><span class="cl">    6d a7
</span></span><span class="line"><span class="cl">  DSA value r (251 bits)
</span></span><span class="line"><span class="cl">  DSA value s (254 bits)
</span></span></code></pre></div><p>鍵作成時に作られた失効証明書は別の場所に補完しておくことをお勧めする。
もし失効が必要になった時に時間的な余裕があれば <code>--generate-revocation</code> コマンドで失効証明書を（失効理由も含める形で）作成し，即失効，配布を行うのがいいと思う。</p>
<h2>ブックマーク</h2>
<ul>
<li>
<p><a href="https://www.gnupg.org/documentation/manuals/gnupg/OpenPGP-Key-Management.html">Using the GNU Privacy Guard: OpenPGP Key Management</a></p>
</li>
<li>
<p><a href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html">Using the GNU Privacy Guard: Unattended GPG key generation</a></p>
</li>
<li>
<p><a href="https://www.gnupg.org/documentation/manuals/gnupg/GPG-Configuration-Options.html">Using the GNU Privacy Guard: GPG Configuration Options</a></p>
</li>
<li>
<p><a href="https://baldanders.info/spiegel/cc-license/">わかる！ OpenPGP 暗号 — Baldanders.info</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/remark/2017/11/openpgp-key-management/">OpenPGP 鍵管理に関する考察</a></p>
</li>
</ul>
<h2>参考図書</h2>
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/B015643CPE?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/51t6yHHVwEL._SL160_.jpg" width="113" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/B015643CPE?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">暗号技術入門 第3版　秘密の国のアリス</a></dt>
    <dd>結城 浩 (著)</dd>
    <dd>SBクリエイティブ 2015-08-25 (Release 2015-09-17)</dd>
    <dd>Kindle版</dd>
    <dd>B015643CPE (ASIN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="5">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i></abbr></dd>
  </dl>
  <p class="description">SHA-3 や Bitcoin/Blockchain など新しい知見や技術要素を大幅追加。暗号技術を使うだけならこれ1冊でとりあえず無問題。</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2015-09-20">2015-09-20</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- 暗号技術入門 第3版 -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>第三者による野良署名が推奨されない理由については拙文「<a href="https://text.baldanders.info/remark/2019/07/openpgp-certificate-flooding/">OpenPGP 公開鍵サーバにおける公開鍵の汚染問題</a>」を参照のこと。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>詳しくは拙文「<a href="/openpgp/openpgp-key-management/">OpenPGP 鍵管理に関する考察</a>」を参照のこと。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><code>default-recipient-self</code> の指定は自身の鍵で復号できるよう設定するためのものである。相手の公開鍵のみで暗号化してしまうと，暗号化した本人が復号できないことになってしまうため。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/openpgp/using-gnupg-for-windows-2/">GnuPG for Windows : gpg-agent について</a></div>
<div class="next-page"><a href="/openpgp/git-commit-with-openpgp-signature/">Git Commit で OpenPGP 署名を行う</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Mastodon などの SNS や電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2017-12-01</time> (revised in 2022-03-27)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a rel="me" href="https://github.com/spiegel-im-spiegel"><span class="github-color"><abbr title="GitHub"><i class="fab fa-github"></i></abbr></span></a></li><li><a rel="me" href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><abbr title="Flickr"><i class="fab fa-flickr"></i></abbr></span></a></li><li><a rel="me" href="https://goark.fedicity.net/@spiegel"><span class="mastodon-color"><abbr title="Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a></li><li><a rel="me" href="https://bsky.app/profile/baldanders.info"><span class="bluesky-color"><abbr title="Bluesky"><i class="fa-brands fa-bluesky"></i></abbr></span></a></li><li><a rel="me" href="https://www.strava.com/athletes/122077389"><span class="strava-color"><abbr title="Strava"><i class="fa-brands fa-strava"></i></abbr></span></a></li><li><a rel="me" href="https://x.com/spiegel_2007"><span class="x-twitter-color"><abbr title="X (Twitter)"><i class="fab fa-x-twitter"></i></abbr></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fgnupg-cheat-sheet%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.153.3</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>

</body>
</html>
