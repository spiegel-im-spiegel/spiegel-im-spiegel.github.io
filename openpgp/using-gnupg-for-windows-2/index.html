<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.150.0">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/">
<script defer src="/fa/js/all.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=BIZ+UDMincho&family=Inconsolata:wght@400;700&family=Noto+Color+Emoji&family=Noto+Sans:wght@400;700&family=Noto+Serif&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<link rel="me" href="https://fedibird.com/@spiegel">
<title>GnuPG for Windows : gpg-agent について [text.Baldanders.info]</title>
<meta property="og:title" content="GnuPG for Windows : gpg-agent について">
<meta name="description" content="今回は gpg-agent について解説する。">
<meta property="og:description" content="今回は gpg-agent について解説する。">
<meta property="og:image" content="https://text.baldanders.info/images/attention/openpgp.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@spiegel_2007">
<meta name="twitter:creator" content="@spiegel_2007">
<link rel="me" href="https://goark.fedicity.net/@spiegel">
<meta name="keywords" content="security, cryptography, openpgp, gnupg, tools, openssh, putty">
<link rel='prev' href='https://text.baldanders.info/openpgp/using-gnupg-for-windows-1/' title='GnuPG for Windows インストール編'>
<link rel='next' href='https://text.baldanders.info/openpgp/gnupg-cheat-sheet/' title='GnuPG チートシート（鍵作成から失効まで）'>

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/openpgp/",
	"url": "https://text.baldanders.info/openpgp/",
	"inLanguage": "ja",
	"name": "OpenPGP の実装",
	"description": "OpenPGP とその実装である GnuPG 等に関する話題。",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/openpgp/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/",
	"url": "https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/",
	"mainEntityOfPage": "https://text.baldanders.info/openpgp/using-gnupg-for-windows-2/",
	"inLanguage": "ja",
	"name": "GnuPG for Windows : gpg-agent について",
	"description": "今回は gpg-agent について解説する。",
	"headline": "今回は gpg-agent について解説する。",
	"keywords": "security, cryptography, openpgp, gnupg, tools, openssh, putty",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"datePublished": "2017-12-01T08:48:43+00:00",
	"dateModified": "2021-01-10T02:49:53+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/openpgp/">OpenPGP の実装</a>
</nav>
<article>
<h1>GnuPG for Windows : gpg-agent について</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/cryptography/">cryptography</a> #<a href="/tags/gnupg/">gnupg</a> #<a href="/tags/openpgp/">openpgp</a> #<a href="/tags/openssh/">openssh</a> #<a href="/tags/putty/">putty</a> #<a href="/tags/security/">security</a> #<a href="/tags/tools/">tools</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fas fa-share-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fusing-gnupg-for-windows-2%2f&amp;title=GnuPG%20for%20Windows%20%3a%20gpg-agent%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6" target="_blank"><span class="pocket-color"><abbr title="Share Pocket"><i class="fab fa-get-pocket" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fusing-gnupg-for-windows-2%2f" target="_blank"><span class="facebook-color"><abbr title="Share facebook"><i class="fab fa-facebook-square" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://twitter.com/share?text=GnuPG%20for%20Windows%20%3a%20gpg-agent%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6+by+@spiegel_2007&amp;url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fusing-gnupg-for-windows-2%2f" target="_blank"><span class="twitter-color"><abbr title="Share Twitter"><i class="fab fa-twitter-square" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="https://donshare.net/share.html?text=GnuPG%20for%20Windows%20%3a%20gpg-agent%20%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6+by+@spiegel%40goark.fedicity.net%20+https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fusing-gnupg-for-windows-2%2f" target="_blank"><span class="mastodon-color"><abbr title="Share Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a>
	</div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/openpgp/using-gnupg-for-windows-2/index.html">GitHub Page</a>
</nav>

<section>
<h2>gpg-agent</h2>
<p><code>gpg-agent</code> は <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の中核コンポーネントで，秘密鍵の管理<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> を行い一定期間キャッシュする。
<code>gpg-agent</code> は <code>gpg</code>, <code>gpgsm</code>, <code>gpgconf</code>, <code>gpg-connect-agent</code> といったコンポーネントから常駐プロセスとして起動されお互いに通信を行う<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。</p>
<p><code>gpg-agent</code> が稼働中かどうかは <code>gpg-agent</code> を引数なしで起動すれば分かる。
以下は既に起動している場合。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg-agent
</span></span><span class="line"><span class="cl">gpg-agent[3996]: gpg-agent running and available
</span></span></code></pre></div><p><code>gpg-agent</code> が稼働していない場合は</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg-agent
</span></span><span class="line"><span class="cl">gpg-agent[9552]: no gpg-agent running in this session
</span></span></code></pre></div><p>などと表示される。</p>
<p>手動で <code>gpg-agent</code> を起動する場合は以下のコマンドで起動する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg-connect-agent /bye
</span></span><span class="line"><span class="cl">gpg-connect-agent: no running gpg-agent - starting &#39;C:\path\to\GnuPG\bin\gpg-agent.exe&#39;
</span></span><span class="line"><span class="cl">gpg-connect-agent: waiting for the agent to come up ... (5s)
</span></span><span class="line"><span class="cl">gpg-connect-agent: connection to agent established
</span></span></code></pre></div><p>逆に <code>gpg-agent</code> を手動で停止したい場合は</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg-connect-agent killagent /bye
</span></span><span class="line"><span class="cl">OK closing connection
</span></span></code></pre></div><p>とすれば安全に停止できる。</p>
<h3>Pinentry</h3>
<p>Pinentry はパスフレーズ<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> やスマートカードの PIN コードを入力する際に <code>gpg-agent</code> から呼び出される。
Windows 版では Pinentry プログラムとして <code>pinentry-basic.exe</code> が同梱されている。
同等の機能を持つものであれば他のプログラムと差し替えることもできる。</p>
<p><code>gpg</code> に <code>--batch</code> （または <code>--pinentry-mode loopback</code>）オプションとパスフレーズ指定オプション（<code>--passphrase</code>, <code>--passphrase-fd</code>, <code>--passphrase-file</code>）をセットで指定している場合は Pinentry を迂回できることがある（<code>--quick-gen-key</code> コマンドの場合など）。</p>
<h3>gpg-agent のオプション</h3>
<p><code>gpg-agent</code> のオプションは <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> ホームディレクトリ<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> 直下にある <code>gpg-agent.conf</code> ファイルで設定する。
設定は以下の様なフォーマットで行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">default-cache-ttl 600
</span></span><span class="line"><span class="cl">max-cache-ttl 7200
</span></span></code></pre></div><p><code>gpg-agent.conf</code> ファイルで使いそうなオプションを以下に挙げる。</p>
<table>
  <thead>
      <tr>
          <th>オプション名</th>
          <th>内容</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>log-file</code></td>
          <td>ログの出力先をフルパスで指定する。 挙動をチェックしたい場合など</td>
      </tr>
      <tr>
          <td><code>default-cache-ttl</code></td>
          <td>直前にアクセスしたキャッシュ・エントリの有効期間を秒単位で指定する。 既定値は 600</td>
      </tr>
      <tr>
          <td><code>max-cache-ttl</code></td>
          <td>キャッシュ・エントリの有効期間の最大値を秒単位で指定する。 アクセスの有無にかかわらずこの期間が過ぎるとキャッシュがクリアされる。 既定値は 7200</td>
      </tr>
      <tr>
          <td><code>pinentry-program</code></td>
          <td>独自に Pinentry プログラムを指定する場合はここにフルパスで指定する</td>
      </tr>
      <tr>
          <td><code>pinentry-timeout</code></td>
          <td>Pinentry プログラムの表示時間を秒単位で指定する。 既定値は 0 （タイムアウトなし）</td>
      </tr>
  </tbody>
</table>
<p>他にも，鍵生成時にパスフレーズの文字種や最小文字長を指定したり，パスフレーズの有効期間（期間が過ぎると警告が出るらしい）を設定できたりするようだ。
オプション項目について詳しくはは<a href="https://gnupg.org/documentation/manuals/gnupg/Agent-Options.html" title="Agent Options - Using the GNU Privacy Guard">マニュアル</a>（英語）を参照のこと。</p>
<h2>PuTTY with gpg-agent</h2>
<p><a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> は Windows 用の SSH クライアント兼ターミナル・エミュレータである。
<a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> には Plink と呼ばれるコマンドラインベースの SSH 接続ツールがあり，他ツール（例えば <a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a>）と連携できるようになっている。
さらに <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> には Pageant と呼ばれるエージェントツールもあり，認証用の秘密鍵をキャッシュすることができる。</p>
<p>今回は Pageant を <code>gpg-agent</code> で置き換えることを考える。</p>
<h3>gpg-agent のオプション</h3>
<p><code>gpg-agent.conf</code> ファイルに以下のオプションを追加する（<code>enable-putty-support</code> 以外は任意）。</p>
<table>
  <thead>
      <tr>
          <th>オプション名</th>
          <th>内容</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>enable-putty-support</code></td>
          <td>Pageant プロトコルを有効にする</td>
      </tr>
      <tr>
          <td><code>default-cache-ttl-ssh</code></td>
          <td>直前にアクセスしたキャッシュ・エントリの有効期間を秒単位で指定する。 既定値は 1800</td>
      </tr>
      <tr>
          <td><code>max-cache-ttl-ssh</code></td>
          <td>キャッシュ・エントリの有効期間の最大値を秒単位で指定する。 アクセスの有無にかかわらずこの期間が過ぎるとキャッシュがクリアされる。 既定値は 7200</td>
      </tr>
  </tbody>
</table>
<p>設定を保存したら <code>gpg-connect-agent</code> を使って <code>gpg-agent</code> を再起動する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg-connect-agent killagent /bye
</span></span><span class="line"><span class="cl">OK closing connection
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg-connect-agent /bye
</span></span><span class="line"><span class="cl">gpg-connect-agent: no running gpg-agent - starting &#39;C:\path\to\GnuPG\bin\gpg-agent.exe&#39;
</span></span><span class="line"><span class="cl">gpg-connect-agent: waiting for the agent to come up ... (5s)
</span></span><span class="line"><span class="cl">gpg-connect-agent: connection to agent established
</span></span></code></pre></div><p>なお， <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の各コンポーネントは必要に応じて自動的に <code>gpg-agent</code> を起動するので問題ないのだが， <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> は <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> と連動しているわけではないため， <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> 起動時に <code>gpg-agent</code> が起動していない状況もありうる。
そこで， Windows ログイン時に <code>gpg-connect-agent</code> を使って <code>gpg-agent</code> を起動しておくことをお薦めする。</p>
<h3>SSH 鍵のインポート</h3>
<p>SSH 鍵のインポートには2通りの方法あるようだが，今回は簡単な方でいく<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>。</p>
<p>鍵ファイル（ここでは <code>id_rsa.PPK</code> とする）を Pageant で開く。
ファイルの関連付けがされている場合はエクスプローラから該当の PPK ファイルをダブルクリックすればいい。
そうでない場合は以下のコマンドで PPK ファイルを開く。</p>
<pre tabindex="0"><code>$ pageant.exe id_rsa.PPK
</code></pre><p>すると Pageant のプロンプトが1回， <code>gpg-agent</code> のプロンプトが2回表示され，都合3回パスフレーズを入力させられる。</p>
<figure style='margin:0 auto;text-align:center;'><a href="https://photo.baldanders.info/flickr/25558118892/"><img src="https://photo.baldanders.info/flickr/image/25558118892_m.png" srcset="https://photo.baldanders.info/flickr/image/25558118892_m.png 500w" sizes="(min-width:600px) 500px, 80vw" alt="Pagent" loading="lazy"></a><figcaption><div><a href="https://photo.baldanders.info/flickr/25558118892/">Pagent</a></div></figcaption>
</figure>
<figure style='margin:0 auto;text-align:center;'><a href="https://photo.baldanders.info/flickr/25558116832/"><img src="https://photo.baldanders.info/flickr/image/25558116832_m.png" srcset="https://photo.baldanders.info/flickr/image/25558116832_m.png 500w" sizes="(min-width:600px) 500px, 80vw" alt="GnuPG Pinentry (1)" loading="lazy"></a><figcaption><div><a href="https://photo.baldanders.info/flickr/25558116832/">GnuPG Pinentry (1)</a></div></figcaption>
</figure>
<figure style='margin:0 auto;text-align:center;'><a href="https://photo.baldanders.info/flickr/25376004580/"><img src="https://photo.baldanders.info/flickr/image/25376004580_m.png" srcset="https://photo.baldanders.info/flickr/image/25376004580_m.png 500w" sizes="(min-width:600px) 500px, 80vw" alt="GnuPG Pinentry (2)" loading="lazy"></a><figcaption><div><a href="https://photo.baldanders.info/flickr/25376004580/">GnuPG Pinentry (2)</a></div></figcaption>
</figure>
<p>これで秘密鍵が <code>private-keys-v1.d</code> フォルダに格納される。
また <code>sshcontrol</code> ファイルが作成され，インポートした鍵の情報が書き込まれる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"># List of allowed ssh keys.  Only keys present in this file are used
</span></span><span class="line"><span class="cl"># in the SSH protocol.  The ssh-add tool may add new entries to this
</span></span><span class="line"><span class="cl"># file to enable them; you may also add them manually.  Comment
</span></span><span class="line"><span class="cl"># lines, like this one, as well as empty lines are ignored.  Lines do
</span></span><span class="line"><span class="cl"># have a certain length limit but this is not serious limitation as
</span></span><span class="line"><span class="cl"># the format of the entries is fixed and checked by gpg-agent. A
</span></span><span class="line"><span class="cl"># non-comment line starts with optional white spaces, followed by the
</span></span><span class="line"><span class="cl"># keygrip of the key given as 40 hex digits, optionally followed by a
</span></span><span class="line"><span class="cl"># caching TTL in seconds, and another optional field for arbitrary
</span></span><span class="line"><span class="cl"># flags.   Prepend the keygrip with an &#39;!&#39; mark to disable it.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># RSA key added on: 2016-03-10 21:24:32
</span></span><span class="line"><span class="cl"># MD5 Fingerprint:  56:ff:fd:60:38:a1:7a:44:0c:37:86:90:94:8d:7f:6a
</span></span><span class="line"><span class="cl">F65BB98767E88930612C6EABC4D4918E2A573903 0
</span></span></code></pre></div><p>この <code>F65B...</code> の長ったらしい数字列は keygrip と呼ばれる鍵の識別子で <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の鍵 ID とは異なるもののようだ<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>。</p>
<p>これで鍵のインポートができたので <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> で実際に SSH 接続してみると</p>
<figure style='margin:0 auto;text-align:center;'><a href="https://photo.baldanders.info/flickr/25585468551/"><img src="https://photo.baldanders.info/flickr/image/25585468551_m.png" srcset="https://photo.baldanders.info/flickr/image/25585468551_m.png 500w" sizes="(min-width:600px) 500px, 80vw" alt="GnuPG Pinentry (3)" loading="lazy"></a><figcaption><div><a href="https://photo.baldanders.info/flickr/25585468551/">GnuPG Pinentry (3)</a></div></figcaption>
</figure>
<p>とプロンプトが表示された。
めでたし！</p>
<h3><a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> との連携</h3>
<p><a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> と <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> を連携するには，環境変数 <code>GIT_SSH</code> に Plink へのフルパスをセットする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">setx GIT_SSH=C:\path\to\PuTTY\plink.exe
</span></span></code></pre></div><p>ただし，最近の <a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> ではインストール時の SSH 接続設定で <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> を使うよう指定すれば自動的に環境変数をセットしてくれるので，手動で設定する必要はないと思われる。</p>
<h2>Windows 版 gpg-agent は <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> と相性が悪い？</h2>
<p><code>gpg-agent</code> は <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> の <code>ssh-agent</code> と置き換えることもできる<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>。
<code>gpg-agent</code> への SSH 鍵のインポートには <code>ssh-add</code> を使うのだが， Windows 環境では上手く動かない。
どうやらファイル・ディスクリプタ <code>S.gpg-agent.ssh</code> が上手く機能しないようだ。</p>
<p><a href="http://msys2.github.io/" title="MSYS2 installer">MSYS2</a> 版<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup> と <a href="https://github.com/PowerShell/Win32-OpenSSH" title="PowerShell/Win32-OpenSSH: Win32 port of OpenSSH">PowerShell 用</a>の <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> で試してみたのだが，いずれも上手くいかなかった。
<a href="http://msys2.github.io/" title="MSYS2 installer">MSYS2</a> 版については <a href="http://msys2.github.io/" title="MSYS2 installer">MSYS2</a> の <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> を使えば上手くいくのかもしれないが，面倒なので試してない。</p>
<h3>ssh-pageant 経由で <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> と連携できる！</h3>
<p>フィードバックで教えていただいたのだが <code>ssh-pageant</code> というツールがあって，これを経由して <code>gpg-agent</code> と <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> を繋げられるようだ。</p>
<ul>
<li><a href="https://github.com/cuviper/ssh-pageant">GitHub - cuviper/ssh-pageant: An SSH authentication agent for Cygwin/MSYS to PuTTY&rsquo;s Pageant.</a></li>
</ul>
<p><code>ssh-pageant</code> は最近の <a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> には同梱されている。
<code>ssh-pageant</code> が常駐している状態では， <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> からは <code>ssh-agent</code> が起動しているように見える。
一方， <code>gpg-agent</code> には <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> から要求があるように見える。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  OpenSSH-- request key -->ssh-pageant
  ssh-pageant-- store key -->OpenSSH
  ssh-pageant-- request key -->gpg-agent
  gpg-agent-- store key -->ssh-pageant
</div></figure>
<p>この方法の利点は， <code>enable-putty-support</code> オプションを有効にしておけば， <code>gpg-agent</code> は <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> とも <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> とも全く等価にアクセスできる点だろう。
欠点は，結局のところ <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> は手放せないということだろうか（だって bash 以外の環境では今まで通りだし）。
<a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> に関しては&hellip; もう Plink での接続でいいんじゃないかな。</p>
<p>まぁ Windows だしね。</p>
<p><code>ssh-pageant</code> の起動は bash から以下のコマンドを起動する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ eval $(/usr/bin/ssh-pageant -r -a &#34;/tmp/.ssh-pageant-$USERNAME&#34;)
</span></span></code></pre></div><p><code>ssh-agent</code> と似たようなやりかただな。
<code>ssh-pageant</code> は完全に土管として機能するので，上のコマンドを <code>.bash_profile</code> か <code>.bashrc</code> に書いておいて bash 起動時に常駐させておけばいいだろう<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup>。</p>
<p><code>ssh-add</code> で鍵のインポートができるかどうかは試してないが（Pageant からインポートできてるし）， <code>ssh-add -l</code> ってやったらちゃんと鍵情報が取れたので，多分できるんじゃないかな？</p>
<h2>参考になる（かもしれない） Web ページ</h2>
<ul>
<li>
<p><a href="http://hp.vector.co.jp/authors/VA024651/PuTTYkj.html">hdk の自作ソフトの紹介 | PuTTYjp</a></p>
</li>
<li>
<p><a href="http://ice.hotmint.com/putty/">iceiv+putty</a></p>
</li>
<li>
<p><a href="http://webkaru.net/linux/putty-ssh-login-public-key/">公開鍵認証によるSSH接続 - PuTTYの使い方 - Linux入門 - Webkaru</a></p>
</li>
<li>
<p><a href="http://qiita.com/tsuyoshi_cho/items/79c09905ae3f192b3a0f">Windowsでのssh agent - Qiita</a></p>
</li>
<li>
<p><a href="https://developers.yubico.com/PGP/SSH_authentication/Windows.html">SSH authentication using a YubiKey on Windows</a></p>
</li>
<li>
<p><a href="http://yanor.net/wiki/?Git%2FGit%20for%20Windows%2FSSH%E3%81%ABPuTTY%E3%82%92%E4%BD%BF%E3%81%86">Git/Git for Windows/SSHにPuTTYを使う - yanor.net/wiki</a></p>
</li>
<li>
<p><a href="https://superuser.com/questions/911496/gpg-agent-under-windows-as-ssh-agent-for-git-bash">GPG Agent under Windows as SSH Agent for  - Super User</a></p>
</li>
<li>
<p><a href="http://incenp.org/notes/2015/gnupg-for-ssh-authentication.html">Using GnuPG (2.1) for SSH authentication</a></p>
</li>
<li>
<p><a href="http://www.sysmic.org/dotclear/index.php?post/2010/03/24/Convert-keys-betweens-GnuPG%2C-OpenSsh-and-OpenSSL">Convert keys between GnuPG, OpenSsh and OpenSSL - Sysmic.org</a></p>
</li>
<li>
<p><a href="https://qiita.com/jkr_2255/items/f1ebd3fa4a9bf8ee1b03">Git for WindowsのシェルからPageantでSSH - Qiita</a></p>
</li>
<li>
<p><a href="https://qiita.com/tsuyoshi_cho/items/79c09905ae3f192b3a0f">Windowsでのssh agent - Qiita</a></p>
</li>
<li>
<p><a href="https://mattn.kaoriya.net/software/20081106192615.htm">Big Sky :: Windowsでもssh-agentとssh-addを使ってパスフレーズ入力を省略する。</a></p>
</li>
<li>
<p><a href="https://lechnology.com/software/keeagent/">KeeAgent – lechnology.com</a> : パスワード管理ツール <a href="https://keepass.info/" title="KeePass Password Safe">KeePass</a> のプラグインで， <a href="https://keepass.info/" title="KeePass Password Safe">KeePass</a> のパスワードデータベースを使って SSH 鍵を管理し Agent 機能で SSH に鍵を渡す仕組みらしい。  <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/" title="PuTTY: a free SSH and Telnet client">PuTTY</a> と <a href="http://www.openssh.com/" title="OpenSSH">OpenSSH</a> に対応しているようだ</p>
</li>
<li>
<p><a href="https://opensource.com/article/19/4/gpg-subkeys-ssh">How to enable SSH access using a GPG key for authentication | Opensource.com</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/remark/2019/04/move-gpg-keyring/">Windows 環境で作った GnuPG の鍵束を Ubuntu に移行する</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/openpgp/gpg-agent-in-ubuntu/">gpg-agent の設定： GnuPG in Ubuntu</a></p>
</li>
</ul>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://text.baldanders.info/openpgp/using-gnupg-for-windows-1/" title="GnuPG for Windows インストール編">前回</a>も書いたが， classic version と現行バージョンでは鍵（特に秘密鍵）の管理の仕方が異なるため両者を混在させる場合は注意が必要である。 Classic version で作成した鍵を現行バージョンにも反映させたいのであれば <code>gpg-v21-migrated</code> ファイルを削除すると再度移行処理が走るらしい。 Classic version を使わなければならない状況（Linux などではパッケージ管理ツールがアプリケーションの証明用に <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の classic version を使うことがある）でないのなら現行バージョンに一本化するほうがお勧めである。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>現行バージョンでは <code>gpg-agent</code> が必須である。したがって，かつての <code>--use-agent</code>, <code>--no-use-agent</code>, <code>--gpg-agent-info</code> 各オプションは無効（ダミーオプション）になっている。また UNIX 互換プラットフォームで <code>gpg-agent</code> 利用する際は <code>GPG_AGENT_INFO</code> 環境変数でソケットを指定する必要があるが， Windows では不要なためここでは割愛する。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>パスワード（password）とパスフレーズ（passphrase）の違いは，パスフレーズでは英数字以外に空白文字や記号が使え文字数の制限がないことにある。ちなみに <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の秘密鍵にはいかなる形でもパスフレーズを保持しない（S2K パラメータ情報は持っている）。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Windows では， <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> ホームディレクトリの既定は <code>%APPDATA%\gnupg</code> となっている。これを変更するには <code>GNUPGHOME</code> 環境変数または <code>--homedir</code> オプションを使う。（<a href="https://text.baldanders.info/openpgp/using-gnupg-for-windows-1/" title="GnuPG for Windows インストール編">前回</a>を参照のこと）&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>今回は PPK ファイルを直接読み込む方法をとったが， PPK ファイルから OpenSSH 形式にエクスポートし，それを更に X.509 形式に変換した後 <code>gpgsm</code> でインポートすることもできるらしい。（参考： <a href="http://www.sysmic.org/dotclear/index.php?post/2010/03/24/Convert-keys-betweens-GnuPG%2C-OpenSsh-and-OpenSSL">Convert keys between GnuPG, OpenSsh and OpenSSL</a>）&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵以外の鍵にも対応するためらしい。 <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵の keygrip は <code>--with-keygrip</code> オプションを付けて鍵を表示すると見ることができる。ちなみに <code>private-keys-v1.d</code> フォルダにある秘密鍵のファイルは，この keygrip 値がそのままファイル名になっている。&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p><code>gpg-agent.conf</code> ファイルに <code>enable-ssh-support</code> オプションをセットする。&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> に同梱されている bash も <a href="http://msys2.github.io/" title="MSYS2 installer">MSYS2</a> である。&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p>うちの <a href="https://git-for-windows.github.io/" title="Git for Windows">Git for Windows</a> 付属の bash では何故か <code>.bash_profile</code> を読んでくれない。ので <code>.bashrc</code> に書いている。&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/openpgp/using-gnupg-for-windows-1/">GnuPG for Windows インストール編</a></div>
<div class="next-page"><a href="/openpgp/gnupg-cheat-sheet/">GnuPG チートシート（鍵作成から失効まで）</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Mastodon などの SNS や電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2017-12-01</time> (revised in 2021-01-10)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a rel="me" href="https://github.com/spiegel-im-spiegel"><span class="github-color"><abbr title="GitHub"><i class="fab fa-github"></i></abbr></span></a></li><li><a rel="me" href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><abbr title="Flickr"><i class="fab fa-flickr"></i></abbr></span></a></li><li><a rel="me" href="https://goark.fedicity.net/@spiegel"><span class="mastodon-color"><abbr title="Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a></li><li><a rel="me" href="https://bsky.app/profile/baldanders.info"><span class="bluesky-color"><abbr title="Bluesky"><i class="fa-brands fa-bluesky"></i></abbr></span></a></li><li><a rel="me" href="https://www.strava.com/athletes/122077389"><span class="strava-color"><abbr title="Strava"><i class="fa-brands fa-strava"></i></abbr></span></a></li><li><a rel="me" href="https://x.com/spiegel_2007"><span class="twitter-color"><abbr title="X (Twitter)"><i class="fab fa-twitter"></i></abbr></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fusing-gnupg-for-windows-2%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.150.0</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({startOnLoad: true, fontFamily: "sans-serif", theme: 'dark', sequence: {height: 40, mirrorActors: false}});
</script>
</body>
</html>
