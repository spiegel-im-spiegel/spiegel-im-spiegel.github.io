<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.100.1" />
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/openpgp/openpgp-key-management/">
<script src="//kit.fontawesome.com/152e339e63.js"></script>
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Inconsolata%3a500,700%7cNoto+Sans+JP%3a500,700%7cNoto+Sans%3a500,700%7cNoto+Serif%7cNoto+Serif+JP%7cNoto+Emoji&display=swap" type='text/css'>
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<title>OpenPGP 鍵管理に関する考察 | text.Baldanders.info</title>
<meta property="og:title" content="OpenPGP 鍵管理に関する考察">
<meta name="description" content="OpenPGP 鍵の管理について考えてみるテスト。">
<meta property="og:description" content="OpenPGP 鍵の管理について考えてみるテスト。">
<meta property="og:image" content="https://text.baldanders.info/images/attention/openpgp.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@spiegel_2007">
<meta name="twitter:creator" content="@spiegel_2007">
<meta name="keywords" content="cryptography, openpgp, management, pki, trust, gnupg">
<link rel='prev' href='https://text.baldanders.info/openpgp/git-commit-with-openpgp-signature/' title='Git Commit で OpenPGP 署名を行う' />
<link rel='next' href='https://text.baldanders.info/openpgp/issuer-fingerprint-signature-subpacket-in-next-openpgp/' title='Issuer Fingerprint Signature Subpacket in Next OpenPGP' />

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/openpgp/",
	"url": "https://text.baldanders.info/openpgp/",
	"inLanguage": "ja",
	"name": "OpenPGP の実装",
	"description": "OpenPGP とその実装である GnuPG 等に関する話題。",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/openpgp/openpgp-key-management/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/openpgp/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/openpgp/openpgp-key-management/",
	"url": "https://text.baldanders.info/openpgp/openpgp-key-management/",
	"mainEntityOfPage": "https://text.baldanders.info/openpgp/openpgp-key-management/",
	"inLanguage": "ja",
	"name": "OpenPGP 鍵管理に関する考察",
	"description": "OpenPGP 鍵の管理について考えてみるテスト。",
	"headline": "OpenPGP 鍵の管理について考えてみるテスト。",
	"keywords": "cryptography, openpgp, management, pki, trust, gnupg",
	"image": "https://text.baldanders.info/images/attention/openpgp.png",
	"datePublished": "2017-12-01T08:51:59+00:00",
	"dateModified": "2020-01-05T11:59:50+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/openpgp/">OpenPGP の実装</a>
</nav>
<article>
<h1>OpenPGP 鍵管理に関する考察</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/cryptography/">cryptography</a> #<a href="/tags/gnupg/">gnupg</a> #<a href="/tags/management/">management</a> #<a href="/tags/openpgp/">openpgp</a> #<a href="/tags/pki/">pki</a> #<a href="/tags/trust/">trust</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fas fa-share-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fopenpgp-key-management%2f&amp;title=OpenPGP%20%e9%8d%b5%e7%ae%a1%e7%90%86%e3%81%ab%e9%96%a2%e3%81%99%e3%82%8b%e8%80%83%e5%af%9f" target="_blank"><span class="pocket-color"><i class="fab fa-get-pocket" aria-hidden="true"></i></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fopenpgp-key-management%2f" target="_blank"><span class="facebook-color"><i class="fab fa-facebook-square" aria-hidden="true"></i></span></a>&nbsp;<a href="http://twitter.com/share?text=OpenPGP%20%e9%8d%b5%e7%ae%a1%e7%90%86%e3%81%ab%e9%96%a2%e3%81%99%e3%82%8b%e8%80%83%e5%af%9f+by+@spiegel_2007&amp;url=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fopenpgp-key-management%2f" target="_blank"><span class="twitter-color"><i class="fab fa-twitter-square" aria-hidden="true"></i></span></a></div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/openpgp/openpgp-key-management/index.html">GitHub Page</a>
</nav>

<section>
<p>たまたま以下の記事を見かけたのだが</p>
<ul>
<li><a href="https://qiita.com/moutend/items/5c22d6e57a74845578f6">gpg (GNU Privacy Guard)の使い方 - Qiita</a></li>
</ul>
<p>このやり方も良さそうだけど，もう少し簡単に運用できないか考えてみる。
なお <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の鍵管理は目的別にアドホック（ad hoc）な運用も可能なので「これ！」という正解はない。
自分にあったやり方を考えるのも面白いと思う。</p>
<h2><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の信用モデル</h2>
<p>鍵の管理について考える前に <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の信用モデルについておさらいしておこう。</p>
<p>最初の登場人物は Alice と Bob。
2人はそれぞれ <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵を持っていて，これを使って秘密のやり取りをしようと考えている。
持っている鍵が信用できることを証明するために，お互い相手の公開鍵に自身の鍵で電子署名を施した。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  Alice["Alice's Public Key"]
  Bob["Bob's Public Key"]

  Alice-- Digital Sign -->Bob
  Bob-- Digital Sign -->Alice
</div></figure>
<p>鍵に施されている電子署名を確認することでコンテンツに対する暗号文や電子署名が正しい鍵で行われていることが証明できるわけだ。
これが <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の基本。
公開鍵への電子署名を使って peer-to-peer で信用関係を結ぶ<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>ここで3人目の人物 Chris に登場してもらおう。
Bob と Chris は面識があり既にお互いの公開鍵で電子署名を交わしている。
しかし Alice と Chris は面識がなく電子署名を交わす機会がないとする。
Alice から見て Chris の鍵は信用できるだろうか？</p>
<p>（念のために言うと，ここで言う「信用」は「あなたは人として信用できる」の信用ではなく「この鍵は正しく本人のものであると信用できる」の信用である）</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  Alice["Alice's Public Key"]
  Bob["Bob's Public Key"]
  Chris["Chris's Public Key"]

  Alice-- Digital Sign -->Bob
  Alice-. trust? .->Chris
  Bob-- Digital Sign -->Alice
  Bob-- Digital Sign -->Chris
  Chris-- Digital Sign -->Bob
</div></figure>
<p>まず Alice から見て直接電子署名を交わした Bob の鍵が信用できるのは明らかである。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
 graph LR
   Alice["Alice's Public Key"]
   Bob["Bob's Public Key"]
   Chris["Chris's Public Key"]

   Alice-- Digital Sign -->Bob
   Alice-. trust .->Bob
   Bob-- Digital Sign -->Alice
   Bob-- Digital Sign -->Chris
   Chris-- Digital Sign -->Bob

</div></figure>
<p>Alice は Chris の公開鍵に信用できる Bob の公開鍵による電子署名を見つけたため， Bob の公開鍵と同じく Chris の公開鍵も有効であると見なすことができる。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  Alice["Alice's Public Key"]
  Bob["Bob's Public Key"]
  Chris["Chris's Public Key"]

  Alice-- Digital Sign -->Bob
  Alice-. validate! .->Chris
  Alice-. trust .->Bob
  Bob-- Digital Sign -->Alice
  Bob-- Digital Sign -->Chris
  Chris-- Digital Sign -->Bob
</div></figure>
<p>これが <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の代表的な信用モデル “web of trust” の基本的な考え方である<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。
このことから <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の鍵管理ににおいて「信用できる鍵」の条件は</p>
<ul>
<li>多くの電子署名（とできれば信用）が集まっていること</li>
</ul>
<p>だと分かる。
更にこのことから派生的に</p>
<ul>
<li>同じ鍵が永続的に使われ続けていること</li>
</ul>
<p>も「信用できる鍵」の条件となる。
何故なら，鍵が頻繁に変わるとその度に電子署名をやり直すことになり，鍵に署名（＝信用）が集まりにくくなるからである。</p>
<h2><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の鍵管理</h2>
<p>以上を踏まえて <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵の管理について考えてみよう。</p>
<h3>ひとつの鍵で運用する場合</h3>
<p>一番簡単なケースで，ひとつの <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵で全てをまかなう場合を考える。
たとえば，ふだん暗号化ツールなんて全然使わないけど git commit に電子署名するためだけに <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> を使いたい，など。</p>
<p><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の代表的な実装である <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> の最新バージョンでは，以下に示すように，鍵の作成処理が（昔と比べて）大幅に簡略化できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --batch --passphrase pass123 --quick-generate-key &#34;Alice &lt;alice@example.com&gt;&#34; default default 0
</span></span><span class="line"><span class="cl">gpg: 鍵02C94DC57527A786を究極的に信用するよう記録しました
</span></span><span class="line"><span class="cl">gpg: 失効証明書を &#39;C:/Users/alice/AppData/Roaming/gnupg/openpgp-revocs.d\9416E477EBA825CD1694573102C94DC57527A786.rev&#39; に保管しました。
</span></span></code></pre></div><ul>
<li><code>--batch</code> オプション<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>（または <code>--pinentry-mode</code> オプションに <code>loopback</code> を指定）と <code>--passphrase</code> オプションを組み合わせて Pinentry によるパスフレーズ入力を回避できる</li>
<li><code>--quick-generate-key</code> コマンドの第1引数にユーザID，第2引数にアルゴリズム，第3引数に使用目的，第4引数に有効期限を指定する
<ul>
<li>アルゴリズムに <code>default</code> を指定するか指定しない場合は既定のアルゴリズム（RSA/2048ビット）で鍵を作成する</li>
<li>使用目的には主鍵<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> の種類を指定する。通常は <code>default</code> のまま（署名と証明）でよい（指定しなければ <code>default</code>）</li>
<li>有効期限には期間（1週間なら <code>7d</code> または <code>1w</code>，1年なら <code>12m</code> または <code>1y</code> など）を指定する。 <code>0</code> を指定すると無期限になる（指定しないと有効期限が当日になる）</li>
</ul>
</li>
</ul>
<p>生成された鍵の状態は以下の通り。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      9416E477EBA825CD1694573102C94DC57527A786
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>作成した鍵の公開鍵を配布するには</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --export -a alice &gt; alice-key.asc
</span></span></code></pre></div><p>として <code>alice-key.asc</code> を直接配布するか</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --keyserver keys.gnupg.net --send-key alice
</span></span></code></pre></div><p>として鍵サーバ（ここでは <a href="http://keys.gnupg.net/"><code>keys.gnupg.net</code></a>）にアップロードすればいい。</p>
<p>注意する点としてはパスフレーズと失効証明書を紛失・漏洩しないよう管理することであろう。
できれば失効証明書は普段使う PC や携帯端末とは別に管理しておくのが望ましい。
ちなみに <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> ではパスフレーズは何処にも保存されないので，パスフレーズを忘れてしまうと全くリカバリできなくなる（だからといってパスフレーズを設定しないというのは通常運用ではあり得ないが）。</p>
<p>ノートPCや携帯端末には常に紛失・盗難のリスクが付きまとうが，予防に注力しすぎて現実的でない対策を執るよりも，これはもう「起こり得ること」として「事後」がスムーズに行われるようバックアップ等の準備しておくほうが賢明である。</p>
<h3>ひとつの鍵に複数のユーザIDを付与する場合</h3>
<p>ユーザIDというのは鍵の名前 “<code>Alice &lt;alice@examle.com&gt;</code>” の部分である。</p>
<p>たとえば，以下の鍵があったとき</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      B686F36CA9FDC10057EFC5D58D7E04B8CE947112
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>これに新しいユーザID “<code>Alice &lt;alice@examle2.com&gt;</code>” を付加するには <code>--quick-add-uid</code> コマンドを使って</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --quick-add-uid alice &#34;Alice &lt;alice@examle2.com&gt;&#34;
</span></span><span class="line"><span class="cl">$ gpg --update-trustdb
</span></span></code></pre></div><p>とする<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>。
これで新しいユーザIDが付加された。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      B686F36CA9FDC10057EFC5D58D7E04B8CE947112
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@examle2.com&gt;
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>ちなみに，この鍵を <a href="http://www.mew.org/~kazu/proj/pgpdump/" title="pgpdump">pgpdump</a> にかけると以下のようになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --export -a alice | pgpdump -u
</span></span><span class="line"><span class="cl">Old: Public Key Packet(tag 6)(269 bytes)
</span></span><span class="line"><span class="cl">        Ver 4 - new
</span></span><span class="line"><span class="cl">        Public key creation time - Thu Nov 23 06:22:56 UTC 2017
</span></span><span class="line"><span class="cl">        Pub alg - RSA Encrypt or Sign(pub 1)
</span></span><span class="line"><span class="cl">        RSA n(2048 bits) - ...
</span></span><span class="line"><span class="cl">        RSA e(17 bits) - ...
</span></span><span class="line"><span class="cl">Old: User ID Packet(tag 13)(25 bytes)
</span></span><span class="line"><span class="cl">        User ID - Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">Old: Signature Packet(tag 2)(334 bytes)
</span></span><span class="line"><span class="cl">        Ver 4 - new
</span></span><span class="line"><span class="cl">        Sig type - Positive certification of a User ID and Public Key packet(0x13).
</span></span><span class="line"><span class="cl">        Pub alg - RSA Encrypt or Sign(pub 1)
</span></span><span class="line"><span class="cl">        Hash alg - SHA256(hash 8)
</span></span><span class="line"><span class="cl">        Hashed Sub: issuer fingerprint(sub 33)(21 bytes)
</span></span><span class="line"><span class="cl">         v4 -   Fingerprint - b6 86 f3 6c a9 fd c1 00 57 ef c5 d5 8d 7e 04 b8 ce 94 71 12
</span></span><span class="line"><span class="cl">        Hashed Sub: signature creation time(sub 2)(4 bytes)
</span></span><span class="line"><span class="cl">                Time - Thu Nov 23 06:22:56 UTC 2017
</span></span><span class="line"><span class="cl">        Hashed Sub: key flags(sub 27)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - This key may be used to certify other keys
</span></span><span class="line"><span class="cl">                Flag - This key may be used to sign data
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred symmetric algorithms(sub 11)(4 bytes)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 256-bit key(sym 9)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 192-bit key(sym 8)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 128-bit key(sym 7)
</span></span><span class="line"><span class="cl">                Sym alg - Triple-DES(sym 2)
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred hash algorithms(sub 21)(5 bytes)
</span></span><span class="line"><span class="cl">                Hash alg - SHA256(hash 8)
</span></span><span class="line"><span class="cl">                Hash alg - SHA384(hash 9)
</span></span><span class="line"><span class="cl">                Hash alg - SHA512(hash 10)
</span></span><span class="line"><span class="cl">                Hash alg - SHA224(hash 11)
</span></span><span class="line"><span class="cl">                Hash alg - SHA1(hash 2)
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred compression algorithms(sub 22)(3 bytes)
</span></span><span class="line"><span class="cl">                Comp alg - ZLIB &lt;RFC1950&gt;(comp 2)
</span></span><span class="line"><span class="cl">                Comp alg - BZip2(comp 3)
</span></span><span class="line"><span class="cl">                Comp alg - ZIP &lt;RFC1951&gt;(comp 1)
</span></span><span class="line"><span class="cl">        Hashed Sub: features(sub 30)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - Modification detection (packets 18 and 19)
</span></span><span class="line"><span class="cl">        Hashed Sub: key server preferences(sub 23)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - No-modify
</span></span><span class="line"><span class="cl">        Sub: issuer key ID(sub 16)(8 bytes)
</span></span><span class="line"><span class="cl">                Key ID - 0x8D7E04B8CE947112
</span></span><span class="line"><span class="cl">        Hash left 2 bytes - 05 21
</span></span><span class="line"><span class="cl">        RSA m^d mod n(2047 bits) - ...
</span></span><span class="line"><span class="cl">                -&gt; PKCS-1
</span></span><span class="line"><span class="cl">Old: User ID Packet(tag 13)(25 bytes)
</span></span><span class="line"><span class="cl">        User ID - Alice &lt;alice@examle2.com&gt;
</span></span><span class="line"><span class="cl">Old: Signature Packet(tag 2)(334 bytes)
</span></span><span class="line"><span class="cl">        Ver 4 - new
</span></span><span class="line"><span class="cl">        Sig type - Positive certification of a User ID and Public Key packet(0x13).
</span></span><span class="line"><span class="cl">        Pub alg - RSA Encrypt or Sign(pub 1)
</span></span><span class="line"><span class="cl">        Hash alg - SHA256(hash 8)
</span></span><span class="line"><span class="cl">        Hashed Sub: issuer fingerprint(sub 33)(21 bytes)
</span></span><span class="line"><span class="cl">         v4 -   Fingerprint - b6 86 f3 6c a9 fd c1 00 57 ef c5 d5 8d 7e 04 b8 ce 94 71 12
</span></span><span class="line"><span class="cl">        Hashed Sub: signature creation time(sub 2)(4 bytes)
</span></span><span class="line"><span class="cl">                Time - Thu Nov 23 06:33:28 UTC 2017
</span></span><span class="line"><span class="cl">        Hashed Sub: key flags(sub 27)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - This key may be used to certify other keys
</span></span><span class="line"><span class="cl">                Flag - This key may be used to sign data
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred symmetric algorithms(sub 11)(4 bytes)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 256-bit key(sym 9)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 192-bit key(sym 8)
</span></span><span class="line"><span class="cl">                Sym alg - AES with 128-bit key(sym 7)
</span></span><span class="line"><span class="cl">                Sym alg - Triple-DES(sym 2)
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred hash algorithms(sub 21)(5 bytes)
</span></span><span class="line"><span class="cl">                Hash alg - SHA256(hash 8)
</span></span><span class="line"><span class="cl">                Hash alg - SHA384(hash 9)
</span></span><span class="line"><span class="cl">                Hash alg - SHA512(hash 10)
</span></span><span class="line"><span class="cl">                Hash alg - SHA224(hash 11)
</span></span><span class="line"><span class="cl">                Hash alg - SHA1(hash 2)
</span></span><span class="line"><span class="cl">        Hashed Sub: preferred compression algorithms(sub 22)(3 bytes)
</span></span><span class="line"><span class="cl">                Comp alg - ZLIB &lt;RFC1950&gt;(comp 2)
</span></span><span class="line"><span class="cl">                Comp alg - BZip2(comp 3)
</span></span><span class="line"><span class="cl">                Comp alg - ZIP &lt;RFC1951&gt;(comp 1)
</span></span><span class="line"><span class="cl">        Hashed Sub: features(sub 30)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - Modification detection (packets 18 and 19)
</span></span><span class="line"><span class="cl">        Hashed Sub: key server preferences(sub 23)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - No-modify
</span></span><span class="line"><span class="cl">        Sub: issuer key ID(sub 16)(8 bytes)
</span></span><span class="line"><span class="cl">                Key ID - 0x8D7E04B8CE947112
</span></span><span class="line"><span class="cl">        Hash left 2 bytes - 7d 5a
</span></span><span class="line"><span class="cl">        RSA m^d mod n(2048 bits) - ...
</span></span><span class="line"><span class="cl">                -&gt; PKCS-1
</span></span><span class="line"><span class="cl">Old: Public Subkey Packet(tag 14)(269 bytes)
</span></span><span class="line"><span class="cl">        Ver 4 - new
</span></span><span class="line"><span class="cl">        Public key creation time - Thu Nov 23 06:22:56 UTC 2017
</span></span><span class="line"><span class="cl">        Pub alg - RSA Encrypt or Sign(pub 1)
</span></span><span class="line"><span class="cl">        RSA n(2048 bits) - ...
</span></span><span class="line"><span class="cl">        RSA e(17 bits) - ...
</span></span><span class="line"><span class="cl">Old: Signature Packet(tag 2)(310 bytes)
</span></span><span class="line"><span class="cl">        Ver 4 - new
</span></span><span class="line"><span class="cl">        Sig type - Subkey Binding Signature(0x18).
</span></span><span class="line"><span class="cl">        Pub alg - RSA Encrypt or Sign(pub 1)
</span></span><span class="line"><span class="cl">        Hash alg - SHA256(hash 8)
</span></span><span class="line"><span class="cl">        Hashed Sub: issuer fingerprint(sub 33)(21 bytes)
</span></span><span class="line"><span class="cl">         v4 -   Fingerprint - b6 86 f3 6c a9 fd c1 00 57 ef c5 d5 8d 7e 04 b8 ce 94 71 12
</span></span><span class="line"><span class="cl">        Hashed Sub: signature creation time(sub 2)(4 bytes)
</span></span><span class="line"><span class="cl">                Time - Thu Nov 23 06:22:56 UTC 2017
</span></span><span class="line"><span class="cl">        Hashed Sub: key flags(sub 27)(1 bytes)
</span></span><span class="line"><span class="cl">                Flag - This key may be used to encrypt communications
</span></span><span class="line"><span class="cl">                Flag - This key may be used to encrypt storage
</span></span><span class="line"><span class="cl">        Sub: issuer key ID(sub 16)(8 bytes)
</span></span><span class="line"><span class="cl">                Key ID - 0x8D7E04B8CE947112
</span></span><span class="line"><span class="cl">        Hash left 2 bytes - 3a a7
</span></span><span class="line"><span class="cl">        RSA m^d mod n(2047 bits) - ...
</span></span><span class="line"><span class="cl">                -&gt; PKCS-1
</span></span></code></pre></div><p>ユーザID毎に電子署名（自己署名）が付与されているのがお分かりだろうか。</p>
<p>ひとつの鍵に複数のユーザIDを付与することに関しては昔から賛否あるのだが，手段が提供されていることは覚えておいて損はないだろう。</p>
<h3>用途によって鍵を使い分けたい場合</h3>
<p>たとえば，暗号化メール，リリースファイルの電子署名， git commit 時の電子署名といった用途毎に異なる鍵を使いたいことがある。
その場合でもそれぞれ鍵を生成して運用すればいいのだが，新しい鍵を作る度にそれぞれの鍵とやり取りを行うユーザが毎度電子署名を行うのは相当に煩雑な作業である。</p>
<p>そこで「ルート鍵」と「運用鍵」の2種類の鍵を作って運用する。
具体的にはルート鍵と各運用鍵との間で電子署名を交わす。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  rt[Root Key]-- Digital Sign -->op1[Operation Key 1]
  op1-- Digital Sign -->rt

  rt-- Digital Sign -->op2[Operation Key 2]
  op2-- Digital Sign -->rt
</div></figure>
<p>運用鍵とやり取りするユーザは，各運用鍵ではなく，ルート鍵と署名を交わし信用度を設定することによって各運用鍵の有効性を確認できる。</p>
<figure style='margin:0 auto;text-align:center;'>
<div class="mermaid">
graph LR
  usr[User's Key]
  rt[Root Key]
  op1[Operation Key 1]
  op2[Operation Key 2]

  usr-- Digital Sign -->rt
  usr-. trust .->rt
  rt-- Digital Sign -->usr

  usr-. validate .->op1
  rt-- Digital Sign -->op1

  rt-- Digital Sign -->op2
  usr-. validate .->op2

</div></figure>
<p>この方法ならユーザも各運用鍵もルート鍵とのみ信用関係を構築すればいいので柔軟な運用が可能になる。
欠点としてはルート鍵の管理が煩雑になりがちで信用に関する責務も重くなるため，かなり慎重な運用が求められることであろう。</p>
<h4>Alice のルート鍵と運用鍵</h4>
<p>では実際にやってみよう。</p>
<p>まず Alice がルート鍵と運用鍵の運用を行うとする。
ルート鍵は電子署名を行うだけの鍵なので，以下のように署名専用鍵として作成する（アルゴリズムは DSA/3072ビット にしてみた）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --batch --passphrase pass123 --quick-generate-key &#34;Alice (root) &lt;alice@example.com&gt;&#34; dsa3072 default 0
</span></span><span class="line"><span class="cl">gpg: *警告*: いくつかのOpenPGPプログラムはこのダイジェスト長のDSA鍵を扱うことができません
</span></span><span class="line"><span class="cl">gpg: 鍵B965D53DB907EF0Eを究極的に信用するよう記録しました
</span></span><span class="line"><span class="cl">gpg: 失効証明書を &#39;C:/Users/spiegel/AppData/Roaming/gnupg/openpgp-revocs.d\3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E.rev&#39; に保管しました。
</span></span></code></pre></div><p>もうひとつ。
運用鍵も作っておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --batch --passphrase pass123 --quick-generate-key &#34;Alice (commit) &lt;alice@example.com&gt;&#34; default default 0
</span></span><span class="line"><span class="cl">gpg: 鍵DFFC3F67BBB3C083を究極的に信用するよう記録しました
</span></span><span class="line"><span class="cl">gpg: 失効証明書を &#39;C:/Users/spiegel/AppData/Roaming/gnupg/openpgp-revocs.d\A3CEFEEEDA222024F325C403DFFC3F67BBB3C083.rev&#39; に保管しました。
</span></span></code></pre></div><p>この2つの鍵でお互いに電子署名を交わす（パスフレースの入力あり）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg -u 3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E --quick-sign-key A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sec  rsa2048/DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">     作成: 2017-11-23  有効期限: 無期限      利用法: SC
</span></span><span class="line"><span class="cl">     信用: 究極          有効性: 究極
</span></span><span class="line"><span class="cl">  主鍵フィンガープリント: A3CE FEEE DA22 2024 F325  C403 DFFC 3F67 BBB3 C083
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg -u A3CEFEEEDA222024F325C403DFFC3F67BBB3C083 --quick-sign-key 3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sec  dsa3072/B965D53DB907EF0E
</span></span><span class="line"><span class="cl">     作成: 2017-11-23  有効期限: 無期限      利用法: SC
</span></span><span class="line"><span class="cl">     信用: 究極          有効性: 究極
</span></span><span class="line"><span class="cl">  主鍵フィンガープリント: 3F8E FC47 7F9D 4D49 AA6C  308F B965 D53D B907 EF0E
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Alice (root) &lt;alice@example.com&gt;
</span></span></code></pre></div><p>これで Alice の2つの鍵の署名状態はこんな感じになった。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-sigs alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice (root) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sig 3        B965D53DB907EF0E 2017-11-23  Alice (root) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sig          DFFC3F67BBB3C083 2017-11-23  Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sig 3        DFFC3F67BBB3C083 2017-11-23  Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sig          B965D53DB907EF0E 2017-11-23  Alice (root) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span><span class="line"><span class="cl">sig          DFFC3F67BBB3C083 2017-11-23  Alice (commit) &lt;alice@example.com&gt;
</span></span></code></pre></div><p>一方の主鍵に他方の鍵の電子署名が付与されているのが分かるだろうか。</p>
<h4>Bob 鍵で Alice のルート鍵に電子署名する</h4>
<p>今度は Bob の側である。
まずは Bob の公開鍵をこんな感じで作ってみた（作成操作は省略）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys bob
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      B4E708652A1E81445B328A3D93F496726CBE8335
</span></span><span class="line"><span class="cl">uid           [  究極  ] Bob &lt;bob@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>この環境に先程の Alice の公開鍵をインポートしてみる。
まずはルート鍵から。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --import alice-root.asc
</span></span><span class="line"><span class="cl">gpg: key B965D53DB907EF0E: 鍵がないため1個の署名は検査しません
</span></span><span class="line"><span class="cl">gpg: 鍵B965D53DB907EF0E: 公開鍵&#34;Alice (root) &lt;alice@example.com&gt;&#34;をインポートしました
</span></span><span class="line"><span class="cl">gpg:           処理数の合計: 1
</span></span><span class="line"><span class="cl">gpg:             インポート: 1
</span></span><span class="line"><span class="cl">gpg: marginals needed: 3  completes needed: 1  trust model: pgp
</span></span><span class="line"><span class="cl">gpg: 深さ: 0  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 0f, 1u
</span></span></code></pre></div><p>当然ながら，この時点では読み込んだルート鍵の有効性は不明である。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">uid           [  不明  ] Alice (root) &lt;alice@example.com&gt;
</span></span></code></pre></div><p>では，ルート鍵に Bob の鍵で署名しよう<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>（パスフレースの入力あり）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --quick-sign-key 3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub  dsa3072/B965D53DB907EF0E
</span></span><span class="line"><span class="cl">     作成: 2017-11-23  有効期限: 無期限      利用法: SC
</span></span><span class="line"><span class="cl">     信用: 不明の        有効性: 不明の
</span></span><span class="line"><span class="cl">  主鍵フィンガープリント: 3F8E FC47 7F9D 4D49 AA6C  308F B965 D53D B907 EF0E
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Alice (root) &lt;alice@example.com&gt;
</span></span></code></pre></div><p>これでルート鍵の有効性は「充分」になった。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">uid           [  充分  ] Alice (root) &lt;alice@example.com&gt;
</span></span></code></pre></div><p>さらに信用データベースを更新して信用度も設定する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --update-trustdb
</span></span><span class="line"><span class="cl">gpg: marginals needed: 3  completes needed: 1  trust model: pgp
</span></span><span class="line"><span class="cl">gpg: 深さ: 0  有効性:   1  署名:   1  信用: 0-, 0q, 0n, 0m, 0f, 1u
</span></span><span class="line"><span class="cl">信用度が指定されていません:
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      &#34;Alice (root) &lt;alice@example.com&gt;&#34;
</span></span><span class="line"><span class="cl">  主鍵フィンガープリント: 3F8E FC47 7F9D 4D49 AA6C  308F B965 D53D B907 EF0E
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">他のユーザの鍵を正しく検証するために、このユーザの信用度を決めてください
</span></span><span class="line"><span class="cl">(パスポートを見せてもらったり、他から得たフィンガープリントを検査したり、などなど)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  1 = 知らない、または何とも言えない
</span></span><span class="line"><span class="cl">  2 = 信用し ない
</span></span><span class="line"><span class="cl">  3 = まぁまぁ信用する
</span></span><span class="line"><span class="cl">  4 = 充分に信用する
</span></span><span class="line"><span class="cl">  s = この鍵はとばす
</span></span><span class="line"><span class="cl">  q = 終了
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">あなたの決定は? 4
</span></span><span class="line"><span class="cl">gpg: 深さ: 1  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 1f, 0u
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span></code></pre></div><p>ここでは「充分に信用する」を選択した。</p>
<p>次に運用鍵もインポートする（操作は同じなので省略）。
この時点で Alice の公開鍵の状態を見ると</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">uid           [  充分  ] Alice (root) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">uid           [  充分  ] Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>運用鍵の有効性も既に「充分」になっていることが分かると思う。
ちなみにルート鍵の信用度を「まぁまぁ信用する」にすると</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   dsa3072 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      3F8EFC477F9D4D49AA6C308FB965D53DB907EF0E
</span></span><span class="line"><span class="cl">uid           [  充分  ] Alice (root) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">uid           [まぁまぁ] Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span></code></pre></div><p>運用鍵の有効性が「まぁまぁ」になる。</p>
<p>独りでこうした運用をやるメリットは殆どないが，プロジェクト・チーム等で一括して鍵管理を行いたい場合は有効な手段だと思う。</p>
<h2>有効期限について</h2>
<p>この記事ではすべての鍵を「無期限」で設定している。
公開鍵の有効期限をどのようにするかは意見が別れるところだと思うが，私個人としては原則として「無期限」にすることをお薦めする。
何故なら <a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵は永続性と一貫性が重要だからである。</p>
<p>公開鍵に有効期限を設ける理由としては</p>
<ul>
<li>期間の決まったプロジェクト内でのみ使用する鍵である</li>
<li>チーム・メンバの出入りが激しく無期限では却って管理が煩雑になる</li>
<li>鍵のセキュリティ強度の問題から期限を切って運用したい（たとえば RSA/2048ビット鍵が acceptable なのは2030年までである）</li>
</ul>
<p>といったところだろうか。
これならば，これまで述べたようにルート鍵と運用鍵を分けて，ルート鍵の方で永続性と一貫性を担保するように運用していくのがよいだろう。</p>
<p>自分の鍵であれば有効期限はいつでも変更できる（変更時にパスフレーズ入力あり）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --quick-set-expire A3CEFEEEDA222024F325C403DFFC3F67BBB3C083 2y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gpg --list-keys A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC] [有効期限: 2019-11-23]
</span></span><span class="line"><span class="cl">      A3CEFEEEDA222024F325C403DFFC3F67BBB3C083
</span></span><span class="line"><span class="cl">uid           [  究極  ] Alice (commit) &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2017-11-23 [E] [有効期限: 2019-11-23]
</span></span></code></pre></div><p>しかし，有効期限を随時延長していく運用は鍵のオーナーもそれを使うユーザも手間が増えるだけであまりメリットがない<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>。
<a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> 鍵は（今のところ）利用するユーザに公開鍵の変更を自動的に通知・配信する仕組みがないので（それとも cron で鍵サーバへアクセスする？），ユーザ側の手間の多い運用では取りこぼしが出る可能性が大きくなる。</p>
<h2>鍵を失効させる</h2>
<p>秘密鍵が漏洩するなどして鍵の失効が必要になった場合には，鍵作成時に作られた失効証明書を使って失効させる<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>。
鍵作成時に作られた失効証明書の中身はこんな感じになっている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ cd C:/Users/alice/AppData/Roaming/gnupg/openpgp-revocs.d
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat 9416E477EBA825CD1694573102C94DC57527A786.rev
</span></span><span class="line"><span class="cl">これは失効証明書でこちらのOpenPGP鍵に対するものです:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC]
</span></span><span class="line"><span class="cl">      9416E477EBA825CD1694573102C94DC57527A786
</span></span><span class="line"><span class="cl">uid          Alice &lt;alice@example.com&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">失効証明書は &#34;殺すスイッチ&#34; のようなもので、鍵がそれ以上使えない
</span></span><span class="line"><span class="cl">ように公に宣言するものです。一度発行されると、そのような失効証明書は
</span></span><span class="line"><span class="cl">撤回することはできません。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">秘密鍵のコンプロマイズや紛失の場合、これを使ってこの鍵を失効させます。
</span></span><span class="line"><span class="cl">しかし、秘密鍵がまだアクセス可能である場合、新しい失効証明書を生成し、
</span></span><span class="line"><span class="cl">失効の理由をつける方がよいでしょう。詳細は、GnuPGマニュアルのgpgコマン
</span></span><span class="line"><span class="cl">ド &#34;--generate-revocation&#34;の記述をご覧ください。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">このファイルを誤って使うのを避けるため、以下ではコロンが5つのダッシュ
</span></span><span class="line"><span class="cl">の前に挿入されます。この失効証明書をインポートして公開する前に、テク
</span></span><span class="line"><span class="cl">スト・エディタでこのコロンを削除してください。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">:-----BEGIN PGP PUBLIC KEY BLOCK-----
</span></span><span class="line"><span class="cl">Comment: This is a revocation certificate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">iQE2BCABCAAgFiEElBbkd+uoJc0WlFcxAslNxXUnp4YFAloWYkcCHQAACgkQAslN
</span></span><span class="line"><span class="cl">xXUnp4aG1wf/XoyxQPks2JlJ93ghQALdqCIxFPh015q21K53u0rVwTsMocwdGowR
</span></span><span class="line"><span class="cl">l+/UppyBxnGyU1uIba68D787INlruMzsOyUTuruCUZ5XJpiuYYVXcRuovUmCREWF
</span></span><span class="line"><span class="cl">EbW1DGd1lzmrO8cr70qu3yVCMYjGOQ6NA0fh1lpKTpFqHc3GC+ue19RDoVY1KnCC
</span></span><span class="line"><span class="cl">YsWuNom4PAuUyHlH3uJLM9+F9J2Qec+0PIedxHyxuIStWOSg+/TGjD4cP3FEItIt
</span></span><span class="line"><span class="cl">giRxx6qLWcK+bfg6WXv7I3+FA2J8eRKjLoD/vsZX+FpxG7T+c4mvfTUgxn0+bZD9
</span></span><span class="line"><span class="cl">gxTKlFWg2bhKTcxi0EsJ9XAEmocvOolwPQ==
</span></span><span class="line"><span class="cl">=ShPY
</span></span><span class="line"><span class="cl">-----END PGP PUBLIC KEY BLOCK-----
</span></span></code></pre></div><p>実際に使う場合は</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">:-----BEGIN PGP PUBLIC KEY BLOCK-----
</span></span></code></pre></div><p>の先頭のコロンを削除して使う。
失効処理を行うには <code>--import</code> コマンドで失効証明書をインポートすればよい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --import 9416E477EBA825CD1694573102C94DC57527A786.rev
</span></span><span class="line"><span class="cl">gpg: 鍵02C94DC57527A786:&#34;Alice &lt;alice@example.com&gt;&#34;失効証明書をインポートしました
</span></span><span class="line"><span class="cl">gpg:           処理数の合計: 1
</span></span><span class="line"><span class="cl">gpg:         新しい鍵の失効: 1
</span></span><span class="line"><span class="cl">gpg: marginals needed: 3  completes needed: 1  trust model: pgp
</span></span><span class="line"><span class="cl">gpg: 深さ: 0  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 0f, 1u
</span></span></code></pre></div><p>これで鍵の状態は</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ gpg --list-keys alice
</span></span><span class="line"><span class="cl">pub   rsa2048 2017-11-23 [SC] [失効: 2017-11-23]
</span></span><span class="line"><span class="cl">      9416E477EBA825CD1694573102C94DC57527A786
</span></span><span class="line"><span class="cl">uid           [  失効  ] Alice &lt;alice@example.com&gt;
</span></span></code></pre></div><p>となり失効したことが分かる。
<strong>失効した公開鍵を配布するのを忘れずに！</strong></p>
<h2>ブックマーク</h2>
<ul>
<li>
<p><a href="https://www.gnupg.org/documentation/manuals/gnupg/OpenPGP-Key-Management.html">Using the GNU Privacy Guard: OpenPGP Key Management</a></p>
</li>
<li>
<p><a href="https://baldanders.info/spiegel/cc-license/">わかる！ OpenPGP 暗号</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/remark/2016/03/using-gnupg-modern-version-1/">GnuPG for Windows ― インストール編</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/remark/2016/03/using-gnupg-modern-version-2/">GnuPG for Windows ― gpg-agent について</a></p>
</li>
</ul>
<h2>参考図書</h2>
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/B015643CPE?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/51t6yHHVwEL._SL160_.jpg" width="113" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/B015643CPE?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">暗号技術入門 第3版　秘密の国のアリス</a></dt>
    <dd>結城 浩 (著)</dd>
    <dd>SBクリエイティブ 2015-08-25 (Release 2015-09-17)</dd>
    <dd>Kindle版</dd>
    <dd>B015643CPE (ASIN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="5">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i></abbr></dd>
  </dl>
  <p class="description">SHA-3 や Bitcoin/Blockchain など新しい知見や技術要素を大幅追加。暗号技術を使うだけならこれ1冊でとりあえず無問題。</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2015-09-20">2015-09-20</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- 暗号技術入門 第3版 -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>相手の公開鍵に電子署名するには (1) 相手の公開鍵を貰って <code>--import</code> （または鍵サーバから <code>--recv-keys</code>）する (2) インポートした鍵に <code>--sign-key</code> する (3) 署名した公開鍵を <code>--export</code> して相手に返す（または鍵サーバへ <code>--send-keys</code>） といった手順を踏む。これをひとりひとりやるのは割と面倒なので，複数人が一度に電子署名を交わすために「<a href="https://en.wikipedia.org/wiki/Key_signing_party" title="Key signing party - Wikipedia">キーサイン・パーティ（key signing party）</a>」が行われることがある。日本ではあまり聞かないけど。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>もう少し詳しく言うと，公開鍵への電子署名の際に「信用度」を設定し，集まった「信用度」の累積から公開鍵の「有効性」を機械的に判定する。なので（信用度が分からない）全く未知の人の電子署名がいくらあっても「有効性」は上がりにくい。また公開鍵に電子署名を施すことは相手の鍵をある程度以上信用していることになるため，よく分からない鍵に対して安易に電子署名を行うことは避けるべきである。なお，現行バージョンの <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> では web of trust 以外にも X.509 や <a href="https://en.wikipedia.org/wiki/Trust_on_first_use" title="Trust on first use - Wikipedia">Tofu (Trust on first use)</a> といった信用モデルもサポートしている。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><code>--gen-key</code> コマンドに <code>--batch</code> オプションを組み合わせて設定ファイルから鍵を作成することも可能である。詳しい方法は “<a href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html">Unattended GPG key generation</a>” が参考になるだろう。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="http://tools.ietf.org/html/rfc4880" title="RFC 4880 - OpenPGP Message Format">OpenPGP</a> の鍵は1つの主鍵（primary key）と0個以上の副鍵（subkey）で構成されている。主鍵は必ず電子署名用の鍵になっていて，この主鍵にユーザID（とその自己署名）や他の鍵からの電子署名が付与される。副鍵は暗号化または電子署名用の鍵である。たとえば，データの暗号化と復号は実際にはこの副鍵を使って行う。副鍵は個別に追加したり失効したりできる。ちなみに <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> では通常のやり方では暗号化機能のみの鍵は作れない。電子署名機能のみの鍵は作ることができる。&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><code>--update-trustdb</code> コマンドは信用データベース（trustdb）の更新コマンドである。現行バージョンの <a href="https://gnupg.org/" title="The GNU Privacy Guard">GnuPG</a> では信用度は <code>trustdb.gpg</code> ファイルを使って鍵束とは独立に管理される。通常は鍵の状態が変わると自動的に信用データベースが更新されるのだが，自動更新しない場合は <code>--update-trustdb</code> コマンドで更新できる。なお，他ユーザの公開鍵に電子署名を施した場合は <code>--update-trustdb</code> コマンドを起動して署名した鍵の信用度を設定する。信用度の設定は <code>--edit-key</code> コマンドの編集モードでも設定・変更が可能である。&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>公開鍵に電子署名したことを公開したくない場合は <code>--lsign-key</code> コマンドで署名する。 <code>--lsign-key</code> コマンドで付与した署名はエクスポートされないため他ユーザには公開されない。公開鍵に関する確証はないけど取り敢えず使いたいという場合には有効な手だろう。&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>公開鍵の更新を鍵オーナーの存在証明に使うのは，あまり筋のいい運用とは思えない。&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p>または <code>--gen-revoke</code> コマンドで失効証明書を作成する。 <code>--gen-revoke</code> コマンドで作成した場合は失効理由も含めることができる。&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/openpgp/git-commit-with-openpgp-signature/">Git Commit で OpenPGP 署名を行う</a></div>
<div class="next-page"><a href="/openpgp/issuer-fingerprint-signature-subpacket-in-next-openpgp/">Issuer Fingerprint Signature Subpacket in Next OpenPGP</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Twitter, Facebook または電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2017-12-01</time> (revised in 2020-01-05)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a href="https://github.com/spiegel-im-spiegel"><span class="github-color"><i class="fab fa-github"></i></span></a></li><li><a href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><i class="fab fa-flickr"></i></span></a></li><li><a href="https://twitter.com/spiegel_2007"><span class="twitter-color"><i class="fab fa-twitter"></i></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fopenpgp%2fopenpgp-key-management%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.100.1</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({startOnLoad: true, fontFamily: "sans-serif", theme: 'dark', sequence: {height: 40, mirrorActors: false}});
</script>
</body>
</html>
