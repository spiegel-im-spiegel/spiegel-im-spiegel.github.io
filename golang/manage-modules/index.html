<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.90.1" />
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/golang/manage-modules/">
<script src="//kit.fontawesome.com/152e339e63.js"></script>
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Inconsolata%3a500,700%7cNoto+Sans+JP%3a500,700%7cNoto+Sans%3a500,700%7cNoto+Serif%7cNoto+Serif+JP&display=swap" type='text/css'>
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<title>Go 1.16 からのモジュール管理 | text.Baldanders.info</title>
<meta property="og:title" content="Go 1.16 からのモジュール管理">
<meta name="description" content="覚え書きとして記しておく">
<meta property="og:description" content="覚え書きとして記しておく">
<meta property="og:image" content="https://text.baldanders.info/images/attention/go-logo_blue.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@spiegel_2007">
<meta name="twitter:creator" content="@spiegel_2007">
<meta name="keywords" content="module, golang, engineering, management">
<link rel='prev' href='https://text.baldanders.info/golang/deprecation-of-ioutil/' title='io/ioutil の非推奨化について' />
<link rel='next' href='https://text.baldanders.info/golang/embeded-filesystem/' title='紙芝居用の簡易サーバを書く【Go 1.16 版】' />

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/golang/",
	"url": "https://text.baldanders.info/golang/",
	"inLanguage": "ja",
	"name": "プログラミング言語 Go",
	"description": "Go 言語プログラミングに関する話題。",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/golang/manage-modules/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/golang/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/golang/manage-modules/",
	"url": "https://text.baldanders.info/golang/manage-modules/",
	"mainEntityOfPage": "https://text.baldanders.info/golang/manage-modules/",
	"inLanguage": "ja",
	"name": "Go 1.16 からのモジュール管理",
	"description": "覚え書きとして記しておく",
	"headline": "覚え書きとして記しておく",
	"keywords": "module, golang, engineering, management",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"datePublished": "2021-02-21T07:15:24+00:00",
	"dateModified": "2021-12-04T02:40:05+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/golang/">プログラミング言語 Go</a>
</nav>
<article>
<h1>Go 1.16 からのモジュール管理</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/engineering/">engineering</a> #<a href="/tags/golang/">golang</a> #<a href="/tags/management/">management</a> #<a href="/tags/module/">module</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fas fa-share-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fmanage-modules%2f&amp;title=Go%201.16%20%e3%81%8b%e3%82%89%e3%81%ae%e3%83%a2%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab%e7%ae%a1%e7%90%86" target="_blank"><span class="pocket-color"><i class="fab fa-get-pocket" aria-hidden="true"></i></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fgolang%2fmanage-modules%2f" target="_blank"><span class="facebook-color"><i class="fab fa-facebook-square" aria-hidden="true"></i></span></a>&nbsp;<a href="http://twitter.com/share?text=Go%201.16%20%e3%81%8b%e3%82%89%e3%81%ae%e3%83%a2%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab%e7%ae%a1%e7%90%86+by+@spiegel_2007&amp;url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fmanage-modules%2f" target="_blank"><span class="twitter-color"><i class="fab fa-twitter-square" aria-hidden="true"></i></span></a></div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/golang/manage-modules/index.html">GitHub Page</a>
</nav>

<section>
<p>先日リリースされた <a href="https://go.dev/">Go</a> 1.16 でモジュール管理がいくつか変更になったので，覚え書きとして記しておく。
なお，このブログで書き散らした内容をまとめる形で 以下の Zenn 記事を書いた。
こちらも併せてどうぞ。</p>
<ul>
<li><a href="https://zenn.dev/spiegel/articles/20210223-go-module-aware-mode">Go のモジュール管理【バージョン 1.16 改訂版】</a></li>
</ul>
<h2>GO111MODULE 既定値の変更</h2>
<p>環境変数 <code>GO111MODULE</code> の既定値が <code>auto</code> から <code>on</code> に変更になった。
<code>GO111MODULE</code> の取りうる値は以下の通り。</p>
<table>
<thead>
<tr>
<th>値</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>on</code></td>
<td>常にモジュール対応モードで動作する</td>
</tr>
<tr>
<td><code>off</code></td>
<td>常に GOPATH モードで動作する</td>
</tr>
<tr>
<td><code>auto</code></td>
<td><code>$GOPATH/src</code> 以下のディレクトリに配置され <code>go.mod</code> を含まないパッケージは GOPATH モードで，それ以外はモジュール対応モードで動作する</td>
</tr>
</tbody>
</table>
<p><code>GO111MODULE</code> の値を <code>auto</code> に戻すのであれば <code>go env</code> コマンドで</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go env -w GO111MODULE=auto
</code></pre></div><p>とする。
<a href="https://go.dev/">Go</a> の環境変数の取り扱いについては，拙文「<a href="/golang/go-env/">Go 言語の環境変数管理</a>」を参照のこと。</p>
<h2>go.mod および go.sum の自動更新の抑制</h2>
<p><a href="https://go.dev/">Go</a> 1.15 までは <code>go build</code> や <code>go test</code> などのコマンドで <code>go.mod</code> や <code>go.sum</code> の内容が勝手に更新されていたが， 1.16 からは自動では更新されなくなった。</p>
<p>なので，コード上の <code>import</code> で新しい外部パッケージを追加しても <code>go.mod</code> や <code>go.sum</code> に記述がないと</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go test ./...
main.go:9:2: no required module provides package github.com/spiegel-im-spiegel/cov19jpn/chart; to add it:
	go get github.com/spiegel-im-spiegel/cov19jpn/chart
</code></pre></div><p>とか</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go test ./...
go: github.com/spiegel-im-spiegel/cov19jpn@v0.2.0: missing go.sum entry; to add it:
	go mod download github.com/spiegel-im-spiegel/cov19jpn
</code></pre></div><p>みたいなエラーが出たりする。</p>
<p><code>go.mod</code> や <code>go.sum</code> をいい感じに更新したいのであれば</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go mod tidy
</code></pre></div><p>とするとよい。</p>
<h2>バージョン付きの go install</h2>
<p><code>go install</code> コマンドで指定するパッケージパスにバージョン番号サフィックスを付けることができるようになった。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go install golang.org/x/tools/gopls@v0.6.5
</code></pre></div><p>これでバージョンを指定してモジュールのビルド&amp;インストールができる。
ただし <code>go.mod</code> ファイルが <code>replace</code> や <code>exclude</code> ディレクティブを含んでいると <code>go install</code> が失敗するみたい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go install github.com/spiegel-im-spiegel/cov19jpn@v0.2.0
go install github.com/spiegel-im-spiegel/cov19jpn@v0.2.0: github.com/spiegel-im-spiegel/cov19jpn@v0.2.0
	The go.mod file for the module providing named packages contains one or
	more replace directives. It must not contain directives that would cause
	it to be interpreted differently than if it were the main module.
</code></pre></div><p>この場合は今までどおり <code>go get</code> コマンドでビルドまでやってくれるが， <code>go get</code> コマンドによるビルドは<a href="https://github.com/golang/go/issues/43684" title="cmd/go: deprecate installing binaries using 'go get' in Go 1.17 and make 'go get -d' the default behavior · Issue #43684 · golang/go">将来的に廃止</a>になるみたいなので，早めになんとかしたいものである。</p>
<p>でもなぁ，私の場合「<a href="">Go 依存パッケージの脆弱性検査</a>」の誤検出対策に <code>replace</code> ディレクティブを使ってるから悩ましいんだよなぁ&hellip;</p>
<h2>特定バージョンのモジュールの撤回</h2>
<p><code>go.mod</code> で <code>retract</code> ディレクティブを使って特定バージョンのモジュールを撤回できるようになった（<code>go</code> ディレクティブが <code>1.16</code> 以上の場合）。</p>
<p>こんな感じにコメントとともに指定するといいらしい（コメント付けられたのか）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">// Remote-triggered crash in package foo. See CVE-2021-01234.
retract v1.0.5
</code></pre></div><p>これでこのバージョンを使おうとしても</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go list -m -u all
example.com/lib v1.0.0 (retracted)
$ go get .
go: warning: example.com/lib@v1.0.5: retracted by module author:
    Remote-triggered crash in package foo. See CVE-2021-01234.
go: to switch to the latest unretracted version, run:
    go get example.com/lib@latest
</code></pre></div><p>てな感じにコメントの内容で警告が表示されるそうだ。</p>
<h2>GOVCS によるバージョン管理ツールの制御</h2>
<p>環境変数 <code>GOVCS</code> を使ってリポジトリとバージョン管理ツールを関連付けることができる。
これを使って悪意のあるリポジトリ・サーバへのアクセスを制限することを意図しているようだ。</p>
<p>環境変数の設定は <code>go env -w</code> コマンドを使うとよいだろう。
たとえば</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ go env -w &#34;GOVCS=github.com:git,evil.com:off,*:git|hg&#34;
</code></pre></div><p>とすれば， github.com サイトでは git のみ許容し evil.com は使用禁止，その他のサイトでは git および mercurial のみ許容する，といった指定ができるらしい。</p>
<p>なお <code>GOVCS</code> の既定値は <code>public:git|hg,private:all</code> となっている。</p>
<h2>ブックマーク</h2>
<ul>
<li>
<p><a href="https://blog.golang.org/go116-module-changes">New module changes in Go 1.16 - The Go Blog</a></p>
</li>
<li>
<p><a href="/golang/versioning-of-go-modules/">Go モジュールのバージョン管理</a></p>
</li>
<li>
<p><a href="https://text.baldanders.info/release/2021/02/go-1_16-is-released/">Go 1.16 がリリースされた</a></p>
</li>
</ul>
<h2>参考図書</h2>
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/B099928SJD?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/416Stewy0NS._SL160_.jpg" width="123" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/B099928SJD?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">プログラミング言語Go</a></dt>
    <dd>アラン・ドノバン (著), ブライアン・カーニハン (著), 柴田芳樹 (著)</dd>
    <dd>丸善出版 2016-06-20 (Release 2021-07-13)</dd>
    <dd>Kindle版</dd>
    <dd>B099928SJD (ASIN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="5">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i></abbr></dd>
  </dl>
  <p class="description">Kindle 版出た！ 一部内容が古びてしまったが，この本は Go 言語の教科書と言ってもいいだろう。感想は<a href="/remark/2016/07/go-programming-language/" >こちら</a>。</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2021-05-22">2021-05-22</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- プログラミング言語Go -->

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/golang/deprecation-of-ioutil/">io/ioutil の非推奨化について</a></div>
<div class="next-page"><a href="/golang/embeded-filesystem/">紙芝居用の簡易サーバを書く【Go 1.16 版】</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Twitter, Facebook または電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2021-02-21</time> (revised in 2021-12-04)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a href="https://github.com/spiegel-im-spiegel"><span class="github-color"><i class="fab fa-github"></i></span></a></li><li><a href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><i class="fab fa-flickr"></i></span></a></li><li><a href="https://twitter.com/spiegel_2007"><span class="twitter-color"><i class="fab fa-twitter"></i></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fgolang%2fmanage-modules%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.90.1</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>

</body>
</html>
