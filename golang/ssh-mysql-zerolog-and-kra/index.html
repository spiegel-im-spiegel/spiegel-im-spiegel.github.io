<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.136.1">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/golang/ssh-mysql-zerolog-and-kra/">
<script defer src="/fa/js/all.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=BIZ+UDMincho&family=Inconsolata:wght@400;700&family=Noto+Color+Emoji&family=Noto+Sans:wght@400;700&family=Noto+Serif&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<link rel="me" href="https://fedibird.com/@spiegel">
<title>SSH, MySQL, Zerolog, そして Kra | text.Baldanders.info</title>
<meta property="og:title" content="SSH, MySQL, Zerolog, そして Kra">
<meta name="description" content="LOAD DATA INFILE 文を駆動させるところまで。">
<meta property="og:description" content="LOAD DATA INFILE 文を駆動させるところまで。">
<meta property="og:image" content="https://text.baldanders.info/images/attention/go-logo_blue.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<link rel="me" href="https://goark.fedicity.net/@spiegel">
<meta name="keywords" content="programming, golang, sql, orm, mysql">
<link rel='prev' href='https://text.baldanders.info/golang/abstract-filesystem/' title='fs.FS を使ってディレクトリ・ファイルを参照する' />
<link rel='next' href='https://text.baldanders.info/golang/simple-web-server-with-golang-3/' title='紙芝居用の簡易 Web サーバを Go 言語で書く【叱られ編】' />

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/golang/",
	"url": "https://text.baldanders.info/golang/",
	"inLanguage": "ja",
	"name": "プログラミング言語 Go",
	"description": "Go 言語プログラミングに関する話題。",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/golang/ssh-mysql-zerolog-and-kra/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/golang/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/golang/ssh-mysql-zerolog-and-kra/",
	"url": "https://text.baldanders.info/golang/ssh-mysql-zerolog-and-kra/",
	"mainEntityOfPage": "https://text.baldanders.info/golang/ssh-mysql-zerolog-and-kra/",
	"inLanguage": "ja",
	"name": "SSH, MySQL, Zerolog, そして Kra",
	"description": "LOAD DATA INFILE 文を駆動させるところまで。",
	"headline": "LOAD DATA INFILE 文を駆動させるところまで。",
	"keywords": "programming, golang, sql, orm, mysql",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"datePublished": "2022-09-22T14:05:54+00:00",
	"dateModified": "2024-05-10T22:02:32+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/golang/">プログラミング言語 Go</a>
</nav>
<article>
<h1>SSH, MySQL, Zerolog, そして Kra</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/golang/">golang</a> #<a href="/tags/mysql/">mysql</a> #<a href="/tags/orm/">orm</a> #<a href="/tags/programming/">programming</a> #<a href="/tags/sql/">sql</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fas fa-share-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fssh-mysql-zerolog-and-kra%2f&amp;title=SSH%2c%20MySQL%2c%20Zerolog%2c%20%e3%81%9d%e3%81%97%e3%81%a6%20Kra" target="_blank"><span class="pocket-color"><abbr title="Share Pocket"><i class="fab fa-get-pocket" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fgolang%2fssh-mysql-zerolog-and-kra%2f" target="_blank"><span class="facebook-color"><abbr title="Share facebook"><i class="fab fa-facebook-square" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://twitter.com/share?text=SSH%2c%20MySQL%2c%20Zerolog%2c%20%e3%81%9d%e3%81%97%e3%81%a6%20Kra&amp;url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fssh-mysql-zerolog-and-kra%2f" target="_blank"><span class="twitter-color"><abbr title="Share Twitter"><i class="fab fa-twitter-square" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="https://donshare.net/share.html?text=SSH%2c%20MySQL%2c%20Zerolog%2c%20%e3%81%9d%e3%81%97%e3%81%a6%20Kra+by+@spiegel%40goark.fedicity.net%20+https%3a%2f%2ftext.baldanders.info%2fgolang%2fssh-mysql-zerolog-and-kra%2f" target="_blank"><span class="mastodon-color"><abbr title="Share Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a>
	</div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/golang/ssh-mysql-zerolog-and-kra/index.html">GitHub Page</a>
</nav>

<section>
<h2>SSH, MySQL, Zerolog</h2>
<p>VPS 上に構築された MySQL サービスに大量のデータを送り込む必要がありまして。
<a href="https://go.dev/">Go</a> でバッチ処理を組もうと考えたわけだ。
当然 MySQL サービスは VPS の外から直接アクセスできないので SSH トンネルをくぐる必要がある。</p>
<p>というわけで最初に作ったのが <a href="https://github.com/goark/sshql" title="goark/sshql: Go SQL drivers over SSH"><code>github.com/goark/sshql</code></a> だった。</p>
<ul>
<li><a href="https://text.baldanders.info/release/2022/09/sql-over-ssh/">SSH 越しに DB サーバにアクセスする</a></li>
</ul>
<p>再掲載すると，こんな感じに書ける。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql/mysqldrv&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dialer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sshql</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Hostname</span><span class="p">:</span>   <span class="s">&#34;sshserver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>       <span class="mi">22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Username</span><span class="p">:</span>   <span class="s">&#34;remoteuser&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Password</span><span class="p">:</span>   <span class="s">&#34;passphraseforauthkey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrivateKey</span><span class="p">:</span> <span class="s">&#34;/home/username/.ssh/id_eddsa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysqldrv</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">dialer</span><span class="p">).</span><span class="nf">RegisterDial</span><span class="p">(</span><span class="s">&#34;ssh+tcp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="s">&#34;dbuser:dbpassword@ssh+tcp(localhost:3306)/dbname&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">dialer</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT id, name FROM example ORDER BY id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">name</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ID: %d  Name: %s\n&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rows</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>ssh+tcp</code> という名前で dialer を登録し，この名前を使って DSN (Data Source Name) を構成するというのがポイント。
Dialer のクローズを忘れずに（笑）</p>
<p>ただ，これだとログが取れない。
んで，どうせログを取るなら <a href="https://github.com/rs/zerolog" title="rs/zerolog: Zero Allocation JSON Logger"><code>github.com/rs/zerolog</code></a> パッケージを使いたいわけですよ。</p>
<p>そこで登場するのが <a href="https://github.com/simukti/sqldb-logger" title="simukti/sqldb-logger: A logger for Go SQL database driver without modifying existing *sql.DB stdlib usage."><code>github.com/simukti/sqldb-logger</code></a> パッケージ。
これを使えば標準の <a href="https://pkg.go.dev/database/sql" title="sql package - database/sql - Go Packages"><code>sql</code></a><code>.DB</code> に <a href="https://github.com/rs/zerolog" title="rs/zerolog: Zero Allocation JSON Logger">zerolog</a> などのサードパーティ製 logger を仕込むことができる。
こんな感じ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql/mysqldrv&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="s">&#34;github.com/rs/zerolog&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">sqldblogger</span> <span class="s">&#34;github.com/simukti/sqldb-logger&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="s">&#34;github.com/simukti/sqldb-logger/logadapter/zerologadapter&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dialer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sshql</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Hostname</span><span class="p">:</span>   <span class="s">&#34;sshserver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>       <span class="mi">22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Username</span><span class="p">:</span>   <span class="s">&#34;remoteuser&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Password</span><span class="p">:</span>   <span class="s">&#34;passphraseforauthkey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrivateKey</span><span class="p">:</span> <span class="s">&#34;/home/username/.ssh/id_eddsa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysqldrv</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">dialer</span><span class="p">).</span><span class="nf">RegisterDial</span><span class="p">(</span><span class="s">&#34;ssh+tcp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="nx">dsn</span> <span class="o">:=</span> <span class="s">&#34;dbuser:dbpassword@ssh+tcp(localhost:3306)/dbname&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">mysqlDb</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="nx">dsn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">sqldblogger</span><span class="p">.</span><span class="nf">OpenDriver</span><span class="p">(</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">dsn</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">mysqlDb</span><span class="p">.</span><span class="nf">Driver</span><span class="p">(),</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">zerologadapter</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zerolog</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)),</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">sqldblogger</span><span class="p">.</span><span class="nf">WithMinimumLevel</span><span class="p">(</span><span class="nx">sqldblogger</span><span class="p">.</span><span class="nx">LevelDebug</span><span class="p">),</span>
</span></span><span class="line hl"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">dialer</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT id, name FROM example ORDER BY id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">name</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ID: %d  Name: %s\n&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rows</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>DSN を2回指定しないといけないのが若干鬱陶しいが，ともかくこれで <a href="https://github.com/rs/zerolog" title="rs/zerolog: Zero Allocation JSON Logger">zerolog</a> による構造化ログが出るようになった。</p>
<h2>さらに Kra を仕込む</h2>
<p><a href="https://gocon.connpass.com/event/212162/" title="Go Conference 2022 Spring Online - connpass">2022年春の Go Conference</a> でとても<a href="https://gocon.jp/2022spring/ja/sessions/b7-l/" title="Go Conference 2022 Spring | Go で RDB に SQL でアクセスするためのライブラリ Kra の紹介">感銘を受けた</a>のが <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>github.com/taichi/kra</code></a> パッケージ。</p>
<ul>
<li><a href="https://drive.google.com/file/d/1lsF7q74o0Akewk-5rUb9Jt9nA2MqpDDw/view">DBアクセスライブラリ Kra</a></li>
</ul>
<p>いや <a href="https://entgo.io/">ent</a> とかってデータ構造とその関係を最初から構築するならいい道具だと思うけど（コードで設計できるのは素晴らしい！），既にある RDBMS 環境を使う場合には必ずしもマッチしないのよね。
更に言うと，既存 ORM やクエリビルダとかの中途半端な SQL 抽象化・隠蔽にはウンザリしてるのよ（この辺は <a href="https://go.dev/">Go</a> に限らないけど）。
それなら最初からガチで SQL 文を書いて，クエリプランをチェックしつつ評価・最適化して，それから実装を進めるべきだと常々思っていた<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>というわけで <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>github.com/taichi/kra</code></a> を使うチャンスを伺っていたのだが，今回はお試しにはちょうどいいサイズだったので採用した。
とはいえ，今回のような構成ではどうすればいいのか分からなくて <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>kra</code></a> パッケージのソースコードやサンプルコードを眺めながら，まずは以下のように書いてみる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;database/sql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/goark/sshql/mysqldrv&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/rs/zerolog&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sqldblogger</span> <span class="s">&#34;github.com/simukti/sqldb-logger&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/simukti/sqldb-logger/logadapter/zerologadapter&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="s">&#34;github.com/taichi/kra&#34;</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">kraSql</span> <span class="s">&#34;github.com/taichi/kra/sql&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dialer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sshql</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Hostname</span><span class="p">:</span>   <span class="s">&#34;sshserver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>       <span class="mi">22</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Username</span><span class="p">:</span>   <span class="s">&#34;remoteuser&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Password</span><span class="p">:</span>   <span class="s">&#34;passphraseforauthkey&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrivateKey</span><span class="p">:</span> <span class="s">&#34;/home/username/.ssh/id_eddsa&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysqldrv</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">dialer</span><span class="p">).</span><span class="nf">RegisterDial</span><span class="p">(</span><span class="s">&#34;ssh+tcp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dsn</span> <span class="o">:=</span> <span class="s">&#34;dbuser:dbpassword@ssh+tcp(localhost:3306)/dbname&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysqlDb</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="nx">dsn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">kraSql</span><span class="p">.</span><span class="nf">NewDB</span><span class="p">(</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">sqldblogger</span><span class="p">.</span><span class="nf">OpenDriver</span><span class="p">(</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">dsn</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">mysqlDb</span><span class="p">.</span><span class="nf">Driver</span><span class="p">(),</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">zerologadapter</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zerolog</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)),</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">sqldblogger</span><span class="p">.</span><span class="nf">WithMinimumLevel</span><span class="p">(</span><span class="nx">sqldblogger</span><span class="p">.</span><span class="nx">LevelDebug</span><span class="p">),</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">),</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">kraSql</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span><span class="nx">kra</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span><span class="nx">kra</span><span class="p">.</span><span class="nx">MySQL</span><span class="p">)),</span>
</span></span><span class="line hl"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">dialer</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="nx">rs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="s">&#34;SELECT id, name FROM example ORDER BY id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">rows</span> <span class="o">:=</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Rows</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">rec</span> <span class="o">:=</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">Id</span>   <span class="kt">int64</span>  <span class="s">`db:&#34;id&#34;`</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`db:&#34;name&#34;`</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}{}</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kraSql</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">(</span><span class="nx">kraSql</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span><span class="nx">kra</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span><span class="nx">kra</span><span class="p">.</span><span class="nx">MySQL</span><span class="p">)),</span> <span class="nx">rows</span><span class="p">).</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rec</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line hl"><span class="cl">            <span class="k">break</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">}</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">rec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rows</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>クエリ結果の取り出しが若干まどろこしいが，これは <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>kra</code></a><code>/sql.Rows</code> には何故か <code>Next()</code> メソッドがないため<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>。
しょうがないので 標準の <a href="https://pkg.go.dev/database/sql" title="sql package - database/sql - Go Packages"><code>sql</code></a><code>.Rows</code> を取り出して，そちらの <code>Next()</code> メソッドで回している。</p>
<p>これでちゃんと動いてログも取れているのを確認できた。</p>
<h2>トランザクション制御</h2>
<p>トランザクション制御用に以下のような関数を用意する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Transaction</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">db</span> <span class="o">*</span><span class="nx">kraSql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">TxOptions</span><span class="p">,</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">kraSql</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">BeginTx</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">v</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">panic</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">tx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">rErr</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">();</span> <span class="nx">rErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">rErr</span><span class="p">,</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">WithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>なお，エラーハンドリングには自作の <a href="https://github.com/goark/errs" title="goark/errs: Error handling for Golang"><code>github.com/goark/errs</code></a> パッケージを使っている。
<a href="https://github.com/rs/zerolog" title="rs/zerolog: Zero Allocation JSON Logger">zerolog</a> と組み合わせて<a href="https://zenn.dev/spiegel/books/error-handling-in-golang/viewer/error-logging" title="ぼくがかんがえたさいきょうのえらーろぐ｜Go のエラーハンドリング">エラーを構造化してログに吐ける</a>のが利点。</p>
<p>実際にトランザクション処理を行う場合は，たとえば</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// logger := zerolog.New(os.Stderr)
</span></span></span><span class="line"><span class="cl"><span class="c1">// ctx := context.TODO()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">values</span> <span class="o">:=</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Id</span>   <span class="kt">int64</span>  <span class="s">`db:&#34;id&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`db:&#34;name&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Id</span><span class="p">:</span>   <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Transaction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sql</span><span class="p">.</span><span class="nx">TxOptions</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">kraSql</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stmt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Prepare</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;INSERT INTO example(id,name) VALUES (:id,:name)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">stmt</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stmt</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">count</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">res</span><span class="p">.</span><span class="nf">RowsAffected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">Int64</span><span class="p">(</span><span class="s">&#34;affected&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">).</span><span class="nf">Send</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">().</span><span class="nf">Interface</span><span class="p">(</span><span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span><span class="nf">Send</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>てな感じに書ける。
こういうのが <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>kra</code></a> にあるとめがっさ便利なんだけどねぇ（それを言い出すとパッケージがどんどん膨れてしまうのだがw）。</p>
<h2>LOAD DATA INFILE 文で大量のデータを突っ込む</h2>
<p>さて，いよいよ MySQL の テーブルに大量のデータを突っ込むのだが， <code>INSERT</code> 文でちまちまやってたら日が暮れてしまうので（実際に試して日が暮れた） <code>LOAD DATA INFILE</code> 文を使うことにする。</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/ja/load-data.html">MySQL :: MySQL 5.6 リファレンスマニュアル :: 13.2.6 LOAD DATA INFILE 構文</a></li>
</ul>
<p>こんな感じの SQL 文。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="k">LOCAL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;input.file&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">exsample_table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nb">CHARACTER</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">utf8mb4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">FIELDS</span><span class="w"> </span><span class="n">TERMINATED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;\t&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">LINES</span><span class="w"> </span><span class="n">TERMINATED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">field2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>これでローカルにある <code>input.file</code> ファイルの内容をリモートの MySQL の <code>exsample_table</code> テーブルに送り込める。
<code>(field1, field2, ...)</code> の並びと入力ファイルの要素の並びが同じであることが前提。
またサーバ側の MySQL サービスが <code>--local_infile</code> オプション付きで起動されていること<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>。</p>
<p><code>CHARACTER SET</code> 句はファイルの文字エンコードディングがDBサービスのデフォルトと異なる場合に設定する。
<code>FIELDS</code> 句および <code>LINES</code> を省略した場合のデフォルト値はこうなっているそうな。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">FIELDS</span><span class="w"> </span><span class="n">TERMINATED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;\t&#39;</span><span class="w"> </span><span class="n">ENCLOSED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="n">ESCAPED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;\\&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">LINES</span><span class="w"> </span><span class="n">TERMINATED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="n">STARTING</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span></code></pre></div><p>いわゆる TSV (Tab Separated Value) 形式のレコードだね。
これ以外の形式なら明示的に設定する必要がある。</p>
<p>で，これを <a href="https://github.com/go-sql-driver/mysql" title="go-sql-driver/mysql: Go MySQL Driver is a MySQL driver for Go's (golang) database/sql package"><code>github.com/go-sql-driver/mysql</code></a> パッケージで実装するには，3つのステップが必要。</p>
<p>ひとつ目はデータ読み込みハンドラを登録する。
こんな感じ<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;input.file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">mysql</span><span class="p">.</span><span class="nf">RegisterReaderHandler</span><span class="p">(</span><span class="s">&#34;data&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">file</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><p>次に実際の SQL 文を発行する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// logger := zerolog.New(os.Stderr)
</span></span></span><span class="line"><span class="cl"><span class="c1">// ctx := context.TODO()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Transaction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sql</span><span class="p">.</span><span class="nx">TxOptions</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">kraSql</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">`LOAD DATA LOCAL INFILE &#39;Reader::data&#39; INTO TABLE exsample_table (field1, field2, ...)`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">count</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">res</span><span class="p">.</span><span class="nf">RowsAffected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errs</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">Int64</span><span class="p">(</span><span class="s">&#34;affected&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">).</span><span class="nf">Send</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">().</span><span class="nf">Interface</span><span class="p">(</span><span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span><span class="nf">Send</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ファイルを指定する部分に先ほど登録したハンドラの名前を使って <code>'Reader::data'</code> と指定する。
爆速でした。</p>
<p>ちなみに，うっかり <code>tx.Prepare()</code> で前準備しようとすると「そんな構文はサポートしてない」（←超意訳）と怒られる。
<code>PREPARE</code> で対応している構文は以下のページが参考になる。</p>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/ja/sql-prepared-statements.html">MySQL :: MySQL 8.0 リファレンスマニュアル :: 13.5 プリペアドステートメント</a></li>
</ul>
<p>最後に <a href="https://github.com/go-sql-driver/mysql" title="go-sql-driver/mysql: Go MySQL Driver is a MySQL driver for Go's (golang) database/sql package"><code>mysql</code></a><code>.DeregisterReaderHandler()</code> 関数で登録を解除する。
後始末はきちんとね。</p>
<h2>ブックマーク</h2>
<ul>
<li><a href="https://qiita.com/yes_dog/items/57c1a8c03aff8bb177de">【自分用のメモ】MySQL8でインポート・エクスポート - Qiita</a></li>
<li><a href="https://eli.thegreenplace.net/2022/ssh-port-forwarding-with-go/">SSH port forwarding with Go - Eli Bendersky&rsquo;s website</a></li>
</ul>
<h2>参考図書</h2>
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/4621300253?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/41meaSLNFfL._SL160_.jpg" width="123" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/4621300253?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">プログラミング言語Go (ADDISON-WESLEY PROFESSIONAL COMPUTING SERIES)</a></dt>
    <dd>Alan A.A. Donovan (著), Brian W. Kernighan (著), 柴田 芳樹 (翻訳)</dd>
    <dd>丸善出版 2016-06-20</dd>
    <dd>単行本（ソフトカバー）</dd>
    <dd>4621300253 (ASIN), 9784621300251 (EAN), 4621300253 (ISBN), 9784621300251 (ISBN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="5">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i></abbr></dd>
  </dl>
  <p class="description">著者のひとりは（あの「バイブル」とも呼ばれる）通称 “K&amp;R” の K のほうである。この本は Go 言語の教科書と言ってもいいだろう。</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2016-07-13">2016-07-13</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- プログラミング言語Go -->
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/B09C2XBC2F?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/31PDIZXO9tL._SL160_.jpg" width="160" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/B09C2XBC2F?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">デベロッパーゴースーパーゴラン Tシャツ</a></dt>
    <dd>Geek Go Super Golang Tees</dd>
    <dd>ウェア&amp;シューズ</dd>
    <dd>B09C2XBC2F (ASIN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="4">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="far fa-star"></i></abbr></dd>
  </dl>
  <p class="description">ついカッとなってポチった。反省はしない</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2022-04-10">2022-04-10</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- Golang Tシャツ -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>SQL はひとつの独立した言語で（チューリング完全），宣言型プログラミング言語と考えるのが分かりやすい（異論は認めるw）。宣言型で分かりやすいのは正規表現だろう（関数型言語には宣言型が多い。 Lisp とか Haskell とか）。特に <a href="https://go.dev/">Go</a> は宣言型の言語とはあまり相性がよくない。たとえば，正規表現の（構文解析やコンパイラではなく）ビルダを作ろうと考える人は少ないだろう（労力に見合わない）。どの言語・フレームワークでも同じことだが ORM やクエリビルダを使って頑張って抽象化や隠蔽をしても上手くマッチしない局面が多く，結局は「ガチの SQL でいいぢゃん。 PREPARE 構文で事前準備して変数部分はプレースホルダ経由で渡せば安全は確保される」となる。そういう意味じゃ <a href="https://go.dev/">Go</a> 標準の <a href="https://pkg.go.dev/database/sql" title="sql package - database/sql - Go Packages"><code>database/sql</code></a> パッケージは，かなり妥当な割り切りをしてると思う。まぁ，後方互換性を保つためにちょっとアレな感じになっているのは否めないけど（笑）&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://github.com/jackc/pgx" title="jackc/pgx: PostgreSQL driver and toolkit for Go"><code>github.com/jackc/pgx</code></a> 専用の <a href="https://github.com/taichi/kra" title="taichi/kra: relational database access helper library"><code>kra</code></a><code>/pgx.Rows</code> にはちゃんと <code>Next()</code> メソッドが付いている。提供されているメソッドが微妙に違う理由はよく分からないが，ソースコードを眺めるに，何となく意図的にそうなってる気がする。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><code>local_infile</code> オプションをセットすると mysqldump を使用する際に「そんなフラグは知らん」と怒られる場合がある。これを回避するには <code>loose-local-infile</code> にするといいらしい。当然ではあるが <code>LOAD DATA LOCAL ...</code> 文は<a href="https://docs.oracle.com/cd/E17952_01/mysql-8.0-ja/load-data-local-security.html" title="6.1.6 LOAD DATA LOCAL のセキュリティー上の考慮事項">セキュリティ・リスクがある</a>ので取り扱い注意である。&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>実は <a href="https://github.com/go-sql-driver/mysql" title="go-sql-driver/mysql: Go MySQL Driver is a MySQL driver for Go's (golang) database/sql package"><code>mysql</code></a><code>.RegisterLocalFile()</code> 関数を使えば直接ファイルパスを登録することができる。ハンドラ登録で <a href="https://pkg.go.dev/io" title="io package - io - Go Packages"><code>io</code></a><code>.Reader</code> interface 型で渡すほうが応用が効きやすいので，今回はこちら。&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/golang/abstract-filesystem/">fs.FS を使ってディレクトリ・ファイルを参照する</a></div>
<div class="next-page"><a href="/golang/simple-web-server-with-golang-3/">紙芝居用の簡易 Web サーバを Go 言語で書く【叱られ編】</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Mastodon などの SNS や電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2022-09-22</time> (revised in 2024-05-11)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a rel="me" href="https://github.com/spiegel-im-spiegel"><span class="github-color"><abbr title="GitHub"><i class="fab fa-github"></i></abbr></span></a></li><li><a rel="me" href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><abbr title="Flickr"><i class="fab fa-flickr"></i></abbr></span></a></li><li><a rel="me" href="https://goark.fedicity.net/@spiegel"><span class="mastodon-color"><abbr title="Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a></li><li><a rel="me" href="https://bsky.app/profile/baldanders.info"><span class="bluesky-color"><abbr title="Bluesky"><i class="fa-brands fa-bluesky"></i></abbr></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fgolang%2fssh-mysql-zerolog-and-kra%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.136.1</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>

</body>
</html>
