<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Hugo 0.152.0">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://text.baldanders.info/golang/wasi-with-tinygo/">
<script defer src="/fa/js/all.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=BIZ+UDMincho:wght@400;700&family=Intel+One+Mono:wght@400;700&family=Noto+Color+Emoji&family=Noto+Sans:wght@400;700&family=Noto+Serif+Hentaigana:wght@400;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/local-font.css" type='text/css'>
<link rel="stylesheet" href="/css/baldanders-info-dark.css" type='text/css'>

<link rel="alternate" href="https://text.baldanders.info/index.xml" type="application/rss+xml" title="text.Baldanders.info">
<link rel="alternate" href="https://text.baldanders.info/index.json" type="application/json" title="text.Baldanders.info">
<meta name="google-site-verification" content="jTjBCslPtf8gwVatiY-GDgGv7pV5csa8aUOw1MRPUD4">
<link rel="me" href="https://fedibird.com/@spiegel">
<title>TinyGo で WASI 【失敗編】 [text.Baldanders.info]</title>
<meta property="og:title" content="TinyGo で WASI 【失敗編】">
<meta name="description" content="どうやったら動かせるのか。どなたか教えてください 🙇">
<meta property="og:description" content="どうやったら動かせるのか。どなたか教えてください 🙇">
<meta property="og:image" content="https://text.baldanders.info/images/attention/go-logo_blue.png">
<meta name="author" content="Spiegel">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@spiegel_2007">
<meta name="twitter:creator" content="@spiegel_2007">
<link rel="me" href="https://goark.fedicity.net/@spiegel">
<meta name="keywords" content="programming, golang, tinygo, webassembly">
<link rel='prev' href='https://text.baldanders.info/golang/webassembly-with-tinygo/' title='TinyGo で WebAssembly'>
<link rel='next' href='https://text.baldanders.info/golang/token-bucket/' title='Go による Token Bucket 実装'>

<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "WebSite",
	"@id": "https://text.baldanders.info/",
	"inLanguage": "ja",
	"name": "text.Baldanders.info",
    "url": "https://text.baldanders.info/",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"image": "https://text.baldanders.info/images/attention/site.jpg",
	"description": "帰ってきた「しっぽのさきっちょ」"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Organization",
	"@id": "https://text.baldanders.info/#org",
	"name": "Spiegel",
	"logo": {
		"@type": "ImageObject",
		"@id": "https://text.baldanders.info/#logo",
		"url": "https://text.baldanders.info/images/avatar.jpg"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Person",
	"@id": "https://text.baldanders.info/#maker",
	"name": "Spiegel",
	"url": "https://baldanders.info/profile/",
	"image": "https://text.baldanders.info/images/avatar.jpg"
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Blog",
	"@id": "https://text.baldanders.info/golang/",
	"url": "https://text.baldanders.info/golang/",
	"inLanguage": "ja",
	"name": "プログラミング言語 Go",
	"description": "Go 言語プログラミングに関する話題。",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	}
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BreadcrumbList",
	"@id": "https://text.baldanders.info/golang/wasi-with-tinygo/#breadcrumb-list",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"item": {
				"@id": "https://text.baldanders.info/"
			}
		},
		{
			"@type": "ListItem",
			"position": 2,
			"item": {
				"@id": "https://text.baldanders.info/golang/"
			}
		}
	]
}
</script>
<script type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "BlogPosting",
	"@id": "https://text.baldanders.info/golang/wasi-with-tinygo/",
	"url": "https://text.baldanders.info/golang/wasi-with-tinygo/",
	"mainEntityOfPage": "https://text.baldanders.info/golang/wasi-with-tinygo/",
	"inLanguage": "ja",
	"name": "TinyGo で WASI 【失敗編】",
	"description": "どうやったら動かせるのか。どなたか教えてください 🙇",
	"headline": "どうやったら動かせるのか。どなたか教えてください 🙇",
	"keywords": "programming, golang, tinygo, webassembly",
	"image": "https://text.baldanders.info/images/attention/go-logo_blue.png",
	"datePublished": "2021-03-21T08:38:59+00:00",
	"dateModified": "2024-05-10T22:02:32+00:00",
	"publisher": {
		"@id": "https://text.baldanders.info/#org"
	},
	"author": {
		"@id": "https://text.baldanders.info/#maker"
	},
	"license": "https://creativecommons.org/licenses/by-sa/4.0/"
}
</script>
</head>
<body>

<div id='container'>

<main>
<nav class="breadcrumb">
<a href="https://text.baldanders.info/">text.Baldanders.info</a> &raquo; <a href="/golang/">プログラミング言語 Go</a>
</nav>
<article>
<h1>TinyGo で WASI 【失敗編】</h1>
<nav class="tags">
	<div><a href='/tags/'>Tags</a>: #<a href="/tags/golang/">golang</a> #<a href="/tags/programming/">programming</a> #<a href="/tags/tinygo/">tinygo</a> #<a href="/tags/webassembly/">webassembly</a></div>
	<div class="cloud">
		<span class="share-color" title="Share this entry"><i class="fa-solid fa-share-from-square"></i></span>&nbsp;:
		&nbsp;<a href="https://getpocket.com/edit?url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fwasi-with-tinygo%2f&amp;title=TinyGo%20%e3%81%a7%20WASI%20%e3%80%90%e5%a4%b1%e6%95%97%e7%b7%a8%e3%80%91" target="_blank"><span class="pocket-color"><abbr title="Share Pocket"><i class="fab fa-get-pocket" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://www.facebook.com/share.php?u=https%3a%2f%2ftext.baldanders.info%2fgolang%2fwasi-with-tinygo%2f" target="_blank"><span class="facebook-color"><abbr title="Share facebook"><i class="fab fa-square-facebook" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="http://twitter.com/share?text=TinyGo%20%e3%81%a7%20WASI%20%e3%80%90%e5%a4%b1%e6%95%97%e7%b7%a8%e3%80%91+by+@spiegel_2007&amp;url=https%3a%2f%2ftext.baldanders.info%2fgolang%2fwasi-with-tinygo%2f" target="_blank"><span class="x-twitter-color"><abbr title="Share Twitter"><i class="fa-brands fa-square-x-twitter" aria-hidden="true"></i></abbr></span></a>
		&nbsp;<a href="https://donshare.net/share.html?text=TinyGo%20%e3%81%a7%20WASI%20%e3%80%90%e5%a4%b1%e6%95%97%e7%b7%a8%e3%80%91+by+@spiegel%40goark.fedicity.net%20+https%3a%2f%2ftext.baldanders.info%2fgolang%2fwasi-with-tinygo%2f" target="_blank"><span class="mastodon-color"><abbr title="Share Mastodon"><i class="fa-brands fa-mastodon" aria-hidden="true"></i></abbr></span></a>
	</div>
</nav>
<nav class="history">History in
  <a href="https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io/commits/master/golang/wasi-with-tinygo/index.html">GitHub Page</a>
</nav>

<section>
<p><a href="/golang/webassembly-with-tinygo/">前回</a>は <a href="https://go.dev/">Go</a> および <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> を使って <a href="https://webassembly.org/" title="WebAssembly">WebAssembly</a> コードを生成しブラウザ上で実行するところまでやった。</p>
<p>しかし，クライアント側のブラウザ上で動かすだけではあまり面白くないよね。
そこで WASI (WebAssembly System Interface) という POSIX 風の標準規格があるそうな。
WASI に則った <a href="https://webassembly.org/" title="WebAssembly">WebAssembly</a> コードと，それを駆動するランタイム環境を用意することで “Write Once, Run Anywhere” の夢よもう一度，というわけ<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>（笑）</p>
<p>実は本家 <a href="https://go.dev/">Go</a> の <code>wasm</code> アーキテクチャは WASI に対応していない。
ただし <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> のほうはイケるみたいなので，今回は <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> オンリーでお送りする。</p>
<h2>WASI ランタイム</h2>
<p>スタンドアロンで動く WASI ランタイムには色々あるようで</p>
<ul>
<li><a href="https://github.com/bytecodealliance/lucet" title="bytecodealliance/lucet: Lucet, the Sandboxing WebAssembly Compiler.">Lucet</a></li>
<li><a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a></li>
<li><a href="https://docs.wasmer.io/" title="Wasmer Docs">Wasmer</a></li>
<li><a href="https://wavm.github.io/">WAVM</a></li>
<li><a href="https://www.secondstate.io/ssvm/" title="The Second State WebAssembly VM">SSVM</a></li>
</ul>
<p>といった実装があるらしい。</p>
<p>ただ <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> のターゲット定義が</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;llvm-target&#34;</span><span class="p">:</span>   <span class="s2">&#34;wasm32--wasi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;build-tags&#34;</span><span class="p">:</span>    <span class="p">[</span><span class="s2">&#34;wasm&#34;</span><span class="p">,</span> <span class="s2">&#34;wasi&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;goos&#34;</span><span class="p">:</span>          <span class="s2">&#34;linux&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;goarch&#34;</span><span class="p">:</span>        <span class="s2">&#34;arm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;compiler&#34;</span><span class="p">:</span>      <span class="s2">&#34;clang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;linker&#34;</span><span class="p">:</span>        <span class="s2">&#34;wasm-ld&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;libc&#34;</span><span class="p">:</span>          <span class="s2">&#34;wasi-libc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cflags&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--target=wasm32--wasi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--sysroot={root}/lib/wasi-libc/sysroot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;-Oz&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ldflags&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--allow-undefined&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--stack-first&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--export-dynamic&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--no-demangle&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;emulator&#34;</span><span class="p">:</span>      <span class="p">[</span><span class="s2">&#34;wasmtime&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;wasm-abi&#34;</span><span class="p">:</span>      <span class="s2">&#34;generic&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>と <a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> をリファレンスとしているみたいなので，今回はこれを使う。</p>
<h3><a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> の導入</h3>
<p><a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> のリポジトリでバイナリが<a href="https://github.com/bytecodealliance/wasmtime/releases" title="Releases · bytecodealliance/wasmtime">リリース</a>されているので，これを取ってきて PATH の通ったディレクトリに放り込んでおけばよい。</p>
<p>あるいは</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ curl https://wasmtime.dev/install.sh -sSf | bash
</span></span></code></pre></div><p>とすれば <code>$HOME/.wasmtime/bin/</code> ディレクトリを掘って入れてくれる。
さらに PATH を通すために <code>$HOME/.bashrc</code> ファイルを書き換えてくれやがるので，ご注意を。</p>
<p>なお <a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> 自体のビルドには Rust と C++ (多分 GCC の g++) のビルド環境が必要らしい。
時代は Rust なんだねぇ。</p>
<p>以下，動作確認。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ wasmtime --help
</span></span><span class="line"><span class="cl">wasmtime 0.25.0
</span></span><span class="line"><span class="cl">Wasmtime WebAssembly Runtime
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USAGE:
</span></span><span class="line"><span class="cl">    wasmtime &lt;SUBCOMMAND&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FLAGS:
</span></span><span class="line"><span class="cl">    -h, --help       Prints help information
</span></span><span class="line"><span class="cl">    -V, --version    Prints version information
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SUBCOMMANDS:
</span></span><span class="line"><span class="cl">    config      Controls Wasmtime configuration settings
</span></span><span class="line"><span class="cl">    help        Prints this message or the help of the given subcommand(s)
</span></span><span class="line"><span class="cl">    run         Runs a WebAssembly module
</span></span><span class="line"><span class="cl">    wasm2obj    Translates a WebAssembly module to native object file
</span></span><span class="line"><span class="cl">    wast        Runs a WebAssembly test script file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If a subcommand is not provided, the `run` subcommand will be used.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage examples:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Running a WebAssembly module with a start function:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  wasmtime example.wasm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Passing command line arguments to a WebAssembly module:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  wasmtime example.wasm arg1 arg2 arg3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Invoking a specific function (e.g. `add`) in a WebAssembly module:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  wasmtime example.wasm --invoke add 1 2
</span></span></code></pre></div><h2>みんな大好き Hello World</h2>
<p>何はともあれ，コードを用意しないとね。
いつものように，みんな大好き Hello World で。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="s">&#34;fmt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello, World!&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これを <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> で処理する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ tinygo build -o hello.wasm -target wasi ./hello.go
</span></span></code></pre></div><p>ターゲットが <code>wasi</code> になっている点に注意。</p>
<h2><a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> で WASI コードを動かす</h2>
<p>んではビルドした <code>hello.wasm</code> ファイルを実行してみる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ wasmtime run hello.wasm 
</span></span><span class="line"><span class="cl">Hello, World!
</span></span></code></pre></div><p>よーし，うむうむ，よーし。</p>
<h2><a href="https://github.com/bytecodealliance/wasmtime-go" title="bytecodealliance/wasmtime-go: Go WebAssembly runtime powered by Wasmtime">wasmtime-go</a> で WASI ランタイムを組み込む【失敗編】</h2>
<p><a href="https://github.com/bytecodealliance/wasmtime-go" title="bytecodealliance/wasmtime-go: Go WebAssembly runtime powered by Wasmtime">bytecodealliance/wasmtime-go</a> を使うと <a href="https://wasmtime.dev/" title="Wasmtime — a small and efficient runtime for WebAssembly &amp; WASI">Wasmtime</a> のランタイム機能を <a href="https://go.dev/">Go</a> のコードとして埋め込めるらしい（要 cgo）。
こんな感じかな。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&#34;embed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;fmt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;os&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;github.com/bytecodealliance/wasmtime-go&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">//go:embed hello.wasm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">var</span><span class="w"> </span><span class="nx">wasm</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">store</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewStore</span><span class="p">(</span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewEngine</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasiConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiConfig</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasiConfig</span><span class="p">.</span><span class="nf">InheritStdout</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasi</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiInstance</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="w"> </span><span class="nx">wasiConfig</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;wasi_snapshot_preview1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in wasmtime.NewWasiInstance() : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">linker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewLinker</span><span class="p">(</span><span class="nx">store</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">linker</span><span class="p">.</span><span class="nf">DefineWasi</span><span class="p">(</span><span class="nx">wasi</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in wasmtime.Linker.DefineWasi() : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">ModuleValidate</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in wasmtime.ModuleValidate() : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewModule</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in wasmtime.NewModule() : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">linker</span><span class="p">.</span><span class="nf">Instantiate</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in wasmtime.Linker.Instantiate() : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="p">.</span><span class="nf">GetExport</span><span class="p">(</span><span class="s">&#34;_start&#34;</span><span class="p">).</span><span class="nf">Func</span><span class="p">().</span><span class="nf">Call</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error in \&#34;_start\&#34; : %w&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>では，これを動かしてみよう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ go run sample.go 
</span></span><span class="line"><span class="cl">error in wasmtime.Linker.Instantiate() : unknown import: `wasi_unstable::fd_write` has not been defined
</span></span></code></pre></div><p>おうふ。
なんか足らんと言っている。</p>
<p><a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> 側でなにか不備があるのかと思って以下の<a href="https://pkg.go.dev/github.com/bytecodealliance/wasmtime-go#example-package-Wasi">サンプル・コード</a>もそのまま動かしてみたが</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;fmt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;io/ioutil&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;os&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;path/filepath&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;github.com/bytecodealliance/wasmtime-go&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">const</span><span class="w"> </span><span class="nx">TextWat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">`(module
</span></span></span><span class="line"><span class="cl"><span class="s">    ;; Import the required fd_write WASI function which will write the given io vectors to stdout
</span></span></span><span class="line"><span class="cl"><span class="s">    ;; The function signature for fd_write is:
</span></span></span><span class="line"><span class="cl"><span class="s">    ;; (File Descriptor, *iovs, iovs_len, nwritten) -&gt; Returns number of bytes written
</span></span></span><span class="line"><span class="cl"><span class="s">    (import &#34;wasi_unstable&#34; &#34;fd_write&#34; (func $fd_write (param i32 i32 i32 i32) (result i32)))
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    (memory 1)
</span></span></span><span class="line"><span class="cl"><span class="s">    (export &#34;memory&#34; (memory 0))
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    ;; Write &#39;hello world\n&#39; to memory at an offset of 8 bytes
</span></span></span><span class="line"><span class="cl"><span class="s">    ;; Note the trailing newline which is required for the text to appear
</span></span></span><span class="line"><span class="cl"><span class="s">    (data (i32.const 8) &#34;hello world\n&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    (func $main (export &#34;_start&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s">        ;; Creating a new io vector within linear memory
</span></span></span><span class="line"><span class="cl"><span class="s">        (i32.store (i32.const 0) (i32.const 8))  ;; iov.iov_base - This is a pointer to the start of the &#39;hello world\n&#39; string
</span></span></span><span class="line"><span class="cl"><span class="s">        (i32.store (i32.const 4) (i32.const 12))  ;; iov.iov_len - The length of the &#39;hello world\n&#39; string
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">        (call $fd_write
</span></span></span><span class="line"><span class="cl"><span class="s">            (i32.const 1) ;; file_descriptor - 1 for stdout
</span></span></span><span class="line"><span class="cl"><span class="s">            (i32.const 0) ;; *iovs - The pointer to the iov array, which is stored at memory location 0
</span></span></span><span class="line"><span class="cl"><span class="s">            (i32.const 1) ;; iovs_len - We&#39;re printing 1 string stored in an iov - so one.
</span></span></span><span class="line"><span class="cl"><span class="s">            (i32.const 20) ;; nwritten - A place in memory to store the number of bytes written
</span></span></span><span class="line"><span class="cl"><span class="s">        )
</span></span></span><span class="line"><span class="cl"><span class="s">        drop ;; Discard the number of bytes written from the top of the stack
</span></span></span><span class="line"><span class="cl"><span class="s">    )
</span></span></span><span class="line"><span class="cl"><span class="s">)`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nf">TempDir</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;out&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">stdoutPath</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;stdout&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">engine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewEngine</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">store</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewStore</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">linker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewLinker</span><span class="p">(</span><span class="nx">store</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Configure WASI imports to write stdout into a file.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasiConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiConfig</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasiConfig</span><span class="p">.</span><span class="nf">SetStdoutFile</span><span class="p">(</span><span class="nx">stdoutPath</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Set the version to the same as in the WAT.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasi</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiInstance</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="w"> </span><span class="nx">wasiConfig</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;wasi_snapshot_preview1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Link WASI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">linker</span><span class="p">.</span><span class="nf">DefineWasi</span><span class="p">(</span><span class="nx">wasi</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create our module</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">wasm</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">Wat2Wasm</span><span class="p">(</span><span class="nx">TextWat</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">module</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewModule</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span><span class="w"> </span><span class="nx">wasm</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">linker</span><span class="p">.</span><span class="nf">Instantiate</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Run the function</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">nom</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="p">.</span><span class="nf">GetExport</span><span class="p">(</span><span class="s">&#34;_start&#34;</span><span class="p">).</span><span class="nf">Func</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">nom</span><span class="p">.</span><span class="nf">Call</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Print WASM stdout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">out</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">stdoutPath</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">check</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">out</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>結果は同じで <code>wasi_unstable::fd_write</code> なんぞ知らんと言ってくさる。
えっ？ みんなこのサンプルコード動かせるの？ どうやんだ？ 多分ランタイム側で何か足らないんだろうけど，よく分からん。
<code>wasmtime-c-api</code> を組み込めばいいのかなと思ったが，違うよなぁ？</p>
<p>というところで挫折した <code>orz</code> どなたか教えてください <abbr class="emoji-chars" title="ペコン">&#x1f647;</abbr></p>
<h3>【2021-03-22 追記】</h3>
<p>Twitter で<a href="https://twitter.com/sago35tk/status/1373929809827536898">教えていただきました</a>。
感謝！</p>
<p>どうも <a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> と <a href="https://github.com/bytecodealliance/wasmtime-go" title="bytecodealliance/wasmtime-go: Go WebAssembly runtime powered by Wasmtime">wasmtime-go</a> との間で <a href="https://github.com/WebAssembly/WASI/blob/main/design/application-abi.md">WASI Application ABI (Application Binary Interface)</a> が マッチしていない模様。
たしかに <code>$TINYGOROOT/src/runtime/runtime_wasm.go</code> に</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cp">//go:wasm-module wasi_unstable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">//export fd_write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">fd_write</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="kt">uint32</span><span class="p">,</span><span class="w"> </span><span class="nx">iovs</span><span class="w"> </span><span class="o">*</span><span class="nx">__wasi_iovec_t</span><span class="p">,</span><span class="w"> </span><span class="nx">iovs_len</span><span class="w"> </span><span class="kt">uint</span><span class="p">,</span><span class="w"> </span><span class="nx">nwritten</span><span class="w"> </span><span class="o">*</span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">errno</span><span class="w"> </span><span class="kt">uint</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>って記述があるわ。
ふむむー。
<code>//go:wasm-module</code> ディレクティブをキーに調べてみればいいのかな。
参考になった。</p>
<p>ちなみに，アドバイスを参考に</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">wasi</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiInstance</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="w"> </span><span class="nx">wasiConfig</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;wasi_snapshot_preview1&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>の部分を</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">wasi</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">wasmtime</span><span class="p">.</span><span class="nf">NewWasiInstance</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="w"> </span><span class="nx">wasiConfig</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;wasi_unstable&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>に差し替えたら動き出した。
なるほどねー。</p>
<p><a href="https://tinygo.org/" title="TinyGo - Go on Microcontrollers and WASM">TinyGo</a> 側の <a href="https://github.com/tinygo-org/tinygo/pull/1691" title="Upgrade WASI version to wasi_snapshot_preview1 by fgsch · Pull Request #1691 · tinygo-org/tinygo">PR</a> は受理されてマージされているようなので，次のバージョンでは <code>wasi_snapshot_preview1</code> で行けるだろう。</p>
<h2>【おまけ】 Node.js で WASI を動かす</h2>
<p>Node.js は v13 から WASI に対応しているらしい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ npm i wasi
</span></span></code></pre></div><p>でパッケージを組み込めば使えるようだ。
で，こんな感じのコードを書いて</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">WASI</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;wasi&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasi</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WASI</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">args</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">env</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">preopens</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">importObject</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">wasi_unstable</span><span class="o">:</span> <span class="nx">wasi</span><span class="p">.</span><span class="nx">wasiImport</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// const importObject = { wasi_snapshot_preview1: wasi.wasiImport };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wasm</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;./hello.wasm&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">wasm</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wasi</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></div><p>動かしてみると</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ node --experimental-wasi-unstable-preview1 --experimental-wasm-bigint wasi.js
</span></span><span class="line"><span class="cl">(node:210549) ExperimentalWarning: WASI is an experimental feature. This feature could change at any time
</span></span><span class="line"><span class="cl">(Use `node --trace-warnings ...` to show where the warning was created)
</span></span><span class="line"><span class="cl">Hello, World!
</span></span></code></pre></div><p>おー，動いた動いた。
これで <a href="https://go.dev/">Go</a> のコードを WSAI 経由で JavaScript コードに埋め込めるわけだ。</p>
<h2>ブックマーク</h2>
<ul>
<li><a href="https://dev.to/sendilkumarn/wasi-webassembly-system-interface-with-wasmtime-4cec">WASI - WebAssembly System Interface with Wasmtime - DEV Community</a></li>
<li><a href="https://medium.com/nttlabs/wasi-6060b243ac90">コンテナ技術を捨て、 WASIを試す. こんにちは、NTTの藤田です。 | by FUJITA Tomonori | nttlabs | Medium</a></li>
<li><a href="https://qiita.com/sago35/items/33e63ca5073f572ad69c">TinyGo の開発版のビルド方法と、ビルドせずに開発版バイナリを手に入れる方法 - Qiita</a></li>
</ul>
<h2>参考図書</h2>
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/B08T7D2LFR?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/51hVE3r&#43;6XL._SL160_.jpg" width="113" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/B08T7D2LFR?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">ソフトウェアデザイン 2021年3月号</a></dt>
    <dd>谷本 心 (著), 水島 宏太 (著), 増田 亨 (著), 山本 悠滋 (著), 折原 レオナルド賢 (著), 米田 武 (著), 清水 洋治 (著), 結城 浩 (著), 刀根 諒 (著), 大串 肇 (著), 松本 直人 (著), クラスメソッド 木村(作) (著), エクスデザイン ninnzinn(画) (著), くつなりょうすけ (著), 広木 大地 (著), 中島 明日香 (著), 金谷 拓哉 (著), 高橋 永成 (著), 平岡 正寿 (著), 梶原 直人(監修) (著), 平櫛 貴章 (著), 星川 真麻 (著), けんちょん(大槻 兼資) (著), 大嶋 健容 (著), 職業「戸倉彩」 (著), mattn (著), 小野 輝也 (著), 濱田 康貴 (著), 森若 和雄 (著), 古川 菜摘 (著), 嘉山 陽一 (著), 平野 尚志 (著), 杉山 貴章 (著), Software Design編集部 (編集)</dd>
    <dd>技術評論社 2021-02-18 (Release 2021-02-18)</dd>
    <dd>雑誌</dd>
    <dd>B08T7D2LFR (ASIN), 4910058270316 (EAN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="3">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="far fa-star"></i>&nbsp;<i class="far fa-star"></i></abbr></dd>
  </dl>
  <p class="description">第2特集が「WebAssembly 入門」近年の動向を把握するには丁度いいだろう。</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2021-03-21">2021-03-21</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- ソフトウェアデザイン 2021年3月号 -->
<div class="hreview">
  <div class="photo"><a href="https://www.amazon.co.jp/dp/4621300253?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1"><img src="https://m.media-amazon.com/images/I/41meaSLNFfL._SL160_.jpg" width="122" alt="photo"></a></div>
  <dl>
    <dt class="item"><a class="fn url" href="https://www.amazon.co.jp/dp/4621300253?tag=baldandersinf-22&amp;linkCode=ogi&amp;th=1&amp;psc=1">プログラミング言語Go (ADDISON-WESLEY PROFESSIONAL COMPUTING SERIES)</a></dt>
    <dd>Alan A.A. Donovan (著), Brian W. Kernighan (著), 柴田 芳樹 (翻訳)</dd>
    <dd>丸善出版 2016-06-20</dd>
    <dd>単行本（ソフトカバー）</dd>
    <dd>4621300253 (ASIN), 9784621300251 (EAN), 4621300253 (ISBN)</dd>
    <dd>評価<abbr class="rating fa-sm" title="5">&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i>&nbsp;<i class="fas fa-star"></i></abbr></dd>
  </dl>
  <p class="description">著者のひとりは（あの「バイブル」とも呼ばれる）通称 “K&amp;R” の K のほうである。この本は Go 言語の教科書と言ってもいいだろう。と思ったら絶版状態らしい（2025-01 現在）。復刊を望む！</p>
  <p class="powered-by">reviewed by <a href='#maker' class='reviewer'>Spiegel</a> on <abbr class="dtreviewed" title="2016-07-13">2016-07-13</abbr> (powered by <a href="https://affiliate.amazon.co.jp/assoc_credentials/home">PA-APIv5</a>)</p>
</div> <!-- プログラミング言語Go -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>“Write Once, Run Anywhere” は初期の Java のキャッチフレーズだった。当時は UNIX 機のハードウェア非互換の問題が酷くて，なんとかバイナリ互換を確保する方法がないかみんな頭を悩ませていた。そこに登場したのが Sun Microsystems の Java だったわけ。でも実際にはプラットフォーム間の差異が微妙に残ってしまい，むしろ “Write Once, Debug Everywhere” などと揶揄されることもあった。それでも Virtual Machine 上で標準化されたバイトコードを駆動させるというアイデアは秀逸だったので Java 以外の処理系でも応用され，特に組み込み用途では重宝されている。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

</section>

</article>
</main>
<nav class="page-nav">
<div class="prev-page">&laquo; <a href="/golang/webassembly-with-tinygo/">TinyGo で WebAssembly</a></div>
<div class="next-page"><a href="/golang/token-bucket/">Go による Token Bucket 実装</a> &raquo;</div>
</nav>

<aside class="feedback" id='feedback'>
<h1>Feedback</h1>
<p>GitHub に<a href="https://github.com/spiegel-im-spiegel/github-pages-env/discussions">フィードバック用のディスカッションページ</a>を用意しました。
書き込みには GitHub のアカウントが必要ですが，お気軽にご利用ください。</p>
<p>他のフィードバック手段として Mastodon などの SNS や電子メールも利用できます。電子メールを利用する際の公開鍵は<a href="https://baldanders.info/profile/">プロフィール</a>から取得できます。</p>
</aside>
<footer>


<div class="userinfo">
	<div class="userinfo-avater">
		<a href="https://baldanders.info/profile/"><img src="https://text.baldanders.info/images/avatar.jpg" width="48" height="48" alt="avatar" id="logo"></a>
	</div>
	<div class="userinfo-info" id="maker">
		Text by <a href="https://baldanders.info/profile/" rel="cc:attributionURL" property="cc:attributionName">Spiegel</a>
		in <time property='dc:dateCopyrighted'>2021-03-21</time> (revised in 2024-05-11)
		<a rel='cc:license' href="https://creativecommons.org/licenses/by-sa/4.0/"><i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i></a>
		<ul class="social"><li><a rel="me" href="https://github.com/spiegel-im-spiegel"><span class="github-color"><abbr title="GitHub"><i class="fab fa-github"></i></abbr></span></a></li><li><a rel="me" href="https://www.flickr.com/photos/spiegel/"><span class="flickr-color"><abbr title="Flickr"><i class="fab fa-flickr"></i></abbr></span></a></li><li><a rel="me" href="https://goark.fedicity.net/@spiegel"><span class="mastodon-color"><abbr title="Mastodon"><i class="fa-brands fa-mastodon"></i></abbr></span></a></li><li><a rel="me" href="https://bsky.app/profile/baldanders.info"><span class="bluesky-color"><abbr title="Bluesky"><i class="fa-brands fa-bluesky"></i></abbr></span></a></li><li><a rel="me" href="https://www.strava.com/athletes/122077389"><span class="strava-color"><abbr title="Strava"><i class="fa-brands fa-strava"></i></abbr></span></a></li><li><a rel="me" href="https://x.com/spiegel_2007"><span class="x-twitter-color"><abbr title="X (Twitter)"><i class="fab fa-x-twitter"></i></abbr></span></a></li></ul>
	</div>
</div>

<nav>
<ul class='cloud center'>
<li><a href='/about-feeds/'>Feeds</a></li>
<li><a href='/reviews/'>Reviews</a></li>
<li><a href='/site-policy/'>Policy</a></li>
<li><a href='https://github.com/spiegel-im-spiegel/spiegel-im-spiegel.github.io'>Repository</a></li>
<li><a href='https://validator.w3.org/nu/?doc=https%3a%2f%2ftext.baldanders.info%2fgolang%2fwasi-with-tinygo%2f&amp;showoutline=yes'>Debug</a></li>
</ul>
<ul class='cloud center'>
<li><a href='https://baldanders.info/'>Home</a></li>
<li><a href='https://photo.baldanders.info/'>Photos</a></li>
<li><a href='https://slide.baldanders.info/'>Slide</a></li>
<li><a href='https://zenn.dev/spiegel'>Zenn</a></li>
</ul>
<ul class='cloud center'>
<li>Powered by <a href='https://gohugo.io/'>Hugo 0.152.0</a> and <a href="https://github.com/spiegel-im-spiegel/hugo-theme-baldanders-info
">Theme of Baldanders.info</a>.</li>
</ul>
</nav>
</footer>
</div>

</body>
</html>
